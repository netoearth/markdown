GIF

![](https://i0.hdslb.com/bfs/article/4a10568f28aa362fc3ddc7f871b07daf847767da.gif@1s.webp)

å¸…å“¥ï¼ˆé“ä»”ï¼‰ã€ç¾å¥³ï¼Œç‚¹ä¸ªå…³æ³¨åç»­ä¸è¿·è·¯ï¼

**æœ¬ç« ç›®å½•**

![](https://i0.hdslb.com/bfs/article/4aa545dccf7de8d4a93c2b2b8e3265ac0a26d216.png@progressive.webp)

0x00 é•œåƒå¦‚ä½•ç‚¼æˆ

-   1.OCI æ ‡å‡†åè®®
    

-   image-spec - é•œåƒè§„èŒƒ
    
-   runtime-spec è¿è¡Œæ—¶è§„èŒƒ
    
-   distribution-spec é•œåƒä»“åº“è§„èŒƒ
    

-   2.Dockerfile
    
-   3.åŸºç¡€é•œåƒ
    

0x01 é•œåƒå­˜å‚¨åŸç†

-   æœ¬åœ°å­˜å‚¨ - Local
    
-   é•œåƒä»“åº“ - Registry
    

-   0x02 é•œåƒæ¬è¿
    

-   pull - é•œåƒæ‹‰å–
    
-   push - æ¨é€é•œåƒ
    
-   python Docker-dray
    
-   skopeo - é•œåƒæ¬è¿ç¥å™¨
    

-   0x03 é•œåƒä½¿ç”¨
    

![](https://i0.hdslb.com/bfs/article/4aa545dccf7de8d4a93c2b2b8e3265ac0a26d216.png@progressive.webp)

åœ¨æ·±å…¥å­¦ä¹ é•œåƒä¹‹å‰æˆ‘ä»¬éœ€è¦çŸ¥é“é•œåƒæ˜¯å¦‚ä½•`(ç‚¼åˆ¶/æ“)`æˆçš„(ç­‰åŒäºæ„å»ºé•œåƒ)ï¼Œå½“ç„¶æ˜¯é€šè¿‡æˆ‘ä»¬DockerFileä¸€æ¡æ¡æŒ‡ä»¤ä¸ºé•œåƒç”Ÿæˆæ¯ä¸€å±‚ï¼ŒæŒ‰ç…§æ‰§è¡Œé¡ºåºé•œåƒæ–‡ä»¶ç³»ç»Ÿå¤å†™å°è£…ä»ä¸‹åˆ°ä¸Š;

å…³äºå®¹å™¨é•œåƒçš„OCIæ ‡å‡†åè®®ï¼Œé‚£ä»€ä¹ˆåˆæ˜¯OCIæ ‡å‡†åè®®?

> ç­”: Open Container Initiative(æ‰“å¼€é›†è£…ç®±å€¡è®®)æ—¨åœ¨å›´ç»•å®¹å™¨æ ¼å¼å’Œè¿è¡Œæ—¶åˆ¶å®šä¸€ä¸ªå¼€æ”¾çš„å·¥ä¸šåŒ–æ ‡å‡†;
> 
> å‚è€ƒåœ°å€ï¼šå®¹å™¨å¼€æ”¾æ¥å£è§„èŒƒ(CRI OCI)

Docker å…¬å¸ä¸ CoreOS å’Œ Google å…±åŒåˆ›å»ºäº† OCI (Open Container Initial)ï¼Œå¹¶æä¾›äº†ä¸‰ç§è§„èŒƒ

-   é•œåƒè§„èŒƒ image-spec : åˆ¶å®šé•œåƒæ ¼å¼ã€æ“ä½œç­‰ (https://github.com/opencontainers/image-spec)
    
-   è¿è¡Œæ—¶è§„èŒƒ runtime-spec : æè¿°å¦‚ä½•è¿è¡Œfilesystem bundle (https://github.com/opencontainers/runtime-spec)
    
-   é•œåƒä»“åº“è§„èŒƒ distribution-spec (`ä¸å¸¸è§`)
    

å…³äº OCI è§„èŒƒçš„ä½œç”¨è¯´æ˜:

-   1.åˆ¶å®šå®¹å™¨æ ¼å¼æ ‡å‡†çš„å®—æ—¨å°±æé«˜é•œåƒé€šç”¨æ€§ä»¥ä¾¿`ä¸é™äºæŸç§ç‰¹å®šæ“ä½œç³»ç»Ÿã€ç¡¬ä»¶ã€CPUæ¶æ„ã€å…¬æœ‰äº‘`ç­‰; æ¦‚æ‹¬æ¥è¯´å°±æ˜¯`ä¸å—ä¸Šå±‚ç»“æ„çš„ç»‘å®šï¼Œå¦‚ç‰¹å®šçš„å®¢æˆ·ç«¯ã€ç¼–æ’æ ˆ`ç­‰
    
-   2.ä¸¤ä¸ªåè®®é€šè¿‡Â `OCI runtime filesytem bundle`çš„æ ‡å‡†æ ¼å¼è¿æ¥åœ¨ä¸€èµ·ï¼ŒOCI é•œåƒå¯ä»¥é€šè¿‡å·¥å…·è½¬æ¢æˆbundleç„¶åOCIå®¹å™¨å¼•æ“èƒ½å¤Ÿè¯†åˆ«è¿™ä¸ª bundle æ¥è¿è¡Œå®¹å™¨, å…¶ä¼˜ç‚¹å¦‚ä¸‹;
    

-   æ“ä½œæ ‡å‡†åŒ–ï¼šå®¹å™¨çš„æ ‡å‡†åŒ–æ“ä½œåŒ…æ‹¬ä½¿ç”¨æ ‡å‡†å®¹å™¨åˆ›å»ºã€å¯åŠ¨ã€åœæ­¢å®¹å™¨ï¼Œä½¿ç”¨æ ‡å‡†æ–‡ä»¶ç³»ç»Ÿå·¥å…·å¤åˆ¶å’Œåˆ›å»ºå®¹å™¨å¿«ç…§ï¼Œä½¿ç”¨æ ‡å‡†åŒ–ç½‘ç»œå·¥å…·è¿›è¡Œä¸‹è½½å’Œä¸Šä¼ ã€‚
    
-   å†…å®¹æ— å…³ï¼šå†…å®¹æ— å…³æŒ‡ä¸ç®¡é’ˆå¯¹çš„å…·ä½“å®¹å™¨å†…å®¹æ˜¯ä»€ä¹ˆï¼Œå®¹å™¨æ ‡å‡†æ“ä½œæ‰§è¡Œåéƒ½èƒ½äº§ç”ŸåŒæ ·çš„æ•ˆæœã€‚å¦‚å®¹å™¨å¯ä»¥ç”¨åŒæ ·çš„æ–¹å¼ä¸Šä¼ ã€å¯åŠ¨ï¼Œä¸ç®¡æ˜¯PHPåº”ç”¨è¿˜æ˜¯MySQLæ•°æ®åº“æœåŠ¡ã€‚
    
-   åŸºç¡€è®¾æ–½æ— å…³ï¼šæ— è®ºæ˜¯ä¸ªäººçš„ç¬”è®°æœ¬ç”µè„‘è¿˜æ˜¯AWS S3ï¼Œäº¦æˆ–æ˜¯OpenStackï¼Œæˆ–è€…å…¶å®ƒåŸºç¡€è®¾æ–½ï¼Œéƒ½åº”è¯¥å¯¹æ”¯æŒå®¹å™¨çš„å„é¡¹æ“ä½œã€‚
    
-   ä¸ºè‡ªåŠ¨åŒ–é‡èº«å®šåˆ¶ï¼šåˆ¶å®šå®¹å™¨ç»Ÿä¸€æ ‡å‡†ï¼Œæ˜¯çš„æ“ä½œå†…å®¹æ— å…³åŒ–ã€å¹³å°æ— å…³åŒ–çš„æ ¹æœ¬ç›®çš„ä¹‹ä¸€ï¼Œå°±æ˜¯ä¸ºäº†å¯ä»¥ä½¿å®¹å™¨æ“ä½œå…¨å¹³å°è‡ªåŠ¨åŒ–ã€‚
    
-   å·¥ä¸šçº§äº¤ä»˜ï¼šåˆ¶å®šå®¹å™¨æ ‡å‡†ä¸€å¤§ç›®æ ‡ï¼Œå°±æ˜¯ä½¿è½¯ä»¶åˆ†å‘å¯ä»¥è¾¾åˆ°å·¥ä¸šçº§äº¤ä»˜æˆä¸ºç°å®
    

å‚è€ƒæ¥æº:

-   1.OCI é•œåƒè§„èŒƒçš„ä¸»è¦ç”±ä»¥ä¸‹å‡ ä¸ª markdown æ–‡ä»¶ç»„æˆï¼š
    

```
â”œâ”€â”€ annotations.md Â  Â  Â  Â  # æ³¨è§£è§„èŒƒ
â”œâ”€â”€ config.md Â  Â  Â  Â  Â  Â  Â # image config æ–‡ä»¶è§„èŒƒ
â”œâ”€â”€ considerations.md Â  Â  Â # æ³¨æ„äº‹é¡¹
â”œâ”€â”€ conversion.md Â  Â  Â  Â  Â # è½¬æ¢ä¸º OCI è¿è¡Œæ—¶
â”œâ”€â”€ descriptor.md Â  Â  Â  Â  Â # OCI Content Descriptors å†…å®¹æè¿°
â”œâ”€â”€ image-index.md Â  Â  Â  Â  # manifest list æ–‡ä»¶
â”œâ”€â”€ image-layout.md Â  Â  Â  Â # é•œåƒçš„å¸ƒå±€
â”œâ”€â”€ implementations.md Â  Â  # ä½¿ç”¨ OCI è§„èŒƒçš„é¡¹ç›®
â”œâ”€â”€ layer.md Â  Â  Â  Â  Â  Â  Â  # é•œåƒå±‚ layer è§„èŒƒ
â”œâ”€â”€ manifest.md Â  Â  Â  Â  Â  Â # manifest è§„èŒƒ
â”œâ”€â”€ media-types.md Â  Â  Â  Â  # æ–‡ä»¶ç±»å‹
â”œâ”€â”€ README.md Â  Â  Â  Â  Â  Â  Â # README æ–‡æ¡£
â”œâ”€â”€ spec.md Â  Â  Â  Â  Â  Â  Â  Â # OCI é•œåƒè§„èŒƒçš„æ¦‚è§ˆ
```

> -   Image ManifestÂ - a document describing the components that make up a container image | æè¿°äº†æ„æˆå®¹å™¨çš„å›¾åƒçš„éƒ¨ä»¶çš„æ–‡æ¡£
>     
> -   Image IndexÂ - an annotated index of image manifests | å›¾åƒæ¸…å•çš„å¸¦æ³¨é‡Šç´¢å¼•
>     
> -   Image LayoutÂ - a filesystem layout representing the contents of an image | è¡¨ç¤ºå›¾åƒçš„å†…å®¹çš„æ–‡ä»¶ç³»ç»Ÿå¸ƒå±€
>     
> -   Filesystem LayerÂ - a changeset that describes a containerâ€™s filesystem | æè¿°ä¸€ä¸ªå®¹å™¨çš„æ–‡ä»¶ç³»ç»Ÿä¸­çš„å˜æ›´
>     
> -   Image ConfigurationÂ - a document determining layer ordering and configuration of the image suitable for translation into aÂ runtime bundleÂ | æ–‡æ¡£ç¡®å®šå±‚çš„æ’åºå’Œé€‚åˆç¿»è¯‘çš„å›¾åƒçš„é…ç½®åˆ°è¿è¡Œæ—¶çš„æŸ
>     
> -   ConversionÂ - a document describing how this translation should occur | æè¿°åº”è¯¥æ˜¯å¦‚ä½•å‘ç”Ÿè¿™ç§è½¬æ¢çš„æ–‡æ¡£
>     
> -   DescriptorÂ - a reference that describes the type, metadata and content address of referenced content | æè¿°çš„ç±»å‹ï¼Œå…ƒæ•°æ®å’Œå¼•ç”¨çš„å†…å®¹çš„å†…å®¹åœ°å€çš„å¼•ç”¨
>     

-   2.OCI è§„èŒƒæ˜¯å…è´¹çš„å“¦ï¼Œä¸åƒå¤§å¤šæ•° ISO è§„èŒƒè¿˜è¦äº¤é’±æ‰èƒ½çœ‹ï¼ˆï¸¶^ï¸¶ï¼‰å“¼ã€‚
    

æè¿°:å®ƒå†³å®šäº†æˆ‘ä»¬é•œåƒ`æŒ‰ç…§ä»€ä¹ˆæ ‡å‡†æ¥æ„å»º`ï¼Œä»¥åŠ`æ„å»ºå®Œé•œåƒä¹‹åå¦‚ä½•å­˜æ”¾`ï¼Œæ¥ç€ä¸‹æ–‡æåˆ°çš„ Dockerfile åˆ™å†³å®šäº†é•œåƒçš„ layer å†…å®¹ä»¥åŠé•œåƒçš„ä¸€äº›å…ƒæ•°æ®ä¿¡æ¯ã€‚

ç›´ç™½çš„è¯´ä¸€ä¸ªé•œåƒè§„èŒƒ image-spec å’Œä¸€ä¸ª Dockerfile å°±æŒ‡å¯¼ç€æˆ‘ä»¬æ„å»ºä¸€ä¸ªé•œåƒ;

æ€»ç»“ä»¥ä¸Šå‡ ä¸ª markdown æ–‡ä»¶ OCI å®¹å™¨é•œåƒè§„èŒƒä¸»è¦åŒ…æ‹¬ä»¥ä¸‹å‡ å—å†…å®¹:

-   Layer : Docker ä»¥ layer (é•œåƒå±‚) ä¿å­˜çš„æ–‡ä»¶ç³»ç»Ÿä»¥åŠæ¯ä¸ªLayerä¿å­˜ä¸ä¸Šå±‚ä¹‹é—´å˜åŒ–éƒ¨åˆ†ï¼Œä»¥åŠå¯¹ä¿å­˜å“ªäº›æ–‡ä»¶ï¼Œæ€ä¹ˆè¡¨ç¤ºå¢åŠ ã€ä¿®æ”¹å’Œåˆ é™¤çš„æ–‡ä»¶ç­‰è¿›è¡Œæè¿°;
    
-   Image-Config : ä¿å­˜äº†æ–‡ä»¶ç³»ç»Ÿçš„å±‚çº§ä¿¡æ¯ï¼ˆ`æ¯ä¸ªå±‚çº§çš„ hash å€¼ï¼Œä»¥åŠå†å²ä¿¡æ¯`ï¼‰ä»¥åŠå®¹å™¨è¿è¡Œæ—¶éœ€è¦çš„ä¸€äº›ä¿¡æ¯ï¼ˆæ¯”å¦‚ç¯å¢ƒå˜é‡ã€å·¥ä½œç›®å½•ã€å‘½ä»¤å‚æ•°ã€mount åˆ—è¡¨ï¼‰ï¼ŒæŒ‡å®šäº†é•œåƒåœ¨æŸä¸ªç‰¹å®šå¹³å°å’Œç³»ç»Ÿçš„é…ç½®:
    

```
# æ¯”è¾ƒæ¥è¿‘æˆ‘ä»¬ä½¿ç”¨ docker inspect <image|id> çœ‹åˆ°çš„å†…å®¹
{
  "architecture": "amd64",
  "config": {
    "Hostname": "",
    "Domainname": "",
    "User": "",
    "AttachStdin": false,
    "AttachStdout": false,
    "AttachStderr": false,
    "Tty": false,
    "OpenStdin": false,
    "StdinOnce": false,
    "Env": ["PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"],
    "Cmd": ["bash"],
    "Image": "sha256:ba8f577813c7bdf6b737f638dffbc688aa1df2ff28a826a6c46bae722977b549",
    "Volumes": null,
    "WorkingDir": "",
    "Entrypoint": null,
    "OnBuild": null,
    "Labels": null
  },
  "container": "38501d5aa48c080884f4dc6fd4b1b6590ff1607d9e7a12e1cef1d86a3fdc32df",
  "container_config": {
    "Hostname": "38501d5aa48c",
    "Domainname": "",
    "User": "",
    "AttachStdin": false,
    "AttachStdout": false,
    "AttachStderr": false,
    "Tty": false,
    "OpenStdin": false,
    "StdinOnce": false,
    "Env": ["PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"],
    "Cmd": [
      "/bin/sh",
      "-c",
      "#(nop) ",
      "CMD [\"bash\"]"
    ],
    "Image": "sha256:ba8f577813c7bdf6b737f638dffbc688aa1df2ff28a826a6c46bae722977b549",
    "Volumes": null,
    "WorkingDir": "",
    "Entrypoint": null,
    "OnBuild": null,
    "Labels": {}
  },
  "created": "2020-06-07T01:59:47.348924716Z",
  "docker_version": "19.03.5",
  "history": [{
      "created": "2020-06-07T01:59:46.877600299Z",
      "created_by": "/bin/sh -c #(nop) ADD file:a82014afc29e7b364ac95223b22ebafad46cc9318951a85027a49f9ce1a99461 in / "
      },{
      "created": "2020-06-07T01:59:47.348924716Z",
      "created_by": "/bin/sh -c #(nop)  CMD [\"bash\"]",
      "empty_layer": true
    }],
  "os": "linux",
  "rootfs": {
    "type": "layers",
    "diff_ids": ["sha256:d1b85e6186f67d9925c622a7a6e66faa447e767f90f65ae47cdc817c629fa956"]
  }
}
```

-   manifest : é•œåƒçš„configæ–‡ä»¶ç´¢å¼•åŒ…æ‹¬äº†`Layer/Annotation`å…¶æ–‡ä»¶ä¸­ä¿å­˜äº†å¾ˆå¤šå’Œ`å½“å‰å¹³å°æœ‰å…³ä¿¡æ¯å­˜æ”¾äºåœ¨ registry ä¸­`ã€‚  
    æ‚¨å¯ä»¥åœ¨é•œåƒä»“åº“ä¸­é€šè¿‡Registry APIè¯·æ±‚è·å–é•œåƒManifestä¸­çš„ä¿¡æ¯, å½“æˆ‘ä»¬æ‹‰å–é•œåƒçš„æ—¶å€™ä¼šæ ¹æ®è¯¥æ–‡ä»¶æ‹‰å–ç›¸åº”çš„ layer,æ¯”å¦‚åé¢å®ç°çš„ä¸è§£å‹é•œåƒæ‹·è´;
    
    ç¬¬ä¸€ä¸ªç›®æ ‡æ˜¯å†…å®¹å¯å¯»å€çš„å›¾åƒï¼Œé€šè¿‡æ”¯æŒçš„å›¾åƒæ¨¡å‹ï¼Œå…¶ä¸­æ‰€è¿°å›¾åƒçš„é…ç½®å¯è¢«æ•£åˆ—ä»¥ç”Ÿæˆå›¾åƒå’Œå®ƒçš„ç»„ä»¶çš„å”¯ä¸€IDã€‚ ç¬¬äºŒä¸ªç›®æ ‡æ˜¯è®©å¤šæ¶æ„çš„å›¾åƒï¼Œé€šè¿‡â€œmainfestâ€ï¼Œè¿™å¯¹äºå›¾åƒçš„ç‰¹å®šäºå¹³å°çš„ç‰ˆæœ¬å‚è€ƒå›¾åƒæ¸…å•ã€‚åœ¨OCIï¼Œè¿™æ˜¯åœ¨å›¾åƒç´¢å¼•ç¼–å…¥ã€‚ ç¬¬ä¸‰ä¸ªç›®æ ‡æ˜¯è¦ç¿»è¯‘åˆ°OCIè¿è¡Œè§„èŒƒã€‚
    

-   ç‰ˆæœ¬: ç›®å‰ä¸»æµçš„ç‰ˆæœ¬æ˜¯ Manifest Version 2, Schema 2Â å®˜æ–¹å‚è€ƒè¯´æ˜
    
-   æ³¨æ„: manifest ä¸­çš„ layer å’Œ config ä¸­çš„ layer è¡¨è¾¾çš„è™½ç„¶éƒ½æ˜¯é•œåƒçš„ layer ï¼Œä½†äºŒè€…ä»£è¡¨çš„æ„ä¹‰ä¸å¤ªä¸€æ ·;
    
-   æ³¨æ„:Â `registry ä¸­ä¼šæœ‰ä¸ª Manifest List æ–‡ä»¶`ï¼Œè¯¥æ–‡ä»¶æ˜¯ä¸ºä¸åŒå¤„ç†å™¨ä½“ç³»æ¶æ„è€Œè®¾è®¡çš„ï¼Œé€šè¿‡è¯¥æ–‡ä»¶æŒ‡å‘ä¸è¯¥å¤„ç†å™¨ä½“ç³»æ¶æ„ç›¸å¯¹åº”çš„ Image Manifest;
    
-   æ€»ç»“: å®¹å™¨é•œåƒçš„ Configï¼Œå’Œ Layers ä¸­çš„æ¯ä¸€å±‚ï¼Œéƒ½æ˜¯ä»¥ Blob çš„æ–¹å¼å­˜å‚¨åœ¨é•œåƒä»“åº“ä¸­çš„ï¼Œå®ƒä»¬çš„ digest ä½œä¸º Key å­˜åœ¨ã€‚å› æ­¤åœ¨è¯·æ±‚åˆ°é•œåƒçš„ Manifest åï¼Œ`Docker ä¼šåˆ©ç”¨ digest å¹¶è¡Œä¸‹è½½æ‰€æœ‰çš„ Blobs`ï¼Œå…¶ä¸­å°±åŒ…æ‹¬ Config å’Œæ‰€æœ‰çš„ Layersã€‚
    
-   é•œåƒçš„ manifest æ–‡ä»¶(å›¾åƒæ¸…å•è§„èŒƒ)ä¸»è¦æœ‰ä»¥ä¸‹ä¸‰ä¸ªç›®æ ‡:
    

```
//Manifest List
{
  "schemaVersion": 2,
  "mediaType": "application/vnd.docker.distribution.manifest.list.v2+json",
  "manifests": [
    {
      "mediaType": "application/vnd.docker.distribution.manifest.v2+json",
      "size": 7143,
      "digest": "sha256:e692418e4cbaf90ca69d05a66403747baa33ee08806650b51fab815ad7fc331f",
      "platform": {
        "architecture": "ppc64le",
        "os": "linux",
      }
    },
    {
      "mediaType": "application/vnd.docker.distribution.manifest.v2+json",
      "size": 7682,
      "digest": "sha256:5b0bcabd1ed22e9fb1310cf6c2dec7cdef19f0ad69efa1f392e94a4333501270",
      "platform": {
        "architecture": "amd64",
        "os": "linux",
        "features": [
          "sse4"
        ]
      }
    }
  ]
}

// Image Manifest :  å¯é€šè¿‡ Registry  API è¯·æ±‚æŸ¥çœ‹åˆ°;
{
// Manifest Version 2, Schema 2
  "schemaVersion": 2,
  "mediaType": "application/vnd.docker.distribution.manifest.v2+json",
// å…¶å®šä¹‰åŒ…æ‹¬ä¸¤ä¸ªéƒ¨åˆ†ï¼Œåˆ†åˆ«æ˜¯ Config å’Œ Layers ä¸”éƒ½åŒ…å«ä¸‰ä¸ªå­—æ®µåˆ†åˆ«æ˜¯ digestã€mediaType å’Œ size
// Config æ˜¯ä¸€ä¸ª JSON å¯¹è±¡
  "config": {
    // å†…å®¹ç±»å‹
    // é•œåƒçš„å…ƒæ•°æ®: å…³äºå®¹å™¨é•œåƒçš„é…ç½®ï¼Œé€šå¸¸å®ƒä¼šè¢«é•œåƒä»“åº“ç”¨æ¥åœ¨ UI ä¸­å±•ç¤ºä¿¡æ¯ï¼Œä»¥åŠåŒºåˆ†ä¸åŒæ“ä½œç³»ç»Ÿçš„æ„å»ºç­‰ã€‚
    "mediaType": "application/vnd.docker.container.image.v1+json",
    // å†…å®¹çš„å¤§å°
    "size": 1509,
    // å¯¹è±¡çš„ ID
    "digest": "sha256:a24bb4013296f61e89ba57005a7b3e52274d8edd3ae2077d04395f806b63d83e"
  },
// Layers æ˜¯ä¸€ä¸ªç”± JSON å¯¹è±¡ç»„æˆçš„æ•°ç»„
  "layers": [
    {
      // ä¼—æ‰€å‘¨çŸ¥ï¼Œå®¹å™¨é•œåƒæ˜¯åˆ†å±‚æ„å»ºçš„ï¼Œæ¯ä¸€å±‚å°±å¯¹åº”ç€ Layers ä¸­çš„ä¸€ä¸ªå¯¹è±¡ã€‚
      "mediaType": "application/vnd.docker.image.rootfs.diff.tar.gzip",  // å¸¸è§å½¢å¼
      "size": 5844992,
      "digest": "sha256:50644c29ef5a27c9a40c393a73ece2479de78325cae7d762ef3cdc19bf42dd0a"
    }
  ]
}
```

-   Image manifest index - OCIå›¾åƒç´¢å¼•è§„èŒƒ  
    æè¿°:åœ¨ docker çš„ distribution ä¸­ç§°ä¹‹ä¸º Manifest List åœ¨ OCI ä¸­å°±å«`OCI Image Index Specification`,å®é™…ä¸Šä¸¤è€…æ˜¯æŒ‡çš„åŒä¸€ä¸ªæ–‡ä»¶ï¼Œç”šè‡³ä¸¤è€… GitHub ä¸Šæ–‡æ¡£ç»™çš„ example éƒ½ä¸€ä¸€æ¨¡æ ·ğŸ¤£ï¼Œåº”è¯¥æ˜¯ OCI å¤åˆ¶ç²˜è´´ Docker çš„æ–‡æ¡£;  
    index æ–‡ä»¶æ˜¯ä¸ªå¯é€‰çš„æ–‡ä»¶ï¼ŒåŒ…å«ç€ä¸€ä¸ªåˆ—è¡¨ä¸ºåŒä¸€ä¸ªé•œåƒä¸åŒçš„å¤„ç†å™¨ arch æŒ‡å‘ä¸åŒå¹³å°çš„ manifest æ–‡ä»¶ï¼Œ`å®ƒä¿è¯ä¸€ä¸ªé•œåƒå¯ä»¥è·¨å¹³å°ä½¿ç”¨`ï¼Œå³æ¯ä¸ªå¤„ç†å™¨ arch å¹³å°æ‹¥æœ‰ä¸åŒçš„ manifest æ–‡ä»¶ï¼Œä½¿ç”¨ index ä½œä¸ºç´¢å¼•ã€‚  
    å½“æˆ‘ä»¬ä½¿ç”¨ arm æ¶æ„çš„å¤„ç†å™¨æ—¶è¦é¢å¤–æ³¨æ„ï¼Œåœ¨æ‹‰å–é•œåƒçš„æ—¶å€™è¦æ‹‰å– arm æ¶æ„çš„é•œåƒï¼Œä¸€èˆ¬å¤„ç†å™¨çš„æ¶æ„éƒ½æ¥åœ¨é•œåƒçš„ tag åé¢ï¼Œé»˜è®¤ latest tag çš„é•œåƒæ˜¯ x86 çš„ï¼Œåœ¨ arm å¤„ç†å™¨çš„æœºå™¨è¿™äº›é•œåƒä¸Šæ˜¯è·‘ä¸èµ·æ¥çš„ã€‚
    

åœ¨æ·±å…¥å­¦ä¹ DockeråŸç†è¿‡ç¨‹ä¸­å‘ç°Docker infoä¸­çš„Runtimeså­—æ®µï¼Œç”±äºä¸ªäººé˜…å†æœ‰é™ä¸å¾—ä¸Googleä¸€ä¸‹æ‰€ä»¥æœ‰äº†ä»¥ä¸‹å†…å®¹;

```
$docker info | grep -i "runtime"
# Dockerã€Googleç­‰å…¬å¸å¼€æºäº†ç”¨äºè¿è¡Œå®¹å™¨çš„å·¥å…·å’Œåº“ runcï¼Œåœ¨æ­¤ä¹‹åï¼Œå„ç§è¿è¡Œæ—¶å·¥å…·å’Œåº“ä¹Ÿæ…¢æ…¢å‡ºç°ï¼Œä¾‹å¦‚ rktã€containerdã€cri-o ç­‰ï¼Œç„¶è€Œè¿™äº›å·¥å…·æ‰€æ‹¥æœ‰çš„åŠŸèƒ½å´ä¸å°½ç›¸åŒï¼Œæœ‰çš„åªæœ‰è¿è¡Œå®¹å™¨(runcã€lxc)ï¼Œè€Œæœ‰çš„é™¤æ­¤ä¹‹å¤–ä¹Ÿå¯ä»¥å¯¹é•œåƒè¿›è¡Œç®¡ç†(containerdã€cri-o)ã€‚
Runtimes: runc 
Default Runtime: runc
```

Q: ä»€ä¹ˆæ˜¯runtimes?

> ç­”:ä»å­—é¢ç†è§£Runtimesæˆ‘ä»¬çŸ¥é“å…¶ä¸ºè¿è¡Œæ—¶å®é™…å®ƒæ˜¯Dockerå®¹å™¨åœ¨è¿è¡Œæ—¶çš„ä¸€ä¸ªå‘¨æœŸç­‰ï¼›  
> ç®€å•çš„è¯´å°±æ˜¯å®¹å™¨è¿è¡Œæ—¶ï¼Œä¼ ç»Ÿæ„ä¹‰ä¸Šæ¥è¯´å°±æ˜¯ä»£è¡¨å®¹å™¨ä»æ‹‰å–é•œåƒåˆ°å¯åŠ¨è¿è¡Œå†åˆ°ä¸­æ­¢çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸ

å®¹å™¨åœ¨è¿è¡Œæ—¶åˆ†ä¸ºä¸¤ç±»:

-   low-level runtime : å…³æ³¨å¦‚ä½•ä¸æ“ä½œç³»ç»Ÿäº¤äº’ï¼Œåˆ›å»ºå¹¶è¿è¡Œå®¹å™¨ï¼Œä½¿ç”¨ namespace å’Œ cgroup å®ç°èµ„æºéš”ç¦»å’Œé™åˆ¶,ç›®å‰å¸¸è§çš„ low-level runtimeæœ‰ï¼š  
    

-   lmctfy -- æ˜¯Googleçš„ä¸€ä¸ªé¡¹ç›®ï¼Œå®ƒæ˜¯Borgä½¿ç”¨çš„å®¹å™¨è¿è¡Œæ—¶
    
-   runc -- ç›®å‰ä½¿ç”¨æœ€å¹¿æ³›çš„å®¹å™¨è¿è¡Œæ—¶ã€‚
    
-   rkt -- CoreOSå¼€å‘çš„Docker/runcçš„ä¸€ä¸ªæµè¡Œæ›¿ä»£æ–¹æ¡ˆï¼Œæä¾›äº†å…¶ä»– low-level runtimes (å¦‚runc)æ‰€æä¾›çš„æ‰€æœ‰ç‰¹æ€§ã€‚
    

-   high-level runtime : æŒ‡åŒ…å«äº†æ›´å¤šä¸Šå±‚åŠŸèƒ½ï¼Œä¾‹å¦‚ grpcè°ƒç”¨ï¼Œé•œåƒå­˜å‚¨ç®¡ç†ç­‰ï¼Œç›®å‰ä¸»æµçš„ high-level runtime æœ‰ï¼š  
    

-   docker
    
-   containerd
    
-   rkt
    

å…¶ä¸¤è€…çš„åŒºåˆ«æ˜¯:

-   High-level runtimesç›¸è¾ƒäºlow-level runtimesä½äºå †æ ˆçš„ä¸Šå±‚
    
-   low-level runtimesè´Ÿè´£å®é™…è¿è¡Œå®¹å™¨ï¼Œè€ŒHigh-level runtimesè´Ÿè´£ä¼ è¾“å’Œç®¡ç†å®¹å™¨é•œåƒã€è§£å‹é•œåƒï¼Œå¹¶ä¼ é€’ç»™low-level runtimesæ¥è¿è¡Œå®¹å™¨ã€‚
    

Q: ä»ä¸Šé¢çš„è¡¨è¾¾ä¸­æˆ‘ä»¬çŸ¥é“runcæ˜¯ä¸€ä¸ªlow-level è¿è¡Œæ—¶ï¼Œé‚£å®ƒä¸Dockeræœ‰ä½•å…³ç³»?

> ç­”: runCæ˜¯ä¸€ä¸ªæ ¹æ®OCIæ ‡å‡†åˆ›å»ºå¹¶è¿è¡Œå®¹å™¨çš„å‘½ä»¤è¡Œå·¥å…·ï¼ˆCLI toolï¼‰, runCæ˜¯dockerä¸­æœ€ä¸ºæ ¸å¿ƒçš„éƒ¨åˆ†ï¼Œå®¹å™¨çš„åˆ›å»ºï¼Œè¿è¡Œï¼Œé”€æ¯ç­‰ç­‰æ“ä½œæœ€ç»ˆéƒ½å°†é€šè¿‡è°ƒç”¨runcå®Œæˆã€‚  
> è€ŒrunCä¹Ÿæœ‰è‡ªå·±çš„å®¢æˆ·ç«¯ï¼Œåæ¥è¢«æå–å‡ºæ¥ä½œä¸ºä¸€ä¸ªå•ç‹¬çš„å·¥å…·å’Œåº“ã€‚å…¶å®ç°äº† OCI è§„èŒƒï¼ŒåŒ…å«config.jsonæ–‡ä»¶å’Œå®¹å™¨çš„æ ¹æ–‡ä»¶ç³»ç»Ÿã€‚

æè¿°:è¯¥è§„èŒƒå®šä¹‰ç€å®¹å™¨é•œåƒå¦‚ä½•å­˜å‚¨åœ¨è¿œç«¯çš„Registryä¸Š,ä½¿ç”¨è§„èŒƒçš„å¥½å¤„æ˜¯å¯ä»¥å¸®åŠ©æˆ‘ä»¬æŠŠè¿™äº›é•œåƒæŒ‰ç…§çº¦å®šä¿—æˆçš„æ ¼å¼æ¥å­˜æ”¾å³æ–¹ä¾¿ç¬¬ä¸‰æ–¹å·¥å…·çš„å­˜å–;

ç›®å‰å®ç°è¯¥è§„èŒƒçš„ registry å°± docker å®¶çš„ registry ä½¿ç”¨çš„å¤šä¸€äº›ã€‚å…¶ä»–çš„ registry æ¯”å¦‚ harbor ã€Â quay.ioÂ ä½¿ç”¨çš„ä¹Ÿæ¯”è¾ƒå¤šã€‚

æè¿°:ç›¸ä¿¡è¯»è€…å¦‚æœå¯¹dockeræœ‰ä¸ªåŸºç¡€äº†è§£ä»¥åŠçœ‹äº†æˆ‘å‰é¢çš„æ–‡ç« ï¼Œæƒ³å¿…å¯¹å®ƒä¸æ„Ÿåˆ°é™Œç”Ÿå§ï¼›ä¼—æ‰€å‘¨çŸ¥ docker é•œåƒéœ€è¦ä¸€ä¸ª Dockerfile æ¥æ„å»ºè€Œæˆï¼›  
å½“æˆ‘ä»¬å¯¹ OCI é•œåƒè§„èŒƒæœ‰äº†ä¸ªå¤§è‡´è§£ä¹‹åï¼Œæ¥ä¸‹æ¥å°±æ‹¿ç€ Dockerfile è¿™ä¸ª "å›¾çº¸" å»ä¸€æ­¥æ­¥æ„å»ºé•œåƒã€‚

æ­¤å¤„ä¸å†è¯¦ç»†DockerFileçš„è¯¦ç»†ä¹¦å†™ä»¥åŠæœ€ä½³ä¼˜åŒ–æŠ€å·§ï¼Œæ„Ÿå…´è¶£çš„æœ‹å‹å¯ä»¥å‚çœ‹å‰é¢çš„æ–‡ç« ;

ä¸‹é¢æˆ‘ä»¬åŸºäº`docker build test-image`è¿›ä¸€æ­¥ç†è§£ç›®å½•ç»“æ„;

```
FROM alpine
LABEL name="test-image"
RUN apk -v add --no-cache bash 
RUN apk -v add --no-cache curl
COPY ./startService.sh /
  
CMD ["/bin/bash", "/startService.sh"]
```

æ„å»ºè¿‡ç¨‹è¾“å‡ºå¦‚ä¸‹:

```
$docker build -t test-image .
Sending build context to Docker daemon  3.072kB
Step 1/6 : FROM alpine
 ---> 3f53bb00af94
Step 2/6 : LABEL name="test-image"
 ---> Running in 3bd6320fc291
Removing intermediate container 3bd6320fc291
 ---> bb97dd1fb1a1
Step 3/6 : RUN apk -v add --no-cache bash
 ---> Running in f9987ff57ad7
fetch http://dl-cdn.alpinelinux.org/alpine/v3.8/main/x86_64/APKINDEX.tar.gz
fetch http://dl-cdn.alpinelinux.org/alpine/v3.8/community/x86_64/APKINDEX.tar.gz
(1/5) Installing ncurses-terminfo-base (6.1_p20180818-r1)
(2/5) Installing ncurses-terminfo (6.1_p20180818-r1)
(3/5) Installing ncurses-libs (6.1_p20180818-r1)
(4/5) Installing readline (7.0.003-r0)
(5/5) Installing bash (4.4.19-r1)
Executing bash-4.4.19-r1.post-install
Executing busybox-1.28.4-r2.trigger
OK: 18 packages, 136 dirs, 2877 files, 13 MiB
Removing intermediate container f9987ff57ad7
 ---> a5635f1b1d00
Step 4/6 : RUN apk -v add --no-cache curl
 ---> Running in c49fb2e4b311
fetch http://dl-cdn.alpinelinux.org/alpine/v3.8/main/x86_64/APKINDEX.tar.gz
fetch http://dl-cdn.alpinelinux.org/alpine/v3.8/community/x86_64/APKINDEX.tar.gz
(1/5) Installing ca-certificates (20171114-r3)
(2/5) Installing nghttp2-libs (1.32.0-r0)
(3/5) Installing libssh2 (1.8.0-r3)
(4/5) Installing libcurl (7.61.1-r1)
(5/5) Installing curl (7.61.1-r1)
Executing busybox-1.28.4-r2.trigger
Executing ca-certificates-20171114-r3.trigger
OK: 23 packages, 141 dirs, 3040 files, 15 MiB
Removing intermediate container c49fb2e4b311
 ---> 9156d1521a2f
Step 5/6 : COPY ./startService.sh /
 ---> 704626646baf
Step 6/6 : CMD ["/bin/bash", "/startService.sh"]
 ---> Running in 1c5e6e861264
Removing intermediate container 1c5e6e861264
 ---> 6cd0a66e83f1
Successfully built 6cd0a66e83f1
Successfully tagged test-image:latest
```

æ„å»ºè¿‡ç¨‹å¦‚å›¾æ‰€ç¤º:  

![WeiyiGeek.docker](https://i0.hdslb.com/bfs/article/be6c646624dd8b1e3ad5ca3f862ead88fa077785.png@927w_981h_progressive.webp)

**3.åŸºç¡€é•œåƒ**  

æè¿°:é€šè¿‡å‰é¢çš„åŸºç¡€å­¦ä¹ æˆ‘ä»¬çŸ¥é“Docker æ˜¯ä¸€ä¸ªå…¸å‹çš„ C/S æ¶æ„çš„åº”ç”¨ï¼Œåˆ†ä¸ºÂ `Docker å®¢æˆ·ç«¯ï¼ˆå³å¹³æ—¶æ•²çš„ docker å‘½ä»¤ï¼‰`Â å’ŒÂ `Docker æœåŠ¡ç«¯ï¼ˆdockerd å®ˆæŠ¤è¿›ç¨‹ï¼‰`ã€‚

ä¸»è¦ç‰¹å¾:

-   1.Docker å®¢æˆ·ç«¯é€šè¿‡ REST API å’ŒæœåŠ¡ç«¯è¿›è¡Œäº¤äº’ï¼Œå³å®¢æˆ·ç«¯æ¯å‘é€ä¸€æ¡æŒ‡ä»¤ï¼Œåº•å±‚éƒ½ä¼šè½¬åŒ–æˆ REST API è°ƒç”¨çš„å½¢å¼å‘é€ç»™æœåŠ¡ç«¯ï¼ŒæœåŠ¡ç«¯å¤„ç†å®¢æˆ·ç«¯å‘é€çš„è¯·æ±‚å¹¶ç»™å‡ºå“åº”ã€‚
    
-   2.Docker é•œåƒçš„æ„å»ºã€å®¹å™¨åˆ›å»ºã€å®¹å™¨è¿è¡Œç­‰å·¥ä½œéƒ½æ˜¯ Docker æœåŠ¡ç«¯æ¥å®Œæˆçš„ï¼ŒDocker å®¢æˆ·ç«¯åªæ˜¯æ‰¿æ‹…å‘é€æŒ‡ä»¤çš„è§’è‰²ã€‚
    
-   3.Docker å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯å¯ä»¥åœ¨åŒä¸€ä¸ªå®¿ä¸»æœºï¼Œä¹Ÿå¯ä»¥åœ¨ä¸åŒçš„å®¿ä¸»æœº;  
    

-   å¦‚æœåœ¨åŒä¸€ä¸ªå®¿ä¸»æœºçš„è¯ï¼ŒDocker å®¢æˆ·ç«¯é»˜è®¤é€šè¿‡ UNIX å¥—æ¥å­—`(/var/run/docker.sock)`å’ŒæœåŠ¡ç«¯é€šä¿¡;
    
-   å¦‚æœä¸åœ¨åŒä¸€ä¸ªå®¿ä¸»æœºçš„åŒ–ï¼ŒDockerå®¢æˆ·ç«¯åˆ™é€šè¿‡TCPé€šé“`(tcp://xxx.xx.xx.xx:2375)`è¿›è¡Œä¸æœåŠ¡ç«¯é€šä¿¡ã€‚
    

å¦‚æœè¯´ç‚¼åˆ¶é•œåƒä¹Ÿéœ€è¦ä¸ªå·¥å‚çš„è¯ï¼Œé‚£ä¹ˆ dockerd å®ˆæŠ¤è¿›ç¨‹å°±æ˜¯ä¸ªç”Ÿäº§é•œåƒçš„å·¥å‚ã€‚

Tips: é•œåƒå·¥å‚ä¸æ­¢Dockerä¸€å®¶è¿˜æœ‰Redhatå®¶çš„Buildahä¹Ÿèƒ½ç”Ÿäº§é•œåƒ,ä¸¤è€…åŒºåˆ«å¦‚ä¸‹:

-   1.Docker æ„å»ºé•œåƒæ—¶å€™éœ€è¦ROOTæƒé™ï¼Œè€ŒBuildahåˆ™å¯ä»¥é‡‡ç”¨éROOTæƒé™æ„å»ºé•œåƒ
    
-   2.Docker é•œåƒå…¼å®¹æ€§ç›¸å¯¹äºBuildahè¾ƒå¥½;
    
-   3.Docker æ„å»ºé•œåƒä½¿ç”¨å æ¯”æ¯”Buildahå¤š;
    

æ„å»ºé•œåƒ`docker build`çš„æµç¨‹:

-   åœ¨Docker Cli æ‰§è¡Œé•œåƒæ„å»ºå‘½ä»¤å¹¶ä¸”ä½¿ç”¨-få‚æ•°æ¥æŒ‡å®šDockerfileæ–‡ä»¶ï¼Œ-t æŒ‡å®šæ„å»ºå‡ºçš„é•œåƒæ ‡ç­¾ä¿¡æ¯;
    
-   Docker Cli ä¼šå°†æ„å»ºå‘½ä»¤åé¢æŒ‡å®šçš„è·¯å¾„(.)ä¸Šä¸‹æ–‡ç¯å¢ƒæ‰€æœ‰æ–‡ä»¶æ‰“åŒ…æˆä¸€ä¸ª tar åŒ…ï¼Œå¹¶å‘é€ç»™ Docker æœåŠ¡ç«¯;
    
-   Docker Deamon æ”¶åˆ°å®¢æˆ·ç«¯å‘é€çš„ tar åŒ…å¹¶è§£å‹,æ ¹æ® Dockerfile é‡Œé¢çš„æŒ‡ä»¤è¿›è¡Œé•œåƒçš„åˆ†å±‚æ„å»º;
    
-   Docker ä¸‹è½½ FROM è¯­å¥ä¸­æŒ‡å®šçš„åŸºç¡€é•œåƒï¼Œç„¶åå°†åŸºç¡€é•œåƒçš„ layer è”åˆæŒ‚è½½ä¸ºä¸€å±‚å¹¶åœ¨ä¸Šé¢åˆ›å»ºä¸€ä¸ªç©ºç›®å½•ï¼›
    
-   æ­¤æ—¶ä¼šå¯åŠ¨ä¸€ä¸ªä¸´æ—¶çš„å®¹å™¨å¹¶åœ¨ chroot ä¸­å¯åŠ¨ä¸€ä¸ª bash, è¿è¡Œ RUN è¯­å¥ä¸­çš„å‘½ä»¤ï¼š`RUN: chroot . /bin/bash -c "apt get updateâ€¦â€¦"`ï¼›\\
    
-   åœ¨RUNå‘½ä»¤æ‰§è¡Œå®Œæ¯•åï¼Œä¼šå°†å½“å‰å±‚ç›®å½•è¿›è¡Œå‹ç¼©ä»è€Œå½¢æˆæ–°é•œåƒä¸­çš„æ–°çš„ä¸€å±‚, åŒæ—¶ä¸ºä¸‹ä¸€å±‚æä¾›åŸºç¡€é•œåƒ;
    
-   å¦‚æœ Dockerfile ä¸­åŒ…å«å…¶å®ƒå‘½ä»¤ï¼Œå°±ä»¥ä¹‹å‰æ„å»ºçš„å±‚æ¬¡ä¸ºåŸºç¡€ï¼Œä»ç¬¬äºŒæ­¥å¼€å§‹é‡å¤åˆ›å»ºæ–°å±‚ï¼Œç›´åˆ°å®Œæˆæ‰€æœ‰è¯­å¥åé€€å‡ºï¼›
    
-   åœ¨ Dockerfile ä¸­åŒ…å«çš„æ‰€æœ‰æŒ‡ä»¤å‘½ä»¤æ‰§è¡Œå®Œæ¯•åé•œåƒæ„å»ºå®Œæˆï¼Œå¹¶ä¸ºè¯¥é•œåƒæ‰“ä¸ŠTag;
    

Tips: æˆ‘ä»¬å¯ä»¥é‡‡ç”¨`docker history <imageName:Tag>`å‘½ä»¤æ¥é€†å‘æ¨ç®—å‡º docker build çš„è¿‡ç¨‹ã€‚

ç°åœ¨æœ‰ä¸ªé—®é¢˜æ¥äº†åŸºç¡€é•œåƒæ˜¯å¦‚ä½•ç”Ÿæˆ?æ€»ä¸ä¼šæ˜¯å‡­ç©ºæé€ çš„å§!

> ç­”: å®é™…ä¸Šå®ƒä¹Ÿæ˜¯é€šè¿‡Dockerfileä¸­çš„æŒ‡ä»¤æ¥æ„å»ºçš„, æ¯”å¦‚ä»¥`debian:buster`è¯¥åŸºç¡€é•œåƒä¸ºä¾‹çœ‹ä¸€ä¸‹åŸºç¡€é•œåƒæ˜¯å¦‚ä½•ç‚¼æˆçš„;

Base Image Dockerfile

```
# è‡ªä» docker 1.5 ç‰ˆæœ¬å¼€å§‹åœ¨ Dockerfile ä¸­ FROM scratch æŒ‡ä»¤å¹¶ä¸è¿›è¡Œä»»ä½•æ“ä½œä¹Ÿå°±æ˜¯ä¸ä¼šåˆ›å»ºä¸€ä¸ªé•œåƒå±‚ï¼›
FROM scratch
# ADDæŒ‡ä»¤æŠŠ rootfs.tar.xz è§£å‹åˆ° / ç›®å½•ä¸‹ï¼Œç”±æ­¤äº§ç”Ÿçš„ä¸€å±‚é•œåƒå°±æ˜¯æœ€ç»ˆæ„å»ºçš„é•œåƒçœŸå®çš„ layer å†…å®¹
ADD rootfs.tar.xz /
# æŒ‡å®šè¿™é•œåƒåœ¨å¯åŠ¨å®¹å™¨çš„æ—¶å€™æ‰§è¡Œçš„åº”ç”¨ç¨‹åºï¼Œä¸€èˆ¬åŸºç¡€é•œåƒçš„ CMD é»˜è®¤ä¸º bash æˆ–è€… sh ã€‚
CMD ["bash"]
```

æ³¨æ„äº‹é¡¹:

-   1.ä¸Šè¿°ä¸­çš„scratché•œåƒå¹¶ä¸æ˜¯çœŸå®å­˜åœ¨çš„ï¼Œå½“æ‚¨ä½¿ç”¨docker pullå‘½ä»¤ä¸‹è½½å®ƒæ—¶å€™ä¼šæç¤º`Error response from daemon: 'scratch' is a reserved name`;
    
-   2.ä¸Šè¿°ä¸­çš„rootfs.tar.xzæ˜¯å‘è¡Œç‰ˆæºç ç¼–è¯‘çš„å¯ä»¥åœ¨docker-debian-artifactsä¸­æ‰¾åˆ°å®ƒï¼Œå®ƒæ˜¯ä¸€ä¸ªæ“å‡ºæ¥çš„æ ¹æ–‡ä»¶ç³»ç»Ÿ;
    

-   å¦‚æœå¯¹äºå…¶æºç æ„å»ºæ„Ÿå…´è¶£å¯ä»¥å‚è€ƒdebian åŸºç¡€é•œåƒçš„ Jenkins æµæ°´çº¿ä»»åŠ¡debuerreotype
    
-   æ„å¤–å‘ç° Debian å®˜æ–¹æ˜¯å°†æ‰€æœ‰ arch å’Œæ‰€æœ‰ç‰ˆæœ¬çš„Â `rootfs.tar.xz`Â éƒ½æ”¾åœ¨è¿™ä¸ª repo é‡Œçš„ï¼Œä»¥è‡³äºè¿™ä¸ª repo çš„å¤§å°æ¥è¿‘ 2.88 GiB;
    

```
# rootfs.tar.xz Repo ä¸‹è½½$ git clone https://github.com/debuerreotype/docker-debian-artifacts Receiving objects: 100% (660/660), 2.88 GiB | 16.63 MiB/s, done.# rootfs.tar.xz è§£å‹åæŸ¥çœ‹æˆ‘æ‰€è¯´çš„ä»–æ˜¯ä¸€ä¸ªLinuxæ ¹æ–‡ä»¶ç³»ç»Ÿ# åˆ†æ”¯åˆ‡æ¢git checkout dist-amd64cd buster && tar -xvf rootfs.tar.xz -C !$# ä¸åŒäºæˆ‘ä»¬å®‰è£…CentOSç³»ç»Ÿçš„é‚£ä¸ªæ ¹æ–‡ä»¶ç³»ç»Ÿls rootfs/ bin  boot  dev  etc  home  lib  lib64  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var# è¯¥æ ¹æ–‡ä»¶ç³»ç»Ÿæ˜¯ç»è¿‡ä¸€ç³»åˆ—è£å‰ªå»æ‰å®¹å™¨ä¸­å¿…è¦çš„æ–‡ä»¶ï¼Œä½¿ä¹‹æ›´åŠ è½»é‡é€‚ç”¨äºå®¹å™¨è¿è¡Œåœºæ™¯å…¶ä½“ç§¯å¤§å°å¤§æ¦‚ä¸º125MB125M    rootfs# å¦‚æœä½¿ç”¨slimçš„rootfs.tar.xzä¼šæ›´å°ä¸€äº›;du -sh slim/rootfs 76M     slim/rootfs
```

-   3.æ­¤æ—¶åœ¨ä¸Šè¿°ç¯å¢ƒä¸­æˆ‘ä»¬éå¸¸æ–¹ä¾¿çš„è‡ªå·±æ„å»ºdebian:buster åŸºç¡€é•œåƒ
    

```
# åœ¨ buster ç›®å½•ä¸­è¿›è¡Œæ‰§è¡Œé•œåƒæ„å»ºå‘½ä»¤
docker build -t debian:buster .

# ä¸‹é¢å°±æ˜¯æ„å»º Debian åŸºç¡€é•œåƒçš„è¿‡ç¨‹ï¼Œæ­£å¦‚ Dockerfile ä¸­çš„é‚£æ ·ï¼Œæœ€ç»ˆåªäº§ç”Ÿäº†ä¸€å±‚é•œåƒã€‚
Sending build context to Docker daemon  30.12MB
# Step 1/3 : FROM scratch
# Step 2/3 : ADD rootfs.tar.xz /
#  1756d6a585ae
# Step 3/3 : CMD ["bash"]
#  Running in c86a8b6deb3d
# Removing intermediate container c86a8b6deb3d
#  04948daa3c2e
Successfully built 04948daa3c2e
```

æè¿°: Docker åœ¨æ„å»ºå®Œé•œåƒåä¼šå°†å…¶å­˜å‚¨åœ¨Docker æœ¬åœ°å­˜å‚¨å®¶ç›®å½•ä¸­ï¼Œé»˜è®¤æƒ…å†µå³`/var/lib/docker`, å¦‚æœä¿®æ”¹äº†Docker ROOT Dir ç›®å½•çš„å¯ä»¥é€šè¿‡`docker info | grep "Docker Root Dir"`å‘½ä»¤æŸ¥çœ‹;

å¯¹äºé•œåƒå­˜å‚¨è·¯å¾„æœ€é‡è¦çš„ image å’Œ overlay2 è¿™ä¸ªä¸¤ä¸ªç›®å½•ï¼Œå®¹å™¨çš„å…ƒæ•°æ®å­˜æ”¾åœ¨ image ç›®å½•ä¸‹ï¼Œå®¹å™¨çš„ layer æ•°æ®åˆ™å­˜æ”¾åœ¨ overlay2 ç›®å½•ä¸‹ã€‚

```
# é•œåƒå…ƒæ•°æ®ç›®å½•
/var/lib/docker/image
# overlay2 è¡¨ç¤ºæœ¬åœ°ä½¿ç”¨çš„å­˜å‚¨å¼•æ“
/var/lib/docker/image/overlay2/
# è¯¥æ–‡ä»¶å­˜å‚¨é•œåƒå…ƒæ•°æ®ä¿¡æ¯å³ç”±image name å’Œ digest è¿›è¡Œç»„åˆ, è€ŒDigeståˆä¸Image ID å¯¹åº”
# å½“æˆ‘ä»¬ docker run ä¸€ä¸ªå®¹å™¨çš„æ—¶å€™ä¹Ÿç”¨åˆ°è¿™ä¸ªæ–‡ä»¶å»ç´¢å¼•æœ¬åœ°æ˜¯å¦å­˜åœ¨è¯¥é•œåƒï¼Œæ²¡æœ‰é•œåƒçš„è¯å°±è‡ªåŠ¨å» pull è¿™ä¸ªé•œåƒã€‚
/var/lib/docker/image/overlay2/repositories.json
# {
#   "Repositories": {
#     "debian": {
#       "debian:v1": "sha256:cfba37fd24f80f59e5d7c1f7735cae7a383e887d8cff7e2762fdd78c0d73568d",
#       "debian:v2": "sha256:e6e782a57a51d01168907938beb5cd5af24fcb7ebed8f0b32c203137ace6d3df"
#     },
#   }
# }


# é•œåƒ layer çš„å­˜å‚¨ç›®å½•
/var/lib/docker/overlay2
# diff çš„ä¸Šçº§ç›®å½•å°±æ˜¯ä»¥é•œåƒ layer çš„ digest ä¸ºåçš„ç›®å½•
# overlay2
# â”œâ”€â”€ 259cf6934509a674b1158f0a6c90c60c133fd11189f98945c7c3a524784509ff
# â”‚   â””â”€â”€ diff
# â”‚       â”œâ”€â”€ bin
# â”‚       â”œâ”€â”€ dev
# â”‚       â”œâ”€â”€ etc
# â”‚       â”œâ”€â”€ home
# â”‚       â”œâ”€â”€ lib
# â”‚       â”œâ”€â”€ media
# â”‚       â”œâ”€â”€ mnt
# â”‚       â”œâ”€â”€ opt
# â”‚       â”œâ”€â”€ proc
# â”‚       â”œâ”€â”€ root
# â”‚       â”œâ”€â”€ run
# â”‚       â”œâ”€â”€ sbin
# â”‚       â”œâ”€â”€ srv
# â”‚       â”œâ”€â”€ sys
# â”‚       â”œâ”€â”€ tmp
# â”‚       â”œâ”€â”€ usr
# â”‚       â””â”€â”€ var


# æŸ¥çœ‹é•œåƒLayerç»‘å®šçš„Linksåç§°
$more /var/lib/docker/overlay2/30a121491fc6ba331b30f25c411fbe62f9e8e4c24fbe372cd046f4ab601f94bd/link
IEBGN75T7KVLDOEHY5COAGEWQ2

# å…¶ä¸­è¿˜æœ‰ä¸ª l æ–‡ä»¶å¤¹ï¼ˆLinksï¼‰ä¸‹é¢æœ‰ä¸€å¨å¨çš„ç¡¬é“¾æ¥æ–‡ä»¶æŒ‡å‘ä¸Šçº§ç›®å½•çš„ layer ç›®å½•(ä¾¿äºmountç”±äºdigestä¸º256é•¿åº¦å¤ªé•¿)
tree /var/lib/docker/overlay2/l/
# â””â”€ l
#   â”œâ”€â”€ PCIS4FYUJP4X2D4RWB7ETFL6K2 -> ../259cf6934509a674b1158f0a6c90c60c133fd11189f98945c7c3a524784509ff/diff
#   â””â”€â”€ XK5IA4BWQ2CIS667J3SXPXGQK5 -> ../e8f6e78aa1afeb96039c56f652bb6cd4bbd3daad172324c2172bad9b6c0a968d/diff
$ls -lha l/ | grep "IEBGN75T7KVLDOEHY5COAGEWQ2"
lrwxrwxrwx.  1 root root   72 6æœˆ  29 14:41 IEBGN75T7KVLDOEHY5COAGEWQ2 -> ../30a121491fc6ba331b30f25c411fbe62f9e8e4c24fbe372cd046f4ab601f94bd/diff
```

![WeiyiGeek.é•œåƒåœ¨æœ¬åœ°çš„å­˜å‚¨](https://i0.hdslb.com/bfs/article/63ec5cd9816ab91cc69e1139973ff517a0828d32.png@942w_342h_progressive.webp)

æè¿°:é•œåƒä»“åº“ä¸»è¦æ˜¯ç”¨æ¥å­˜å‚¨å’Œåˆ†å‘é•œåƒçš„ï¼Œå¹¶å¯¹å¤–æä¾›ä¸€å¥— HTTP API V2ã€‚  
é•œåƒä»“åº“ä¸­çš„æ‰€æœ‰é•œåƒéƒ½æ˜¯ä»¥`æ•°æ®å— (Blob) çš„æ–¹å¼å­˜å‚¨`åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­ã€‚ æ”¯æŒå¤šç§æ–‡ä»¶ç³»ç»Ÿï¼Œä¸»è¦åŒ…æ‹¬`filesystemï¼ŒS3ï¼ŒSwiftï¼ŒOSS`ç­‰ã€‚

ä¸‹é¢è¯¦ç»†ä»‹ç»ä¸€ä¸‹ï¼Œé•œåƒçš„æ‰€æœ‰æ•°æ®ï¼Œæ˜¯å¦‚ä½•å­˜å‚¨åœ¨é•œåƒä»“åº“çš„æ–‡ä»¶ç³»ç»Ÿä¸­çš„?

ä¸ºäº†åˆ†æé•œåƒå¦‚ä½•å­˜æ”¾åœ¨Registryä¸Šï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æœ¬åœ°dockerç¯å¢ƒä¸­å¯åŠ¨registryå®¹å™¨æ¥å®éªŒå³å¯ï¼Œæ‰€ä»¥åœ¨è¿™ç§åœºæ™¯ä¸‹ä¸å¤ªåˆé€‚ç”¨Harborè¿™ç§é‡é‡çº§çš„Registryé•œåƒä»“åº“å®è·µ;

-   Step1.Registry é•œåƒå®¹å™¨å¯åŠ¨
    

```
# æ‹‰å–å¹¶è¿è¡Œ registry å®¹å™¨,æ³¨æ„æ­¤å¤„ä¸ºäº†æ–¹ä¾¿æ¼”ç¤ºæ²¡å¯¹Registryè®¾ç½®å®‰å…¨è®¤è¯è®¾ç½®åœ¨å®é™…ç¯å¢ƒä¸­å¿…é¡»è¿›è¡Œè®¾ç½®
$docker run -d --name registry -p 9188:5000 -v /var/lib/registry:/var/lib/registry registry
$docker run -d --name registry -p 5000:5000 -v /var/lib/registry:/var/lib/registry registry
335ea763a2fa4508ebf3ec6f8b11f3b620a11bdcaa0ab43176b781427e0beee6
```

-   Step2.ä¸Šä¼ æœ¬åœ°é•œåƒåˆ° Registry ä»“åº“
    

```
# 1) åˆ—å‡ºæœ¬åœ°é•œåƒ
$docker images
REPOSITORY                           TAG                        IMAGE ID            CREATED             SIZE
go-hello                             scratch                    cb05b87d0012        5 days ago          2.07MB
go-hello                             stage                      5934753f8f4f        5 days ago          73.9MB

# 2) å°†é•œåƒæ ‡ç­¾é‡æ–°å‘½åä¸ºregistryåœ°å€+é•œåƒåç§°+ç‰ˆæœ¬
$docker tag  go-hello:scratch  127.0.0.1:5000/go-hello:scratch
$docker push 127.0.0.1:5000/go-hello:scratch
# The push refers to repository [127.0.0.1:5000/go-hello]
# a3586d882361: Pushed
# scratch: digest: sha256:8dabce532312b587329fe225ef501051c60f81ffdb2c801a5da6348b9cab132e size: 528

$docker tag go-hello:stage 127.0.0.1:5000/go-hello:stage
$docker push 127.0.0.1:5000/go-hello:stage
# The push refers to repository [127.0.0.1:5000/go-hello]
# f5c12d3201a7: Pushed
# 095624243293: Pushed
# a37e74863e72: Pushed
# 8eeb4a14bcb4: Pushed
# ce3011290956: Pushed
# stage: digest: sha256:b96f0ada640f7d628a4f22766f5432cbb1a4dfa208b03dc6444f8c699da9533c size: 1360
```

-   Step3.å½“æˆ‘ä»¬åœ¨æœ¬åœ°å¯åŠ¨ä¸€ä¸ª registry å®¹å™¨ä¹‹åï¼Œå®¹å™¨å†…é»˜è®¤çš„å­˜å‚¨ä½ç½®ä¸ºÂ `/var/lib/registry`
    

```
$ tree -d /var/lib/registry/docker/registry
registry
â””â”€â”€ v2
    â”œâ”€â”€ blobs
    â”‚   â””â”€â”€ sha256
    â”‚       â”œâ”€â”€ 0e
    â”‚       â”‚   â””â”€â”€ 0e83886eae4fa0f68c7212e4667e030f8c95aa3669f68257a0fa45bf233492b6
    â”‚       â”œâ”€â”€ 32
    â”‚       â”‚   â””â”€â”€ 323d0d660b6a7da8df08a01dbc7250f38cfa2161db00c7c27c0b20be07a8236a
    â”‚       â”œâ”€â”€ 3f
    â”‚       â”‚   â””â”€â”€ 3ff22d22a8554f746f90a78b501da38d56a46f2ddba0dfec8b260aebaa61b3ba
    â”‚       â”œâ”€â”€ 53
    â”‚       â”‚   â””â”€â”€ 5395625ce01dee311e2f7c879b0b148ac7525de7aad5080a518d7f7e5a99d368
    â”‚       â”‚       â””â”€â”€ layer
    â”‚       â”œâ”€â”€ 59
    â”‚       â”‚   â””â”€â”€ 5934753f8f4f23efdff6e5108997385f17c3b0b25426fe54eb373fb2f1112d87
    â”‚       â”œâ”€â”€ 8d
    â”‚       â”‚   â””â”€â”€ 8dabce532312b587329fe225ef501051c60f81ffdb2c801a5da6348b9cab132e
    â”‚       â”œâ”€â”€ b7
    â”‚       â”‚   â””â”€â”€ b7f616834fd07522cbfd33f0dfa848903599320b5c7191b59fe9aa7562f956a1
    â”‚       â”œâ”€â”€ b9
    â”‚       â”‚   â””â”€â”€ b96f0ada640f7d628a4f22766f5432cbb1a4dfa208b03dc6444f8c699da9533c
    â”‚       â”œâ”€â”€ cb
    â”‚       â”‚   â””â”€â”€ cb05b87d001253772ae9a212200de5eb8304ab9691c61589332a2f57e7059209
    â”‚       â””â”€â”€ e7
    â”‚           â””â”€â”€ e7cb79d19722c46b9c0829811d7a5a0ae82c8771ab7f2f68e7d3a3ed6bd5d5d0
    â””â”€â”€ repositories
        â””â”€â”€ go-hello
            â”œâ”€â”€ _layers
            â”‚   â””â”€â”€ sha256
            â”‚       â”œâ”€â”€ 0e83886eae4fa0f68c7212e4667e030f8c95aa3669f68257a0fa45bf233492b6
            â”‚       â”œâ”€â”€ 323d0d660b6a7da8df08a01dbc7250f38cfa2161db00c7c27c0b20be07a8236a
            â”‚       â”œâ”€â”€ 3ff22d22a8554f746f90a78b501da38d56a46f2ddba0dfec8b260aebaa61b3ba
            â”‚       â”œâ”€â”€ 5395625ce01dee311e2f7c879b0b148ac7525de7aad5080a518d7f7e5a99d368
            â”‚       â”œâ”€â”€ 5934753f8f4f23efdff6e5108997385f17c3b0b25426fe54eb373fb2f1112d87
            â”‚       â”œâ”€â”€ b7f616834fd07522cbfd33f0dfa848903599320b5c7191b59fe9aa7562f956a1
            â”‚       â”œâ”€â”€ cb05b87d001253772ae9a212200de5eb8304ab9691c61589332a2f57e7059209
            â”‚       â””â”€â”€ e7cb79d19722c46b9c0829811d7a5a0ae82c8771ab7f2f68e7d3a3ed6bd5d5d0
            â”œâ”€â”€ _manifests
            â”‚   â”œâ”€â”€ revisions
            â”‚   â”‚   â””â”€â”€ sha256
            â”‚   â”‚       â”œâ”€â”€ 8dabce532312b587329fe225ef501051c60f81ffdb2c801a5da6348b9cab132e
            â”‚   â”‚       â””â”€â”€ b96f0ada640f7d628a4f22766f5432cbb1a4dfa208b03dc6444f8c699da9533c
            â”‚   â””â”€â”€ tags
            â”‚       â”œâ”€â”€ scratch
            â”‚       â”‚   â”œâ”€â”€ current
            â”‚       â”‚   â””â”€â”€ index
            â”‚       â”‚       â””â”€â”€ sha256
            â”‚       â”‚           â””â”€â”€ 8dabce532312b587329fe225ef501051c60f81ffdb2c801a5da6348b9cab132e
            â”‚       â””â”€â”€ stage
            â”‚           â”œâ”€â”€ current
            â”‚           â””â”€â”€ index
            â”‚               â””â”€â”€ sha256
            â”‚                   â””â”€â”€ b96f0ada640f7d628a4f22766f5432cbb1a4dfa208b03dc6444f8c699da9533c
            â””â”€â”€ _uploads


# ç›®å½•è¯´æ˜
blobs ç›®å½•: å­˜å‚¨é•œåƒçš„Layer æ•°æ®ä»¥åŠ Manifest å’Œ Image Configï¼Œè¿™äº›æ–‡ä»¶éƒ½æ˜¯ä»¥ data ä¸ºåçš„æ–‡ä»¶å­˜æ”¾åœ¨äºè¯¥å±‚Layer sha256 ç›¸å¯¹åº”çš„ç›®å½•ä¸‹ï¼›cd..
  - æ–‡ä»¶æœ€å¤§çš„ data æ–‡ä»¶å®é™…æ˜¯ä¸€ä¸ªå‹ç¼©æ–‡ä»¶ï¼Œåœ¨Dockeræ‹‰å–é•œåƒæ—¶å€™ä¼šä¸‹è½½è¯¥dataæ–‡ä»¶ï¼Œç­‰å¾…å®Œæˆådocker-untarè¿›ç¨‹å°†ä¼šæŠŠdataæ–‡ä»¶è§£å‹åˆ°`/var/lib/docker/overlay2/${digest}/diff`ç›®å½•ä¸‹
  - æ–‡ä»¶æœ€å°çš„ data æ–‡ä»¶å®é™…æ˜¯Manifestï¼Œå®ƒè®°å½•äº†ä¸€ä¸ªé•œåƒæ‰€åŒ…å«çš„ layer ä¿¡æ¯ï¼Œå½“æˆ‘ä»¬ pull é•œåƒçš„æ—¶å€™ä¼šä½¿ç”¨åˆ°è¿™ä¸ªæ–‡ä»¶ï¼›
  - æ–‡ä»¶ä»‹äºæœ€å¤§å’Œæœ€å° çš„dataæ–‡ä»¶å®é™…æ˜¯ Image Config å­˜å‚¨é•œåƒç›¸å…³ä¿¡æ¯(æ¶æ„ã€å®¹å™¨é…ç½®ã€åˆ›å»ºå®é™…) å³ `docker inspect image_id` å‘½ä»¤æ‰€çœ‹åˆ°çš„ä¸€äº›ä¿¡æ¯ï¼š

repositories ç›®å½•: å­˜å‚¨é•œåƒåœ¨ä»“åº“ç›¸å…³çš„ä¿¡æ¯ï¼Œå®ƒä»¬ä¸ºäº†ä½¿ç”¨ä»¥å†…å®¹å¯»å€çš„ sha256 æ•£åˆ—å­˜å‚¨æ–¹ä¾¿ç´¢å¼•æ–‡ä»¶;
  - _uploads: å®ƒæ˜¯ä¸´æ—¶æ–‡ä»¶å¤¹ä¸»è¦ç”¨æ¥å­˜æ”¾ push é•œåƒè¿‡ç¨‹ä¸­çš„æ–‡ä»¶æ•°æ®ï¼Œå¹¶ä¸”å½“é•œåƒ layer ä¸Šä¼ å®Œæˆä¹‹åä¼šæ¸…ç©ºè¯¥æ–‡ä»¶å¤¹; å…¶ä¸­çš„ data æ–‡ä»¶ä¸Šä¼ å®Œæ¯•åä¼šç§»åŠ¨åˆ° blobs ç›®å½•ä¸‹ï¼Œå¹¶æ ¹æ®è¯¥æ–‡ä»¶çš„ sha256 å€¼æ¥è¿›è¡Œæ•£åˆ—å­˜å‚¨åˆ°ç›¸åº”çš„ç›®å½•ä¸‹ã€‚
  - _manifests: è¯¥æ–‡ä»¶å¤¹æ˜¯é•œåƒä¸Šä¼ å®Œæˆä¹‹åç”±Registryæ¥ç”Ÿæˆçš„ï¼Œåœ¨è¯¥ç›®å½•ä¸‹çš„æ–‡ä»¶éƒ½æ˜¯ä¸€ä¸ªåä¸ºlinkçš„æ–‡æœ¬æ–‡ä»¶å…¶å€¼æŒ‡å‘blobsç›®å½•ä¸‹ä¸ä¹‹å¯¹åº”çš„ç›®å½•;åœ¨è¯¥ç›®å½•ä¸­åŒ…å«é•œåƒçš„tags å’Œ revisions ä¿¡æ¯ï¼Œæ¯ä¸€ä¸ªé•œåƒçš„æ¯ä¸€ä¸ªTagå¯¹åº”ç€äºtagåç§°ç›¸åŒçš„ç›®å½•;
    # - _revisions ç›®å½•é‡Œå­˜æ”¾äº†è¯¥ repository å†å²ä¸Šä¸Šä¼ ç‰ˆæœ¬çš„æ‰€æœ‰ sha256 ç¼–ç ä¿¡æ¯ã€‚
    # - tags/current ç›®å½•ä¸‹çš„ link æ–‡ä»¶ä¿å­˜äº†è¯¥ tag ç›®å‰çš„ manifest æ–‡ä»¶çš„ sha256 ç¼–ç å¯¹åº”åœ¨ blobs ä¸­çš„ sha256 ç›®å½•ä¸‹çš„ data æ–‡ä»¶
    # - tags/index ç›®å½•åˆ™åˆ—å‡ºäº†è¯¥ tag å†å²ä¸Šä¼ çš„æ‰€æœ‰ç‰ˆæœ¬çš„ sha256 ç¼–ç ä¿¡æ¯
```

-   Step4.å½“æˆ‘ä»¬ pull é•œåƒçš„æ—¶å€™å¦‚æœä¸æŒ‡å®šé•œåƒçš„ tagåé»˜è®¤å°±æ˜¯ latest, registry ä¼šä» HTTP è¯·æ±‚ä¸­è§£æåˆ°è¿™ä¸ªtagåï¼Œç„¶å`æ ¹æ®tagåç›®å½•ä¸‹çš„ link æ–‡ä»¶æ‰¾åˆ°è¯¥é•œåƒçš„ manifestçš„ä½ç½®è¿”å›ç»™å®¢æˆ·ç«¯`ï¼Œå®¢æˆ·ç«¯æ¥ç€å»è¯·æ±‚è¿™ä¸ªmanifest æ–‡ä»¶ï¼Œå®¢æˆ·ç«¯æ ¹æ®è¿™ä¸ª manifest æ–‡ä»¶æ¥ pull ç›¸åº”çš„é•œåƒ layer ã€‚
    

```
# æ‰¾åˆ°Manifestä½ç½®
$cat /var/lib/registry/docker/registry/v2/repositories/go-hello/_manifests/tags/scratch/current/link
sha256:8dabce532312b587329fe225ef501051c60f81ffdb2c801a5da6348b9cab132e

# è¿›å…¥æŸ¥çœ‹Manifestå†…å®¹
$ls -lah /var/lib/registry/docker/registry/v2/blobs/sha256/8d/8dabce532312b587329fe225ef501051c60f81ffdb2c801a5da6348b9cab132e/
æ€»ç”¨é‡ 4.0K
drwxr-xr-x. 2 root root  18 8æœˆ   2 09:58 .
drwxr-xr-x. 3 root root  78 8æœˆ   2 09:58 ..
-rw-r--r--. 1 root root 528 8æœˆ   2 09:58 data
$cat /var/lib/registry/docker/registry/v2/blobs/sha256/8d/8dabce532312b587329fe225ef501051c60f81ffdb2c801a5da6348b9cab132e/data
{
   "schemaVersion": 2,
   "mediaType": "application/vnd.docker.distribution.manifest.v2+json",
   # é•œåƒæ‹‰å–æ—¶é•œåƒImage Configæ–‡ä»¶åœ°å€
   "config": {
      "mediaType": "application/vnd.docker.container.image.v1+json",
      "size": 1472,
      "digest": "sha256:cb05b87d001253772ae9a212200de5eb8304ab9691c61589332a2f57e7059209"
   },
   # é•œåƒæ‹‰å–æ—¶ä¸‹è½½å¹¶åˆ©ç”¨docker-untarçº¿ç¨‹è§£å‹
   "layers": [
      {
         "mediaType": "application/vnd.docker.image.rootfs.diff.tar.gzip",
         "size": 1106793,
         "digest": "sha256:5395625ce01dee311e2f7c879b0b148ac7525de7aad5080a518d7f7e5a99d368"
      }
   ]
}
```

**æ€»ç»“æ€æƒ³:**

-   1.åŒä¸€é•œåƒåœ¨ä¸åŒRegistryé•œåƒä»“åº“ä¸­ï¼Œå­˜å‚¨çš„æ–¹å¼ã€ä½ç½®å’Œå†…å®¹å®Œå…¨ä¸€æ ·å› ä¸ºå®ƒä»¬çš„Layer digeståœ¨ä»“åº“ä¸­å”¯ä¸€ã€‚
    

-   é€šè¿‡ Registry API è·å¾—çš„ä¸¤ä¸ªé•œåƒä»“åº“ä¸­ç›¸åŒé•œåƒçš„ manifest ä¿¡æ¯å®Œå…¨ç›¸åŒã€‚
    
-   ä¸¤ä¸ªé•œåƒä»“åº“ä¸­ç›¸åŒé•œåƒçš„ manifest ä¿¡æ¯çš„å­˜å‚¨è·¯å¾„å’Œå†…å®¹å®Œå…¨ç›¸åŒã€‚
    
-   ä¸¤ä¸ªé•œåƒä»“åº“ä¸­ç›¸åŒé•œåƒçš„ blob ä¿¡æ¯çš„å­˜å‚¨è·¯å¾„å’Œå†…å®¹å®Œå…¨ç›¸åŒã€‚
    

-   2.registry å­˜å‚¨ç›®å½•é‡Œå¹¶ä¸ä¼šå­˜å‚¨ä¸è¯¥ registry ç›¸å…³çš„ä¿¡æ¯ï¼Œæ¯”å¦‚æˆ‘ä»¬pushé•œåƒæ—¶ç»™é•œåƒåŠ ä¸Š 127.0.0.1:5000 å‰ç¼€; æ‰€ä»¥æˆ‘ä»¬åœ¨è¿ç§»ä¸€ä¸ªå¤§çš„Registryé•œåƒä»“åº“æ—¶å€™æœ€å¿«æ·çš„æ–¹æ³•å°±æ˜¯æ‰“åŒ…(tar -cvf - ä¸éœ€è¦åŠ zå‚æ•°æµªè´¹ CPU æ—¶é—´å¾—ä¸å¿å¤±)è¯¥registryå­˜å‚¨ç„¶åå°†å…¶taråŒ…rsyncåˆ°å…¶å®ƒæœºå™¨å³å¯;
    

æè¿°: å½“æˆ‘ä»¬åœ¨æœ¬åœ°æ„å»ºå®Œæˆä¸€ä¸ªé•œåƒä¹‹åï¼Œå¦‚ä½•ä¼ é€’ç»™ä»–äººå‘¢ï¼Ÿæ­¤æ—¶ä¸‹é¢çš„æ–‡ç« æˆ–è€…æŠ€å·§èƒ½æ›´å¥½å¸®åŠ©æ‚¨;

è¿™é‡Œéœ€è¦åˆ©ç”¨GitHub(git)è¿›è¡Œåšç±»æ¯”ï¼Œå®é™…ä¸Šæ¬è¿é•œåƒçš„æµç¨‹å°±åƒåœ¨Githubä¸Šæ¬è¿ä»£ç ä¸€æ ·;

```
Github ä»£ç ä»“åº“ == Docker registryé•œåƒä»“åº“(Harbor-å…¬å…±/ç§æœ‰çš„é•œåƒ) 
# Registry: https://index.docker.io/v1/
git clone|pull == docker pull  # æ‹‰å–
git push == docker push  # æ¨é€
```

pull - é•œåƒæ‹‰å–  

æè¿°:ä¸ºäº†æ–¹ä¾¿ç†è§£docker fullæ‹‰å–é•œåƒæµç¨‹å¯ä»¥å‚çœ‹OCI Registryè§„èŒƒä¸­çš„æ–‡æ¡£åœ°å€,ä¸‹é¢æ˜¯ç»“åˆå¤§ä½¬çš„åšå®¢ç®€å•æ¢³ç†ä¸€ä¸‹ pull ä¸€ä¸ªé•œåƒçš„å¤§è‡´æµç¨‹ï¼š  

![WeiyiGeek.å‘å¤§ä½¬å€Ÿçš„å›¾](https://i0.hdslb.com/bfs/article/639f6fc597c0e3013c29dc9f7d1c8604779246c1.png@942w_839h_progressive.webp)

ç»“åˆä¸Šå›¾å¤§è‡´çš„æµç¨‹ï¼Œæˆ‘å°†è¿œç¨‹çš„é•œåƒä»“åº“æ‹‰å–åˆ°æœ¬åœ°æ¥ç»™å®¹å™¨è¿è¡Œæ—¶ä½¿ç”¨å…·ä½“æµç¨‹å¦‚ä¸‹ï¼š

-   Step1.é…ç½®Registryé•œåƒä»“åº“çš„authè®¤è¯ä¿¡æ¯
    

```
# Auth è®¤è¯ä¿¡æ¯é…ç½®åœ¨Docker pullæ—¶å€™ä¼šå‘registryè¿›è¡Œé‰´æƒéšåä¼šå–å¾—çš„token;
# åœ¨éšåçš„HTTPè¯·æ±‚ä¸­éƒ½è¦åŒ…å«è¯¥Tokenæ‰èƒ½æœ‰æƒé™è¿›è¡Œæ“ä½œ;
cat ~/.docker/config.json
{
  "auths": { "https://registry.k8s.li/v2/": {"auth": "d2VicH855828WM7bSVsslJFpmQE43Sw=="}},
  "HttpHeaders": {
    "User-Agent": "Docker-Client/19.03.5 (linux)"
   },
  "experimental": "enabled"
}
```

-   Step2.dockerd å®ˆæŠ¤è¿›ç¨‹è§£æ docker å®¢æˆ·ç«¯å‚æ•°ç”±`é•œåƒå + tag`æ„æˆå‘ registry è¯·æ±‚Manifest æ–‡ä»¶ï¼Œ
    

```
# registry ä¸­ä¸€ä¸ªé•œåƒæœ‰å¤šä¸ª tag æˆ–è€…å¤šä¸ªå¤„ç†å™¨ä½“ç³»æ¶æ„çš„é•œåƒï¼Œåˆ™æ ¹æ®è¿™ä¸ª tag æ¥è¿”å›ç»™å®¢æˆ·ç«¯ä¸ä¹‹å¯¹åº”çš„ manifest æ–‡ä»¶ï¼›
# HTTP è¯·æ±‚ä¸ºGET /v2/<name>/manifests/<reference> ä¸‹é¢å‚æ•°çš„è§£é‡Šä¸ä¸Šé¢çš„Manifestè§£é‡Šå¯¹åº”
GET /v2/<name>/manifests/<reference>
{
   "annotations": {
      "com.example.key1": "value1",
      "com.example.key2": "value2"
   },
   # éªŒè¯å·²ä¸‹è½½çš„å±‚ä½¿ç”¨
   "config": {
      "digest": "sha256:6f4e69a5ff18d92e7315e3ee31c62165ebf25bfa05cad05c0d09d8f412dae401",
      "mediaType": "application/vnd.oci.image.config.v1+json",
      "size": 452
   },
   # ä¸‹è½½æ‹‰å–ä½¿ç”¨
   "layers": [{
         "digest": "sha256:6f4e69a5ff18d92e7315e3ee31c62165ebf25bfa05cad05c0d09d8f412dae401",
         "mediaType": "application/vnd.oci.image.layer.v1.tar+gzip",
         "size": 78343
      }
   ],
   "schemaVersion": 2
}
```

-   Step3.docker å®ˆæŠ¤è¿›ç¨‹è§£æè¿™ä¸ª Manifest æ–‡ä»¶è·å–é•œåƒçš„ layer çš„ä¿¡æ¯ï¼›ç„¶ådockerdå®ˆæŠ¤è¿›ç¨‹å¹¶è¡Œä¸‹è½½å„ layer ï¼ŒHTTP è¯·æ±‚ä¸º`GET /v2/<name>/blobs/<digest>`ã€‚
    
-   Step4.dockerd èµ·ä¸€ä¸ªå•ç‹¬çš„è¿›ç¨‹ docker-untar æ¥ gzip è§£å‹ç¼©å·²ç»ä¸‹è½½å®Œæˆçš„ layer æ–‡ä»¶ï¼›æ³¨æ„å¯¹äºæœ‰äº›æ¯”è¾ƒå¤§çš„é•œåƒï¼ˆæ¯”å¦‚å‡ å GB çš„é•œåƒï¼‰ï¼Œå¾€å¾€é•œåƒçš„ layer å·²ç»ä¸‹è½½å®Œæˆäº†ï¼Œä½†è¿˜æ²¡æœ‰è§£å‹å®Œ;
    
  

```
$ls /var/lib/docker/overlay2/30a121491fc6ba331b30f25c411fbe62f9e8e4c24fbe372cd046f4ab601f94bd/diff/
bin  boot  dev  etc  home  lib  lib64  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var

# é»˜è®¤è¯¥å‘½ä»¤ä¸å­˜åœ¨çš„
$docker-untar /var/lib/docker/overlay2/30a121491fc6ba331b30f25c411fbe62f9e8e4c24fbe372cd046f4ab601f94bd/diff/
```

-   Step5.éªŒè¯ image config ä¸­çš„Â `RootFS.DiffIDs`Â æ˜¯å¦ä¸ä¸‹è½½ï¼ˆè§£å‹åï¼‰hash ç›¸åŒï¼›
    
-   Step6.è§£æ Manifest è·å–é•œåƒ Configurationï¼ŒéªŒè¯é•œåƒæ˜¯å¦æ­£ç¡®ã€‚
    

æè¿°: é‡‡ç”¨ docker push æ¨é€ä¸€ä¸ªé•œåƒåˆ°è¿œç¨‹çš„Registryæµç¨‹æ°å¥½ä¸docker pullæ‹‰å–é•œåƒåˆ°æœ¬åœ°æµç¨‹ç›¸åï¼›  
å®ƒå…ˆè·å–è¦ä¸Šä¼ é•œåƒçš„Layerä¿¡æ¯æ¨é€åˆ°Registry,å½“é•œåƒçš„æ‰€æœ‰layerä¸Šä¼ å®Œæ¯•åå†push Image Manifest åˆ°Registry;

å…·ä½“æµç¨‹:

-   Step1.push é•œåƒåˆ°Registryä»“åº“ä¸­éœ€è¦è¿›è¡Œé‰´æƒåŒæ—¶è¿”å›ä¸€ä¸ªToken(åç»­åˆ©ç”¨å®ƒä½œä¸ºèº«ä»½éªŒè¯);
    
-   Step2.å‘Registryå‘èµ·è¯·æ±‚`POST /v2/<name>/blobs/uploads/`ï¼Œregistry è¿”å›ä¸€ä¸ªä¸Šä¼ é•œåƒ layer æ—¶è¦åº”åˆ°çš„ URLï¼›
    
-   Step3.å®¢æˆ·ç«¯é€šè¿‡`HEAD /v2/<name>/blobs/<digest>`è¯·æ±‚æ£€æŸ¥ registry ä¸­æ˜¯å¦å·²ç»å­˜åœ¨é•œåƒçš„ layerã€‚
    
-   Step4.å®¢æˆ·ç«¯é€šè¿‡URL ä½¿ç”¨ POST æ–¹æ³•æ¥å®æ—¶ä¸Šä¼  layer æ•°æ®å³ä¸Šä¼ é•œåƒï¼Œä½†æ˜¯ä¸Šä¼ é•œåƒ layer åˆ†ä¸ºÂ `Monolithic Upload ï¼ˆæ•´ä½“ä¸Šä¼ ï¼‰`å’Œ`Chunked Uploadï¼ˆåˆ†å—ä¸Šä¼ ï¼‰`ä¸¤ç§æ–¹å¼ã€‚
    

```
# 1.Monolithic Upload
PUT /v2/<name>/blobs/uploads/<session_id>?digest=<digest>
Content-Length: <size of layer>
Content-Type: application/octet-stream

<Layer Binary Data>


# 2.Chunked Upload
PATCH /v2/<name>/blobs/uploads/<session_id>
Content-Length: <size of chunk>
Content-Range: <start of range>-<end of range>
Content-Type: application/octet-stream

<Layer Chunk Binary Data>
```

-   Step5.é•œåƒçš„ layer ä¸Šä¼ å®Œæˆä¹‹åï¼Œå®¢æˆ·ç«¯éœ€è¦å‘ registry å‘é€ä¸€ä¸ª PUT HTTP è¯·æ±‚å‘ŠçŸ¥è¯¥ layer å·²ç»ä¸Šä¼ å®Œæ¯•ã€‚
    

```
PUT /v2/<name>/blobs/uploads/<session_id>?digest=<digest>
Content-Length: <size of chunk>
Content-Range: <start of range>-<end of range>
Content-Type: application/octet-stream

<Last Layer Chunk Binary Data>
```

-   Step6.æœ€åå½“æ‰€æœ‰çš„ layer ä¸Šä¼ å®Œä¹‹åå®¢æˆ·ç«¯å† PUT è¯·æ±‚å°† manifest æ¨é€ä¸Šå»å°±å®Œäº‹å„¿äº†ã€‚
    

```
PUT /v2/<name>/manifests/<reference>
Content-Type: <manifest media type>
{
   "annotations": {
      "com.example.key1": "value1",
      "com.example.key2": "value2"
   },
   "config": {
      "digest": "sha256:6f4e69a5ff18d92e7315e3ee31c62165ebf25bfa05cad05c0d09d8f412dae401",
      "mediaType": "application/vnd.oci.image.config.v1+json",
      "size": 452
   },
   "layers": [
      {
         "digest": "sha256:6f4e69a5ff18d92e7315e3ee31c62165ebf25bfa05cad05c0d09d8f412dae401",
         "mediaType": "application/vnd.oci.image.layer.v1.tar+gzip",
         "size": 78343
      }
   ],
   "schemaVersion": 2
}
```

## python Docker-dray

æè¿°: å®ƒæ˜¯ä¸€ä¸ªPythonè„šæœ¬å®ƒä½¿ç”¨Requeståº“è¯·æ±‚Registry APIæ¥ä»é•œåƒä»“åº“ä¸­æ‹‰å»é•œåƒå¹¶ä¿å­˜ä¸ºtaråŒ…, æ‹‰å–å®Œæˆåä½¿ç”¨Docker loadåŠ è½½åˆ°æœ¬åœ°dockeré•œåƒä¸­;

å®ƒä¸docker pull ä»¥åŠ Skopeo copyæœ‰ç›¸ä¼¼åŸç†,ç›¸åŒçš„æ˜¯å®ƒä»¬éƒ½ä¼šå»è°ƒç”¨Registry API;

Install && Usage:

```
# Download docker-dray
wget https://raw.githubusercontent.com/NotGlop/docker-drag/master/docker_pull.py

# Syntax 
python3 docker_pull.py [image name]

# Usage 
$python3 docker_pull.py nginx
Creating image structure in: tmp_nginx_latest
afb6ec6fdc1c: Pull complete [27098756]
dd3ac8106a0b: Pull complete [26210578]                                       ]
8de28bdda69b: Pull complete [538]
a2c431ac2669: Pull complete [900]
e070d03fd1b5: Pull complete [669]
Docker image pulled: library_nginx.tar
$docker load -i library_nginx.tar
ffc9b21953f4: Loading layer [==================================================>]  72.49MB/72.49MB
d9c0b16c8d5b: Loading layer [==================================================>]  63.81MB/63.81MB
8c7fd6263c1f: Loading layer [==================================================>]  3.072kB/3.072kB
077ae58ac205: Loading layer [==================================================>]  4.096kB/4.096kB
787328500ad5: Loading layer [==================================================>]  3.584kB/3.584kB
Loaded image: nginx:latest
```

æè¿°: Skopeoç”±Redhat çº¢å¸½å¼€å‘çš„ï¼Œå®ƒä¸Podmanå’ŒBuildah ç®€ç§°(PSB)ä¸‹ä¸€ä»£å®¹å™¨æ¶æ„ä¸­çš„ä¸€å‘˜;  
çº¢å¸½å®¶çš„Podmanæ¨å‡ºæ˜¯æƒ³è¦å–ä»£Dockerå’ŒContainerdå®¹å™¨è¿è¡Œæ—¶ï¼Œè™½ç„¶å®ƒç¬¦åˆOCIè§„èŒƒä½†æ˜¯å¯¹ç°åœ¨ä¼ä¸šæ¥è®²åŸºæœ¬é‡‡ç”¨Dockerå¹¶ä¸”ä¹Ÿå·²ç»åº”ç”¨åœ¨ç”Ÿäº§ç¯å¢ƒä¹‹ä¸­äº†,æ›¿æ¢çš„æˆæœ¬å¹¶ä¸å€¼å¾—ä»–ä»¬å»æ¢åˆ° PSB ä¸Šå»;

Q: ä½†æ˜¯ä¸æ¯«ä¸å½±å“æˆ‘ä»¬ä½¿ç”¨Skopeoé•œåƒæ¬è¿å·¥å…·ï¼Œä¸ºä»€ä¹ˆè¯´å®ƒæ˜¯ä¸€ä¸ªç¥å™¨å‘¢?

> ç­”: å› ä¸ºå®ƒå¯ä»¥é’ˆå¯¹ä¸åŒå­˜åœ¨æ–¹å¼çš„é•œåƒLayeråŒæ­¥æˆ–è€…å¤åˆ¶åˆ°æŒ‡å®šé•œåƒä»“åº“ä¸­ï¼Œè¿™æ ·åšçš„å¥½å¤„æ˜¯å…å»äº†åƒÂ `docker pull â€“> docker tag â€“> docker push`Â é‚£æ · pull é•œåƒå¯¹é•œåƒè¿›è¡Œè§£å‹ç¼©ï¼Œpush é•œåƒè¿›è¡Œå‹ç¼©ã€‚å°¤å…¶æ˜¯åœ¨æ¬è¿ä¸€äº›è¾ƒå¤§çš„é•œåƒï¼ˆå‡ GB æˆ–è€…å‡ å GBçš„é•œåƒï¼Œæ¯”å¦‚ nvidia/cuda ï¼‰ï¼Œä½¿ç”¨ skopeo copy çš„åŠ é€Ÿæ•ˆæœååˆ†æ˜æ˜¾ã€‚  
> æ¯”å¦‚åœ¨CI/CDæµæ°´çº¿ä¸­æ¬è¿ä¸¤ä¸ªé•œåƒä»“åº“è€Œä¸å¿…æ‰“åŒ…ç„¶åå†åˆ†åˆ«pushåˆ°é•œåƒä¹‹ä¸­;

ä¾‹å¦‚ï¼Œç”¨ skopeo inspect å‘½ä»¤å¯ä»¥å¾ˆæ–¹æ–¹ä¾¿åœ°é€šè¿‡ registry çš„ API æ¥æŸ¥çœ‹é•œåƒçš„ manifest æ–‡ä»¶ï¼Œä»¥å‰æˆ‘éƒ½æ˜¯ç”¨ curl å‘½ä»¤çš„ï¼Œè¦ token è¿˜è¦åŠ ä¸€å †å‚æ•°ï¼Œæ‰€ä»¥æ¯”è¾ƒéº»çƒ¦ï¼Œæ‰€ä»¥åæ¥å°±ç”¨ä¸Šäº† skopeo inspect

```
root@deploy:/root # skopeo inspect docker://index.docker.io/webpsh/webps:latest --raw
{
   "schemaVersion": 2,
   "mediaType": "application/vnd.docker.distribution.manifest.v2+json",
   "config": {
      "mediaType": "application/vnd.docker.container.image.v1+json",
      "size": 2534,
      "digest": "sha256:30d9679b0b1ca7e56096eca0cdb7a6eedc29b63968f25156ef60dec27bc7d206"
   },
   "layers": [
      {
         "mediaType": "application/vnd.docker.image.rootfs.diff.tar.gzip",
         "size": 2813316,
         "digest": "sha256:cbdbe7a5bc2a134ca8ec91be58565ec07d037386d1f1d8385412d224deafca08"
      },
      {
         "mediaType": "application/vnd.docker.image.rootfs.diff.tar.gzip",
         "size": 8088920,
         "digest": "sha256:54335262c2ed2d4155e62b45b187a1394fbb6f39e0a4a171ab8ce0c93789e6b0"
      },
      {
         "mediaType": "application/vnd.docker.image.rootfs.diff.tar.gzip",
         "size": 262,
         "digest": "sha256:31555b34852eddc7c01f26fa9c0e5e577e36b4e7ccf1b10bec977eb4593a376b"
      }
   ]
}
```

## 0x03 é•œåƒä½¿ç”¨  

Q:å½“æˆ‘ä»¬æ‹¿åˆ°ä¸€ä¸ªé•œåƒä¹‹åï¼Œå¦‚æœç”¨å®ƒæ¥å¯åŠ¨ä¸€ä¸ªå®¹å™¨å‘¢ï¼Ÿ

> ç­”:å®¹å™¨è¿è¡Œæ—¶é€šè¿‡ä¸€ä¸ªå« OCI runtime filesytem bundle çš„æ ‡å‡†æ ¼å¼å°† OCI é•œåƒé€šè¿‡å·¥å…·è½¬æ¢ä¸º bundle ç„¶å`OCI å®¹å™¨å¼•æ“èƒ½å¤Ÿè¯†åˆ«è¿™ä¸ª bundle æ¥è¿è¡Œå®¹å™¨`ã€‚  
> æ­¤å¤„æ¶‰åŠåˆ°äº† OCI è§„èŒƒä¸­çš„å¦ä¸€ä¸ªè§„èŒƒå³è¿è¡Œæ—¶è§„èŒƒ runtime-spec;

filesystem bundle æ˜¯ä¸ªç›®å½•ï¼Œç”¨äºç»™ runtime æä¾›å¯åŠ¨å®¹å™¨å¿…å¤‡çš„é…ç½®æ–‡ä»¶å’Œæ–‡ä»¶ç³»ç»Ÿ;  
æ ‡å‡†çš„å®¹å™¨ bundle åŒ…å«ä»¥ä¸‹å†…å®¹ï¼š

-   config.json: è¯¥æ–‡ä»¶åŒ…å«äº†å®¹å™¨è¿è¡Œçš„é…ç½®ä¿¡æ¯ï¼Œè¯¥æ–‡ä»¶å¿…é¡»å­˜åœ¨ bundle çš„æ ¹ç›®å½•ï¼Œä¸”åå­—å¿…é¡»ä¸º config.json
    
-   å®¹å™¨çš„æ ¹ç›®å½•å¯ä»¥ç”± config.json ä¸­çš„ root.path æŒ‡å®š
    

```
  OCI Image
      |
download unpack
      |
OCI Runtime Filesystem Bundle  <---run---> OCI Runtime  
```

**æµç¨‹è¯´æ˜:**

-   Step1.å½“æˆ‘ä»¬å¯åŠ¨ä¸€ä¸ªå®¹å™¨ä¹‹åæˆ‘ä»¬ä½¿ç”¨Treeå‘½ä»¤æ¥åˆ†æOverlay2ä¼šå‘ç°ï¼Œå®¹å™¨docker run å¯åŠ¨åè¾ƒä¹‹å‰çš„overlay2ç›®å½•ä¸‹å¤šäº†ä¸€ä¸ª merged çš„æ–‡ä»¶å¤¹å¹¶ä¸”è¯¥æ–‡ä»¶å¤¹åœ¨å®¹å™¨ä¸­å¯è§;
    

```
â•­â”€root@sg-02 /var/lib/docker
â•°â”€# tree overlay2 -d -L 3
overlay2
â”œâ”€â”€ 259cf6934509a674b1158f0a6c90c60c133fd11189f98945c7c3a524784509ff
â”‚   â””â”€â”€ diff
â”‚       â”œâ”€â”€ bin
|
â”‚       â””â”€â”€ var
â”œâ”€â”€ 27f9e9b74a88a269121b4e77330a665d6cca4719cb9a58bfc96a2b88a07af805
â”‚   â”œâ”€â”€ diff
â”‚   â””â”€â”€ work
â”œâ”€â”€ 5f85c914c55220ec2635bce0080d2ad677f739dcfac4fd266b773625e3051844
â”‚   â”œâ”€â”€ diff
â”‚   â”‚   â””â”€â”€ var
â”‚   â”œâ”€â”€ merged
â”‚   â”‚   â”œâ”€â”€ bin
â”‚   â”‚   â”œâ”€â”€ dev
â”‚   â”‚   â”œâ”€â”€ etc
â”‚   â”‚   â”œâ”€â”€ home
â”‚   â”‚   â”œâ”€â”€ lib
â”‚   â”‚   â”œâ”€â”€ media
â”‚   â”‚   â”œâ”€â”€ mnt
â”‚   â”‚   â”œâ”€â”€ proc
â”‚   â”‚   â”œâ”€â”€ root
â”‚   â”‚   â”œâ”€â”€ run
â”‚   â”‚   â”œâ”€â”€ sbin
â”‚   â”‚   â”œâ”€â”€ srv
â”‚   â”‚   â”œâ”€â”€ sys
â”‚   â”‚   â”œâ”€â”€ tmp
â”‚   â”‚   â”œâ”€â”€ usr
â”‚   â”‚   â””â”€â”€ var
â”‚   â””â”€â”€ work
â”‚       â””â”€â”€ work
â”œâ”€â”€ 5f85c914c55220ec2635bce0080d2ad677f739dcfac4fd266b773625e3051844-init
â”‚   â”œâ”€â”€ diff
â”‚   â”‚   â”œâ”€â”€ dev
â”‚   â”‚   â””â”€â”€ etc
â”‚   â””â”€â”€ work
â”‚       â””â”€â”€ work
```

-   Step2.Docker é€šè¿‡ overlayfs è”åˆæŒ‚è½½çš„æŠ€æœ¯å°†é•œåƒçš„å¤šå±‚ layer æŒ‚è½½ä¸ºä¸€å±‚ï¼Œè¿™å±‚çš„å†…å®¹å°±æ˜¯å®¹å™¨é‡Œæ‰€çœ‹åˆ°çš„ä¹Ÿå°±æ˜¯ merged æ–‡ä»¶å¤¹ã€‚
    
  

```
$mount -l
overlay on / type overlay (rw,relatime,lowerdir=/opt/docker/overlay2/l/4EPD2X5VF62FH5PZOZHZDKAKGL:/opt/docker/overlay2/l/MYRYBGZRI4I76MJWQHN7VLZXLW:/opt/docker/overlay2/l/5RZOXYR35NSGAWTI36CVUIRW7U:/opt/docker/overlay2/l/LBWRL4ZXGBWOTN5JDCDZVNOY7H:/opt/docker/overlay2/l/526XCHXRJMZXRIHN4YWJH2QLPY:/opt/docker/overlay2/l/XK5IA4BWQ2CIS667J3SXPXGQK5,upperdir=/opt/docker/overlay2/f913d81219134e23eb0827a1c27668494dfaea2f1b5d1d0c70382366eabed629/diff,workdir=/opt/docker/overlay2/f913d81219134e23eb0827a1c27668494dfaea2f1b5d1d0c70382366eabed629/work)
```

-   ä» docker å®˜æ–¹æ–‡æ¡£Â `Use the OverlayFS storage driver`Â é‡Œå·æ¥çš„ä¸€å¼ å›¾ç‰‡åˆ†åˆ«ä»‹ç»å„ Dir çš„ä½œç”¨
    

```
# è¿™äº›æ˜¯è¦†ç›–æ–‡ä»¶ç³»ç»Ÿçš„åªè¯»å±‚ã€‚å¯¹äºdockerè¿™äº›æ˜¯æŒ‰é¡ºåºç»„è£…çš„å›¾åƒå±‚ã€‚
LowerDir: these are the read-only layers of an overlay filesystem. For docker, these are the image layers assembled in order.

# è¿™æ˜¯è¦†ç›–æ–‡ä»¶ç³»ç»Ÿçš„è¯»å†™å±‚ã€‚å¯¹äºdockerï¼Œè¿™ç›¸å½“äºå®¹å™¨ç‰¹å®šå±‚ï¼Œè¯¥å±‚åŒ…å«å®¹å™¨æ‰€åšçš„æ›´æ”¹ã€‚
UpperDir: this is the read-write layer of an overlay filesystem. For docker, that is the equivalent of the container specific layer that contains changes made by that container.

# è¿™æ˜¯ä¸€ä¸ªéœ€è¦çš„ç›®å½•è¦†ç›–ï¼Œå®ƒéœ€è¦ä¸€ä¸ªç©ºçš„ç›®å½•å†…éƒ¨ä½¿ç”¨ã€‚
WorkDir: this is a required directory for overlay, it needs an empty directory for internal use.

# Dockeråœ¨è¿è¡Œå®¹å™¨æ—¶æœ‰æ•ˆåœ°å°†æ ¹ç›®å½•chrootåˆ°è¿™ä¸ªç›®å½•ä¸­ã€‚
MergedDir: this is the result of the overlay filesystem. Docker effectively chrootâ€™s into this directory when running the container.
```

![WeiyiGeek.](https://i0.hdslb.com/bfs/article/49e13aafdb354b095fff66d3385f4189b91f8247.png@942w_245h_progressive.webp)

-   Step 3.å¦‚æœæƒ³å¯¹ overlayfs æ–‡ä»¶ç³»ç»Ÿæœ‰è¯¦ç»†çš„äº†è§£ï¼Œå¯ä»¥å‚è€ƒ Linux å†…æ ¸å®˜ç½‘ä¸Šçš„è¿™ç¯‡æ–‡æ¡£Â overlayfs.txtÂ ã€‚
    

è‡³æ­¤æœ¬èŠ‚å®Œæ¯•ï¼Œæ•¬è¯·æœŸå¾…ä¸‹ä¸€å°èŠ‚å†…å®¹ã€‚

Dockerå®¹å™¨æŠ€æœ¯å…¥é—¨å®è·µç³»åˆ—å†å²å·²å‘å¸ƒæ–‡ç« ï¼ˆç‚¹å‡»å³å¯è¿›å…¥ï¼‰ï¼š

[1.æˆ‘åœ¨Bç«™å­¦äº‘åŸç”Ÿä¹‹Dockerå®¹å™¨æŠ€æœ¯åŸºç¡€çŸ¥è¯†ä»‹ç»](https://www.bilibili.com/read/cv15180540)

[2.æˆ‘åœ¨Bç«™å­¦äº‘åŸç”Ÿä¹‹Dockerå®¹å™¨ç¯å¢ƒå®‰è£…å®è·µ](https://www.bilibili.com/read/cv15181036)

[3.æˆ‘åœ¨Bç«™å­¦äº‘åŸç”Ÿä¹‹Dockerå®¹å™¨ä¸‰å¤§æ ¸å¿ƒæ¦‚å¿µä»‹ç»](https://www.bilibili.com/read/cv15181760)

[4.æˆ‘åœ¨Bç«™å­¦äº‘åŸç”Ÿä¹‹Dockerå®¹å™¨æ•°æ®æŒä¹…åŒ–ä»‹ç»ä¸å®è·µ](https://www.bilibili.com/read/cv15182308)

[5.æˆ‘åœ¨Bç«™å­¦äº‘åŸç”Ÿä¹‹Dockerå®¹å™¨ç½‘ç»œä»‹ç»ä¸å®è·µ](https://www.bilibili.com/read/cv15185166)

[6.æˆ‘åœ¨Bç«™å­¦äº‘åŸç”Ÿä¹‹Dockerå®¹å™¨Registryç§æœ‰é•œåƒä»“åº“æ­å»ºå®è·µ](https://www.bilibili.com/read/cv15219863)

[7.æˆ‘åœ¨Bç«™å­¦äº‘åŸç”Ÿä¹‹Dockerå®¹å™¨Dockerfileé•œåƒæ„å»ºæµ…æä¸å®è·µ](https://www.bilibili.com/read/cv15220707)

[8.æˆ‘åœ¨Bç«™å­¦äº‘åŸç”Ÿä¹‹Dockerå®¹å™¨é•œåƒæ„å»ºæœ€ä½³å®è·µæµ…æ](https://www.bilibili.com/read/cv15220861)

[9.æˆ‘åœ¨Bç«™å­¦äº‘åŸç”Ÿä¹‹Dockerå®¹å™¨ä¼˜åŒ–é•œåƒä½“ç§¯ç¼©å°æŠ€å·§å®è·µ](https://www.bilibili.com/read/cv15226873)

[10.æˆ‘åœ¨Bç«™å­¦äº‘åŸç”Ÿä¹‹Dockerå®¹å™¨æŠ€æœ¯è¿›é˜¶çŸ¥è¯†ä»‹ç»](https://www.bilibili.com/read/cv15227279)

[11.æˆ‘åœ¨Bç«™å­¦äº‘åŸç”Ÿä¹‹Dockerå®¹å™¨ç¼–æ’å·¥å…·docker-composeå®‰è£…ä½¿ç”¨å®è·µ](https://www.bilibili.com/read/cv15227639)

[12.æˆ‘åœ¨Bç«™å­¦äº‘åŸç”Ÿä¹‹Dockerå®¹å™¨åº•å±‚åŸç†æµ…æ](https://www.bilibili.com/read/cv15228563)

![](https://i0.hdslb.com/bfs/article/4adb9255ada5b97061e610b682b8636764fe50ed.png@progressive.webp)

> æ¬¢è¿å„ä½å¿—åŒé“åˆçš„æœ‹å‹ä¸€èµ·å­¦ä¹ äº¤æµï¼Œå¦‚æ–‡ç« æœ‰è¯¯è¯·åœ¨ä¸‹æ–¹ç•™ä¸‹æ‚¨å®è´µçš„ç»éªŒçŸ¥è¯†ï¼Œä¸ªäººé‚®ç®±åœ°å€ã€master#weiyigeek.topã€‘æˆ–è€…Â ä¸ªäººå…¬ä¼—å·ã€WeiyiGeekã€‘è”ç³»æˆ‘ã€‚

![](https://i0.hdslb.com/bfs/article/02db465212d3c374a43c60fa2625cc1caeaab796.png@progressive.webp)

æ›´å¤šæ–‡ç« æ¥æºäºã€WeiyiGeek Blog - ä¸ºäº†èƒ½åˆ°è¿œæ–¹ï¼Œè„šä¸‹çš„æ¯ä¸€æ­¥éƒ½ä¸èƒ½å°‘ã€‘ ä¸ªäººåšå®¢ã€‚

åšå®¢åœ°å€: https://weiyigeek.topÂ 

![](https://i0.hdslb.com/bfs/article/9a9cef9d789c08c7d7cb209475b46586777c9d26.png@942w_579h_progressive.webp)

ä¸“æ ä¹¦å†™ä¸æ˜“ï¼Œå¦‚æœæ‚¨è§‰å¾—è¿™ä¸ªä¸“æ è¿˜ä¸é”™çš„ï¼Œè¯·ç»™è¿™ç¯‡ä¸“æ ã€ç‚¹ä¸ªèµã€æŠ•ä¸ªå¸ã€æ”¶ä¸ªè—ã€å…³ä¸ªæ³¨ï¼Œè½¬ä¸ªå‘ã€‘ï¼Œè¿™å°†å¯¹æˆ‘çš„è‚¯å®šï¼Œè°¢è°¢ï¼ã€‚

-   echoÂ Â "ã€ç‚¹ä¸ªèµã€‘ï¼ŒåŠ¨åŠ¨ä½ é‚£ç²—å£®çš„æ‹‡æŒ‡æˆ–è€…èŠŠèŠŠç‰æ‰‹ï¼Œäº²ï¼"
    
-   printf("%s",Â "ã€æŠ•ä¸ªå¸ã€‘ï¼Œä¸‡æ°´åƒå±±æ€»æ˜¯æƒ…ï¼ŒæŠ•ä¸ªç¡¬å¸è¡Œä¸è¡Œï¼Œäº²ï¼")
    
-   fmt.Printf("ã€æ”¶ä¸ªè—ã€‘ï¼Œé˜…åå³ç„šä¸åƒç°ï¼Œäº²ï¼")Â Â 
    
-   System.out.println("ã€å…³ä¸ªæ³¨ã€‘ï¼Œåç»­æµè§ˆæŸ¥çœ‹ä¸è¿·è·¯å“Ÿï¼Œäº²ï¼")
    
-   console.info("ã€è½¬ä¸ªå‘ã€‘ï¼Œè®©æ›´å¤šçš„å¿—åŒé“åˆçš„æœ‹å‹ä¸€èµ·å­¦ä¹ äº¤æµï¼Œäº²ï¼")