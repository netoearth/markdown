GIF

![](https://i0.hdslb.com/bfs/article/4a10568f28aa362fc3ddc7f871b07daf847767da.gif@1s.webp)

å¸…å“¥ï¼ˆé“ä»”ï¼‰ã€ç¾å¥³ï¼Œç‚¹ä¸ªå…³æ³¨åç»­ä¸è¿·è·¯ï¼

**æœ¬ç« ç›®å½•**

![](https://i0.hdslb.com/bfs/article/4aa545dccf7de8d4a93c2b2b8e3265ac0a26d216.png@progressive.webp)

-   0x00 å‰è¨€ç®€è¿°
    
-   0x01 åŸºç¡€å®‰è£…
    

-   1) åŸºç¡€å‘½ä»¤
    
-   2) åŸºç¡€é…ç½®
    
-   3) ç”Ÿäº§å®ä¾‹
    

-   0x02 Registry ç›®å½•ç»“æ„
    
-   0x03 Registry API
    

-   API ä¸€è§ˆ
    
-   å®é™…ç¤ºä¾‹
    

-   0x04 Registry GC
    

-   Shell è„šæœ¬
    

-   0x05 é…ç½®æ–‡ä»¶è§£æ
    

-   config.yaml æ–‡ä»¶ä¸€è§ˆ
    

![](https://i0.hdslb.com/bfs/article/4aa545dccf7de8d4a93c2b2b8e3265ac0a26d216.png@progressive.webp)

æè¿°:æœ¬æ¥æˆ‘æƒ³ç›´æ¥å†™Harborçš„Dockeré•œåƒä»“åº“æ­å»ºé…ç½®ä¸ä½¿ç”¨ï¼Œä½†æ˜¯è§‰å¾—è¿˜æ˜¯åº”è¯¥ä»åŸºç¡€çš„Dockerçš„Registryé•œåƒè®²èµ·ä»å®‰å…¨æ„å»ºåˆ°GCå›æ”¶åŒæ—¶åŠ æ·±å­¦ä¹ æ˜ åƒ;

å®˜ç½‘ä»‹ç»:Registryæ˜¯ä¸€ä¸ªæ— çŠ¶æ€çš„ï¼Œé«˜åº¦å¯æ‰©å±•çš„æœåŠ¡å™¨ç«¯åº”ç”¨ç¨‹åºï¼Œå­˜å‚¨ï¼Œè®©ä½ åˆ†å‘å›¾åƒã€‚å®ƒæ˜¯å¼€æºçš„æ ¹æ®è®¸å¯Apacheè®¸å¯è¯ã€‚

æ­¤æ—¶å°±ä¸åœ¨è¯¦ç»†è®²è§£Registryçš„ä»‹ç»äº†ï¼Œæœ‰å…´è¶£çš„æœ‹å‹å¯ä»¥å‚è§å®˜ç½‘æ–‡æ¡£æˆ–è€…å‰é¢æˆ‘ç¬”è®°ä¸­çš„ä»‹ç»;  
ä»¥ä¸‹æ˜¯ä¸€äº›çŸ¥è¯†ç‚¹å¤ä¹ :

-   (1) Registryæ˜¯ä¸€ä¸ªå‡ ç§å­˜æ”¾imageå¹¶å¯¹å¤–æä¾›ä¸Šä¼ ä¸‹è½½ä»¥åŠä¸€ç³»åˆ—APIçš„æœåŠ¡,Registryä¸é•œåƒçš„å…³ç³»å¯ä»¥æƒ³è±¡æˆè‡ªå·±æœºå™¨ä¸Šçš„æºç å’Œè¿œç«¯SVNæˆ–è€…GitæœåŠ¡çš„å…³ç³»ï¼Œå¯ä»¥å¾ˆå®¹æ˜“å’Œæœ¬åœ°æºä»£ç ä»¥åŠè¿œç«¯GitæœåŠ¡çš„å…³ç³»ç›¸å¯¹åº”ã€‚
    
-   (2) Registryå¼€æºå¸¸ç”¨äºæ„å»ºç§æœ‰é•œåƒä»“åº“;
    

Q:ä¸ºä»€ä¹ˆä¸ç›´æ¥é‡‡ç”¨Dockerå®˜ç½‘Hubä½œä¸ºå­˜å‚¨é•œåƒçš„åœ°æ–¹?

> ç­”:æˆ‘è®¤ä¸ºä¸»è¦æ˜¯ä»¥ä¸‹å‡ ä¸ªæ–¹é¢çš„å½±å“  
> 1.å­˜å‚¨ç©ºé—´æœ‰é™  
> 2.ä¸Šä¼ /æ‹‰å–é€Ÿåº¦æœ‰é™  
> 3.ä¼ä¸šå†…éƒ¨æ•æ„Ÿå¼€å‘é¡¹ç›®(å¦‚æœæ˜¯æ‚¨è‚¯å®šä¸ä¼šä¸Šä¼ åˆ°åˆ«äººçš„æœåŠ¡å™¨ä¸­)  
> 4.å…è´¹å¼€æº

åä¹‹ä½¿ç”¨Registeyå¥½å¤„:

-   é•œåƒå­˜å‚¨ä½ç½®ç”±æ‚¨æŒæ¡
    
-   å…¨é¢ç®¡ç†æ§åˆ¶è‡ªå·±çš„é•œåƒ
    
-   é•œåƒå­˜å‚¨å’Œåˆ†é…ç´§å¯†é›†æˆåˆ°æ‚¨çš„å†…éƒ¨å¼€å‘æµç¨‹
    

Registry ç‰ˆæœ¬è¯´æ˜:

-   Docker Registry 1.0ç‰ˆæœ¬(hub/docker.ioç­‰å…¬å…±çš„é•œåƒä»“åº“è¿˜æ”¯æŒï¼Œå®‰å…¨æ€§ä»¥åŠå…¼å®¹æ€§ä¸å¦‚V2.0)
    
-   Docker Registry 2.0ç‰ˆæœ¬åœ¨å®‰å…¨æ€§å’Œæ€§èƒ½ä¸Šåšäº†è¯¸å¤šä¼˜åŒ–ï¼Œå¹¶é‡æ–°è®¾è®¡äº†é•œåƒçš„å­˜å‚¨çš„æ ¼å¼;(`Dockerç›®å‰1.6ä¹‹åæ”¯æŒV2`)
    

åè¯è§£é‡Š:

-   1.repository name(å­˜å‚¨åº“åè¯) å­˜å‚¨åº“æŒ‡åœ¨åº“ä¸­å­˜å‚¨çš„é•œåƒã€‚`/project/redis:latest`
    

-   ç»å…¸å­˜å‚¨åº“åç§°ç”±2çº§è·¯å¾„æ„æˆï¼Œæ¯çº§è·¯å¾„å°äº30ä¸ªå­—ç¬¦ï¼ŒV2çš„apiä¸å¼ºåˆ¶è¦æ±‚è¿™æ ·çš„æ ¼å¼ã€‚
    
-   æ¯çº§è·¯å¾„åè‡³å°‘æœ‰ä¸€ä¸ªå°å†™å­—æ¯æˆ–è€…æ•°å­—ï¼Œä½¿ç”¨å¥å·ï¼Œç ´æŠ˜å·å’Œä¸‹åˆ’çº¿åˆ†å‰²ã€‚æ›´ä¸¥æ ¼æ¥è¯´ï¼Œå®ƒå¿…é¡»ç¬¦åˆæ­£åˆ™è¡¨è¾¾å¼ï¼š`[a-z0-9]+[._-][a-z0-9]+)`
    
-   å¤šçº§è·¯å¾„ç”¨/åˆ†éš”
    
-   å­˜å‚¨åº“åç§°æ€»é•¿åº¦ï¼ˆåŒ…æ‹¬/ï¼‰ä¸èƒ½è¶…è¿‡256ä¸ªå­—ç¬¦
    

-   2.digest(æ‘˜è¦) æ‘˜è¦æ˜¯é•œåƒæ¯ä¸ªå±‚çš„å”¯ä¸€æ ‡ç¤ºã€‚è™½ç„¶ç®—æ³•å…è®¸ä½¿ç”¨ä»»æ„ç®—æ³•ï¼Œä½†æ˜¯ä¸ºäº†å…¼å®¹æ€§åº”è¯¥ä½¿ç”¨sha256ã€‚
    

```
ä¾‹å¦‚ - sha256:6c3c624b58dbbcd3c0dd82b4c53f04194d1247c6eebdaab7c610cf7d66709b3b
# ç”¨ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œåœ¨ä¼ªä»£ç æ¥æ¼”ç¤ºæ‘˜è¦è®¡ç®—
let C = 'a small string'
let B = sha256(C)
let D = 'sha256:' + EncodeHex(B)
let ID(C) = D

# pythonä¼ªä»£ç 
import hashlib
C = 'a small string'
B = hashlib.sha256(C)
D = 'sha256:' + B.hexdigest()
```

**æµ‹è¯•ç¯å¢ƒ:**

```
# OS
CentOS Linux release 7.8.2003 (Core)

# Linux
Server Version: 19.03.9
Storage Driver: overlay2
```

åŸºç¡€å®ä¾‹:

```
# 1.Start your registry
docker run -d -p 5000:5000 --restart=always --name registry registry:2

# 2.æ‹‰å–é•œåƒå¹¶ä¿®æ”¹
docker pull ubuntu
docker run --name ubuntu-test -d ubuntu 
docker commit -a "Weiyigeek" -m "é•œåƒæè¿°" ubuntu-test ubuntu-custom:1.0

# 3.Tag the image so that it points to your registry
docker image tag ubuntu-custom:1.0 127.0.0.1:5000/ubuntu-custom:1.0

# 4.ä»é•œåƒä»“å‚¨ä¸Šä¼ ä¸ä¸‹è½½é•œåƒ
docker push localhost:5000/ubuntu-custom:1.0
docker pull localhost:5000/ubuntu-custom:1.0

# 5.åˆ é™¤æœ¬åœ°/è¿œç¨‹çš„ubuntu-custom:1.0
docker image remove ubuntu-custom:1.0
docker image remove localhost:5000/ubuntu-custom:1.0

# 6.registryä»“åº“åˆ é™¤ä¸æ¸…é™¤å·;
docker container stop registry && docker container rm -v registry
```

Registry é•œåƒç¯å¢ƒå˜é‡:

```
# Environment variable
# è‡ªå®šä¹‰Registryä»“åº“é•œåƒå­˜æ”¾çš„ç‰©ç†åœ°å€
REGISTRY_STORAGE_FILESYSTEM_ROOTDIRECTORY=/var/lib/registry
# å¯ç”¨DELETEæ“ä½œå¦åˆ™ä¸èƒ½æ‰§è¡Œ -X DELETE
REGISTRY_STORAGE_DELETE_ENABLED=true

# ç»‘å®šRegistryåœ°å€ä¸ç«¯å£
REGISTRY_HTTP_ADDR=0.0.0.0:5000

# è¯ä¹¦Certificateè®¾ç½®
REGISTRY_HTTP_TLS_CERTIFICATE=/certs/domain.crt
REGISTRY_HTTP_TLS_KEY=/certs/domain.key

# æœ¬åœ°åŸºç¡€è®¤è¯
REGISTRY_AUTH=htpasswd
REGISTRY_AUTH_HTPASSWD_REALM=Registry Realm
REGISTRY_AUTH_HTPASSWD_PATH=/auth/htpasswd
```

æŒ‡å®šç¯å¢ƒå˜é‡è¿è¡ŒRegistryä»“åº“:

```
# (1) docker run æ—¶æŒ‡å®šç¯å¢ƒå˜é‡
$ docker run -d \
 Â --restart=always \
 Â --name registry \
 Â -v "$(pwd)"/auth:/auth \
 Â -v /opt/docker/registry:/var/lib/registry \
 Â -v "$(pwd)"/certs:/certs \
 Â -e REGISTRY_HTTP_ADDR=0.0.0.0:443 \
 Â -e REGISTRY_HTTP_TLS_CERTIFICATE=/certs/domain.crt \
 Â -e REGISTRY_HTTP_TLS_KEY=/certs/domain.key \
 Â -e REGISTRY_STORAGE_DELETE_ENABLED=true \
 Â -p 443:443 \
 Â registry:2
  
  # (2) Yaml é…ç½®
docker run -d -p 5000:5000 --restart=always --name registry \
  -v `pwd`/config.yml:/etc/docker/registry/config.yml \
  registry:2

# ä¾‹å¦‚:å¼€å‘é…ç½®çš„config.yaml
version: 0.1
log:
  level: debug
storage:
  filesystem:
    rootdirectory: /var/lib/registry
http:
  addr: localhost:5000
  host: https://registry.weiyigeek.top:5000
  secret: asecretforlocaldevelopment
  debug:
    addr: localhost:5001

auth:
  htpasswd:
    realm: basic-realm
    path: /path/to/htpasswd
```

å‚è€ƒåœ°å€:https://github.com/docker/distribution/blob/master/cmd/registry/config-example.yml

```
# (3) docker-compose æ„å»ºé•œåƒä»“åº“
# docker-compose.yml 
registry:
  restart: always
  image: registry:2
  ports:
    - 5000:5000
  environment:
    REGISTRY_HTTP_TLS_CERTIFICATE: /certs/domain.crt
    REGISTRY_HTTP_TLS_KEY: /certs/domain.key
    REGISTRY_AUTH: htpasswd
    REGISTRY_AUTH_HTPASSWD_PATH: /auth/htpasswd
    REGISTRY_AUTH_HTPASSWD_REALM: Registry Realm
    REGISTRY_STORAGE_DELETE_ENABLED=true
  volumes:
    - /opt/docker/registry:/var/lib/registry
    - /opt/docker/certs:/certs
    - /opt/docker/auth:/auth
```

æè¿°:æ­¤å¤„ä»¥å®é™…ç”Ÿäº§ç¯å¢ƒä¸ºä¾‹è¿›è¡Œ`Docker Registry`ç§æœ‰ä»“åº“æ­å»º;

3.1) æœåŠ¡å™¨æ‹‰å–Docker Registryé•œåƒå¹¶åˆ›å»ºAuthoè®¤è¯çš„.htpasswdæ–‡ä»¶;

```
$ docker pull registry:2
# Digest: sha256:8be26f81ffea54106bae012c6f349df70f4d5e7e2ec01b143c46e2c03b9e551d
# Status: Downloaded newer image for registry:2
# docker.io/library/registry:2

$ mkdir -vp /opt/registry/ && cd $_
htpasswd -Bbn weiyigeek 123456                  # -n ä¸æ›´æ–°æ–‡ä»¶è¾“å…¥åˆ°ç»ˆç«¯æ ‡å‡†è¾“å‡º
htpasswd -bB -c auth.htpasswd weiyigeek 123456  # -c åˆ›å»ºå­˜å‚¨è®¤è¯å­—ç¬¦ä¸²ï¼Œ-b å¼ºåˆ¶åŠ å¯†å¯†ç ï¼Œ-B åœ¨å‘½ä»¤è¡Œä¸­æ¥æ”¶å¯†ç 
```

Tips:åœ¨Pushæˆ–è€…Deleteé•œåƒæ˜¯é€šè¿‡HTTPè¯·æ±‚Registryçš„APIå®Œæˆçš„ï¼Œæ¯ä¸ªè¯·æ±‚éƒ½éœ€è¦ä¸€ä¸ªTokenæ‰èƒ½å®Œæˆæ“ä½œï¼Œè€Œæ­¤Tokenéœ€è¦ä½¿ç”¨authæ–‡ä»¶(`æ˜æ–‡ç”¨æˆ·/å¯†ç ç¼–ç `)æ¥è¿›è¡Œé‰´æƒ;

3.2) Docker Registry è‡ªç­¾è¯ä¹¦  
æè¿°:å¦‚æœRegistryä»“åº“ä½¿ç”¨TLSè®¤è¯æ—¶å¿…é¡»å¸¦æœ‰è¯ä¹¦ï¼Œå½“å¤–éƒ¨è®¿é—®è¯¥Registryä»“åº“æ—¶å€™æä¾›å®‰å…¨é€šé“ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è®¤è¯æœºæ„è´­ä¹°ç­¾åè¯ä¹¦æˆ–è€…è‡ªç­¾è¯ä¹¦ä¹Ÿå¯ä»¥;  
ä½¿ç”¨ OpenSSL æ¥ç”Ÿæˆ CA ï¼ˆè¯ä¹¦æˆæƒä¸­å¿ƒï¼Œcertificate authorityï¼‰ã€ ä¸­çº§ CAï¼ˆintermediate CAï¼‰ å’Œæœ«ç«¯è¯ä¹¦ï¼ˆend certificateï¼‰ã€‚åŒ…æ‹¬ OCSPã€CRL å’Œ CAé¢å‘è€…Issuerä¿¡æ¯ã€å…·ä½“é¢å‘å’Œå¤±æ•ˆæ—¥æœŸã€‚

```
# æ–¹å¼1:äº¤äº’å¼è¯ä¹¦ç”Ÿæˆ
$openssl req -newkey rsa:4096 -nodes -sha256 -keyout ./certs/domain.key -x509 -days 365 -out ./certs/domain.crt

# æ–¹å¼2:é…ç½®æ–‡ä»¶æ–¹å¼ç”Ÿæˆ
cat >ca.conf <<EOF
[ req ]
default_bits  = 2048
distinguished_name = req_distinguished_name
prompt   = no
encrypt_key  = no
x509_extensions  = v3_ca
[ req_distinguished_name ]
CN = localhost
[ CA_default ]
copy_extensions = copy
[ alternate_names ]
DNS.2=localhost
[ v3_ca ]
subjectAltName=@alternate_names
subjectKeyIdentifier=hash
authorityKeyIdentifier=keyid:always,issuer:always
basicConstraints = critical,CA:true
keyUsage=keyCertSign,cRLSign,digitalSignature,keyEncipherment,nonRepudiation
EOF
openssl req -days 365 -x509 -config ca.conf -new -keyout certs/domain.key -out certs/domain.crt
```

3.3) æŒ‚è½½å®‰å…¨è®¤è¯ä¸è‡ªç­¾è¯ä¹¦å¹¶å¯åŠ¨registryå®¹å™¨

```
docker run -d -p 0.0.0.0:8443:5000 --name registry-net \
    -v /var/lib/registry-net:/var/lib/registry \
    -v /opt/registry/certs:/certs \
    -v /opt/registry/auth.htpasswd:/etc/docker/registry/auth.htpasswd \
    -e REGISTRY_AUTH="{htpasswd: {realm: localhost, path: /etc/docker/registry/auth.htpasswd}}" \
    -e REGISTRY_HTTP_ADDR=0.0.0.0:5000 \
    -e REGISTRY_HTTP_TLS_CERTIFICATE=/certs/domain.crt \
    -e REGISTRY_HTTP_TLS_KEY=/certs/domain.key \
    -e REGISTRY_STORAGE_DELETE_ENABLED=true \
    registry

# æŸ¥çœ‹å®¹å™¨(åªèƒ½æœ¬åœ°è®¿é—®)
$docker ps
CONTAINER ID        IMAGE               COMMAND                  CREATED              STATUS              PORTS                     NAMES
86bc983e8183        registry            "/entrypoint.sh /etcâ€¦"   About a minute ago   Up About a minute   127.0.0.1:443->5000/tcp   registry
```

3.4) éªŒè¯registryæ˜¯å¦å¯ç™»å½•ï¼Œç™»å½•åè´¦å·å¯†ç å°†ä¼šbase64å­˜å‚¨åœ¨ /root/.docker/config.json ä¹‹ä¸­ï¼Œä¸ºåç»­ä½¿ç”¨skopeoçš„æ—¶å€™åšå‡†å¤‡;

```
$docker login localhost -u weiyigeek -p 123456
# WARNING! Using --password via the CLI is insecure. Use --password-stdin.
# WARNING! Your password will be stored unencrypted in /root/.docker/config.json.
Login Succeeded

cat /root/.docker/config.json
{
  "auths": {
    "https://index.docker.io/v1/": { "auth": "d2VpxOQ=="},
    "localhost": {"auth": "d2VpeWlnZWVrOjEyMzQ1Ng==" }
  },
  "HttpHeaders": {"User-Agent": "Docker-Client/19.03.9 (linux)"}
}

# base64 ç¼–ç 
$echo "d2VpeWlnZWVrOjEyMzQ1Ng==" | base64 -d
weiyigeek:123456[
```

3.5) ä¸Šä¼ ä¸€ä¸ªé•œåƒåˆ°registryä¹‹ä¸­

```
$docker tag alpine localhost/alpine:latest
$docker images
localhost/alpine    latest              a24bb4013296        2 months ago        5.57MB
$docker push localhost/alpine:latest
# The push refers to repository [localhost/alpine]
# 50644c29ef5a: Pushed
# latest: digest: sha256:a15790640a6690aa1730c38cf0a440e2aa44aaca9b0e8931a9f2b0d7cc90fd65 size: 528
```

3.6)registry æŸ¥çœ‹ä¸Šä¼ çš„é•œåƒ

```
# (1) æŸ¥çœ‹registryä¸­å­˜å‚¨çš„é•œåƒä»“åº“åç§° (æ³¨æ„--cacertå‚æ•°å¦‚æœè¯ä¹¦æœªå¯¼å…¥åˆ°ç³»ç»Ÿä¸­åˆ™å¿…é¡»åŠ ä¸Š)
$curl --cacert /opt/registry/certs/domain.crt -u 'weiyigeek:123456' -X GET https://localhost/v2/_catalog
{"repositories":["alpine"]}
```

3.7) åˆ©ç”¨skopeoè½¬å‚¨é•œåƒåˆ°registryä¹‹ä¸­å’Œæ“ä½œé•œåƒ:

```
# (1) é¦–å…ˆä¿¡ä»»CAè¯ä¹¦ï¼Œæ ¹æ®ä¸åŒçš„å‘è¡Œç‰ˆé€‰æ‹©ç›¸åº”çš„è·¯å¾„å’Œå‘½ä»¤è¡Œå³å¯ï¼Œä¸ºåé¢skopeoå‘½ä»¤ä½¿ç”¨åšå‡†å¤‡ã€‚
# CentOS
update-ca-trust force-enable
cp certs/domain.crt /etc/pki/ca-trust/source/anchors/localhost.crt
update-ca-trust
# Ubuntu
cp certs/domain.crt /usr/local/share/ca-certificates/localhost.crt
$ update-ca-certificates
# Debian
cp certs/domain.crt /usr/share/ca-certificates/localhost.crt
echo localhost.crt >> /etc/ca-certificates.conf
update-ca-certificates

# (2) COPY é•œåƒåˆ° registry
skopeo inspect docker://docker.io/alpine
# ä»¥ localhost/library/alpine:3.10 ä¸ºä¾‹
# localhost   å°±æ˜¯è¯¥ registry çš„åŸŸåæˆ–è€… URL 
# library     å°±æ˜¯é¡¹ç›®åç§° project
# alpine:3.12 å°±æ˜¯é•œåƒåå’Œé•œåƒçš„ tag
skopeo copy docker://alpine:3.12 docker://localhost/library/alpine:3.12
# Getting image source signatures
# Copying blob df20fa9351a1 done
# Copying config a24bb40132 done
# Writing manifest to image destination
# Storing signatures

# (3) åˆ é™¤registryä»“åº“ä¸­çš„é•œåƒ(åˆ é™¤åå¹¶ä¸å½»åº•)
skopeo delete docker://localhost/alpine

# (4) æŸ¥çœ‹ä»“åº“é‡Œçš„é•œåƒ
curl --cacert /opt/registry/certs/domain.crt -u 'weiyigeek:123456' -X GET https://localhost/v2/_catalog
{"repositories":["library/alpine"]}
skopeo inspect docker://localhost/library/alpine:3.12
{
    "Name": "localhost/library/alpine",
    "Digest": "sha256:a15790640a6690aa1730c38cf0a440e2aa44aaca9b0e8931a9f2b0d7cc90fd65",
    "RepoTags": ["3.12"],
    "Created": "2020-05-29T21:19:46.363518345Z",
    "DockerVersion": "18.09.7",
    "Labels": null,
    "Architecture": "amd64",
    "Os": "linux",
    "Layers": ["sha256:df20fa9351a15782c64e6dddb2d4a6f50bf6d3688060a34c4014b0d9a752eb4c"],
    "Env": ["PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"]
}
```

æ³¨æ„äº‹é¡¹:

-   1.è¯ä¹¦é¢å‘è€…å¯ä»¥ç”¨ä¸­é—´è¯ä¹¦æä¾›ç»™æ‚¨ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½ å¿…é¡»ç”¨ä¸­é—´è¯ä¹¦ä¸²è¿æ‚¨çš„è¯ä¹¦å½¢æˆçš„è¯ä¹¦æ†ç»‘ã€‚
    

```
cat domain.crt intermediate-certificates.pem > certs/domain.crt
```

-   2.Letâ€™s Encrypt:https://letsencrypt.org/how-it-works/
    

æè¿°: æ­¤æ—¶ä»¥ä¸Šä¼ çš„library/alpine:3.12é•œåƒä¸ºä¾‹æŸ¥çœ‹registryç›®å½•ä¸­æ–‡ä»¶å˜åŒ–;

registry ä»“åº“ç»“æ„ç›®å½•å¦‚ä¸‹:

```
# registry æŒä¹…åŒ–ä½ç½®
$ls /var/lib/registry/docker/registry/v2/
blobs  repositories

# registry æ ‘å½¢ç»“æ„
tree -h /var/lib/registry/docker/registry/v2/
/var/lib/registry/docker/registry/v2/
â”œâ”€â”€ [  20]  blobs
â”‚   â””â”€â”€ [  36]  sha256
â”‚       â”œâ”€â”€ [  78]  a1
â”‚       â”‚   â””â”€â”€ [  18]  a15790640a6690aa1730c38cf0a440e2aa44aaca9b0e8931a9f2b0d7cc90fd65  # é•œåƒdata manifest (å­˜å‚¨äº†data configä¸data layer çš„ Digestæ‘˜è¦ä¿¡æ¯)
â”‚       â”‚       â””â”€â”€ [ 528]  data
â”‚       â”œâ”€â”€ [  78]  a2
â”‚       â”‚   â””â”€â”€ [  18]  a24bb4013296f61e89ba57005a7b3e52274d8edd3ae2077d04395f806b63d83e  # é•œåƒdata config
â”‚       â”‚       â””â”€â”€ [1.5K]  data #  "mediaType": "application/vnd.docker.container.image.v1+json",
â”‚       â””â”€â”€ [  78]  df
â”‚           â””â”€â”€ [  18]  df20fa9351a15782c64e6dddb2d4a6f50bf6d3688060a34c4014b0d9a752eb4c  # é•œåƒdata layer (é€šå¸¸ä½“ç§¯æœ€å¤§)
â”‚               â””â”€â”€ [2.7M]  data # "mediaType": "application/vnd.docker.image.rootfs.diff.tar.gzip",
â””â”€â”€ [  21]  repositories
    â””â”€â”€ [  20]  library
        â””â”€â”€ [  55]  alpine
            â”œâ”€â”€ [  20]  _layers
            â”‚   â””â”€â”€ [ 150]  sha256
            â”‚       â”œâ”€â”€ [  18]  a24bb4013296f61e89ba57005a7b3e52274d8edd3ae2077d04395f806b63d83e   # æŒ‡å‘ > blobs/sha256/a24bb401......6b63d83e
            â”‚       â”‚   â””â”€â”€ [  71]  link
            â”‚       â””â”€â”€ [  18]  df20fa9351a15782c64e6dddb2d4a6f50bf6d3688060a34c4014b0d9a752eb4c   # æŒ‡å‘ > blobs/sha256/df20fa9.......9a752eb4c
            â”‚           â””â”€â”€ [  71]  link
            â”œâ”€â”€ [  35]  _manifests
            â”‚   â”œâ”€â”€ [  20]  revisions  # ä¿®è®¢è®°å½•
            â”‚   â”‚   â””â”€â”€ [  78]  sha256  
            â”‚   â”‚       â””â”€â”€ [  18]  a15790640a6690aa1730c38cf0a440e2aa44aaca9b0e8931a9f2b0d7cc90fd65  # ä¿®è®¢æŒ‡å‘ manifest  >  blobs/sha256/a15790640......c90fd65
            â”‚   â”‚           â””â”€â”€ [  71]  link
            â”‚   â””â”€â”€ [  18]  tags
            â”‚       â””â”€â”€ [  34]  3.12
            â”‚           â”œâ”€â”€ [  18]  current
            â”‚           â”‚   â””â”€â”€ [  71]  link  # æŒ‡å‘ blobs ä¸­ data manifest digest a15790640a6690aa1730c38cf0a440e2aa44aaca9b0e8931a9f2b0d7cc90fd65
            â”‚           â””â”€â”€ [  20]  index
            â”‚               â””â”€â”€ [  78]  sha256
            â”‚                   â””â”€â”€ [  18]  a15790640a6690aa1730c38cf0a440e2aa44aaca9b0e8931a9f2b0d7cc90fd65 
            â”‚                       â””â”€â”€ [  71]  link  # åŒä¸Š
            â””â”€â”€ [   6]  _uploads  # é•œåƒä¸Šä¼ è¿‡ç¨‹ä¸­çš„ä¸´æ—¶ç›®å½•
26 directories, 8 files
```

Q: é‚£ registry å­˜å‚¨ç›®å½•åˆ°åº•é•¿ä»€ä¹ˆæ ·? ğŸ¤”

> ç­”: ç»“åˆä¸‹é¢è¿™å¼ å›¾å¯ä»¥çœ‹è§ï¼Œregistry å­˜å‚¨ç›®å½•ä¸‹åªæœ‰ä¸¤ç§æ–‡ä»¶åçš„æ–‡ä»¶`å³dataä¸linkæ–‡ä»¶`  
> (1) link æ–‡ä»¶: æ˜¯æ™®é€šçš„æ–‡æœ¬æ–‡ä»¶å­˜æ”¾åœ¨ repositories ç›®å½•ä¸‹ï¼Œå…¶å†…å®¹æ˜¯æŒ‡å‘ data æ–‡ä»¶çš„ sha256 digestå€¼, ä»å­—é¢æ„ä¹‰ä¸Šå°±å¾ˆå¥½ç†è§£å®ƒ;  
> (2) data æ–‡ä»¶: å­˜æ”¾åœ¨ blobs ç›®å½•ä¸‹æ–‡ä»¶ä¸”åˆ†ä¸ºä¸‰ä¸ªæ–‡ä»¶(å³é•œåƒçš„`layer/config/manifest`ç­‰æ–‡ä»¶)

```
# (1) Repositories
$ls /var/lib/registry/docker/registry/v2/repositories/alpine/
_layers  _manifests  _uploads
# - _layers/sha256 ç›®å½•ä¸‹çš„æ–‡ä»¶å¤¹åæ˜¯é•œåƒçš„Layerå’ŒConfigçš„Digest,é€šè¯¥ç›®å½•ä¸‹çš„linkæ–‡ä»¶æ‰¾åˆ°å¯¹åº” blobs ç›®å½•ä¸‹çš„ data æ–‡ä»¶,å®é™…ä¸Šå½“æˆ‘ä»¬ pull ä¸€ä¸ªé•œåƒçš„ layer æ—¶ï¼Œæ˜¯é€šè¿‡ link æ–‡ä»¶æ‰¾åˆ° layer åœ¨ registry ä¸­å®é™…çš„å­˜å‚¨ä½ç½®çš„ã€‚
# - _manifests æ–‡ä»¶å¤¹ä¸‹çš„ tags å’Œ revisions ç›®å½•ä¸‹çš„ link æ–‡ä»¶åˆ™æŒ‡å‘è¯¥é•œåƒçš„ manifest æ–‡ä»¶ï¼Œä¿å­˜åœ¨æ‰€æœ‰å†å²é•œåƒtagçš„manifestæ–‡ä»¶çš„linkã€‚å½“åˆ é™¤ä¸€ä¸ªé•œåƒæ—¶ï¼Œåªä¼šåˆ é™¤è¯¥é•œåƒæœ€æ–°çš„ tag çš„ link æ–‡ä»¶ã€‚
  # - revisions ç›®å½•è®°å½•äº†é•œåƒä¿®è®¢ç‰ˆæœ¬
  $ls /var/lib/registry/docker/registry/v2/repositories/alpine(é•œåƒåç§°)/_manifests/revisions/sha256/
  a15790640a6690aa1730c38cf0a440e2aa44aaca9b0e8931a9f2b0d7cc90fd65
  # - tags ç›®å½•ä¸‹çš„æ–‡ä»¶å¤¹åä¾‹å¦‚3.10å°±æ˜¯é•œåƒçš„Tag,åœ¨å®ƒçš„å­ç›®å½•ä¸‹çš„ current/link æ–‡ä»¶åˆ™è®°å½•äº†å½“å‰ tag æŒ‡å‘çš„ manifest æ–‡ä»¶çš„ä½ç½®;
    # æ¯”å¦‚æˆ‘ä»¬çš„ alpine:latest é•œåƒï¼Œæ¯æ¬¡ push æ–°çš„ latest é•œåƒæ—¶current/link éƒ½ä¼šæ›´æ–°æˆæŒ‡å‘æœ€æ–°é•œåƒçš„ manifest æ–‡ä»¶ã€‚
  $ ls /var/lib/registry/docker/registry/v2/repositories/alpine(é•œåƒåç§°)/_manifests/tags/3.12(é•œåƒæ ‡è®°)/
  current  index  # ç›®å‰éƒ½æŒ‡å‘ a15790640a6690aa1730c38cf0a440e2aa44aaca9b0e8931a9f2b0d7cc90fd65 å³ é•œåƒ data manifest


# (2) Blobs
$ls /var/lib/registry/docker/registry/v2/blobs/sha256/
a1/ a2/ df/ 

$find /var/lib/registry/docker/registry/v2/ -name "data" -exec ls -sh {} \;
# image layer æ–‡ä»¶æ˜¯ gzip æ ¼å¼çš„ tar åŒ…ï¼Œæ˜¯é•œåƒå±‚çœŸå®å†…å®¹çš„ tar.gzip æ ¼å¼å­˜å‚¨å½¢å¼ã€‚
2.7M ./blobs/sha256/df/df20fa9351a15782c64e6dddb2d4a6f50bf6d3688060a34c4014b0d9a752eb4c/data

# image config æ–‡ä»¶æ˜¯ json æ ¼å¼çš„ï¼Œå®ƒæ˜¯åœ¨æ„å»ºæ—¶å€™ç”Ÿæˆçš„æ ¹æ®DockerFileå’Œå®¿ä¸»æœºçš„ä¸€äº›ä¿¡æ¯; ï¼ˆè®°å½•äº†"rootfs"."diff_ids"ï¼‰
4.0K ./blobs/sha256/a2/a24bb4013296f61e89ba57005a7b3e52274d8edd3ae2077d04395f806b63d83e/data

# image manifest æ–‡ä»¶json æ–‡ä»¶æ ¼å¼çš„ï¼Œå­˜æ”¾è¯¥é•œåƒ layer å’Œ image config æ–‡ä»¶çš„ç´¢å¼•ã€‚(é•œåƒæ‹‰å–é¦–å…ˆéœ€æ‹‰å–æ­¤æ–‡ä»¶)
4.0K ./blobs/sha256/a1/a15790640a6690aa1730c38cf0a440e2aa44aaca9b0e8931a9f2b0d7cc90fd65/data
```

![WeiyiGeek.registryå­˜å‚¨ç»“æ„](https://i0.hdslb.com/bfs/article/cb8da1fdb4418cc8fbccbae2bb3591491e9b9ee0.png@942w_563h_progressive.webp)

æ­¤æ—¶æˆ‘ä»¬å¯ä»¥å†å¾€Registryä¸­COPYä¸€ä¸ªé•œåƒæ–¹ä¾¿åé¢è¿›è¡Œå¯¹æ¯”åˆ†æ:

```
$skopeo copy docker://debian:buster-slim docker://localhost/library/debian:buster-slim
$curl --cacert /opt/registry/certs/domain.crt -u 'weiyigeek:123456' -X GET https://localhost/v2/_catalog
{"repositories":["library/alpine","library/debian"]}

# å¯¹æ¯”åˆ†æ registry ä¸­ alpine:3.12 å’Œ debian:buster-slim ä¸¤ä¸ªåŸºç¡€é•œåƒï¼Œæ­¤æ—¶åœ¨registry å­˜å‚¨ç›®å½•çš„ç»“æ„å¦‚ä¸‹:
$tree -h /var/lib/registry/docker/registry/v2/
/var/lib/registry/docker/registry/v2/
â”œâ”€â”€ [  20]  blobs
â”‚   â””â”€â”€ [  66]  sha256
â”‚       â”œâ”€â”€ [  78]  a1
â”‚       â”‚   â””â”€â”€ [  18]  a15790640a6690aa1730c38cf0a440e2aa44aaca9b0e8931a9f2b0d7cc90fd65
â”‚       â”‚       â””â”€â”€ [ 528]  data
â”‚       â”œâ”€â”€ [  78]  a2
â”‚       â”‚   â””â”€â”€ [  18]  a24bb4013296f61e89ba57005a7b3e52274d8edd3ae2077d04395f806b63d83e
â”‚       â”‚       â””â”€â”€ [1.5K]  data
â”‚       â”œâ”€â”€ [  78]  bf
â”‚       â”‚   â””â”€â”€ [  18]  bf59529304463f62efa7179fa1a32718a611528cc4ce9f30c0d1bbc6724ec3fb  # debian:buster-slim çš„ Data Layer
â”‚       â”‚       â””â”€â”€ [ 26M]  data
â”‚       â”œâ”€â”€ [  78]  c7
â”‚       â”‚   â””â”€â”€ [  18]  c7346dd7f20ef06fd3c58446fab0c3edf22e78131d374775f5f947849537b773  # debian:buster-slim çš„ Data Config
â”‚       â”‚       â””â”€â”€ [1.5K]  data
â”‚       â”œâ”€â”€ [  78]  df
â”‚       â”‚   â””â”€â”€ [  18]  df20fa9351a15782c64e6dddb2d4a6f50bf6d3688060a34c4014b0d9a752eb4c
â”‚       â”‚       â””â”€â”€ [2.7M]  data
â”‚       â””â”€â”€ [  78]  e0
â”‚           â””â”€â”€ [  18]  e0a33348ac8cace6b4294885e6e0bb57ecdfe4b6e415f1a7f4c5da5fe3116e02  # debian:buster-slim çš„ Data Manifest
â”‚               â””â”€â”€ [ 529]  data
â””â”€â”€ [  21]  repositories
    â””â”€â”€ [  34]  library
        â”œâ”€â”€ [  55]  alpine  # æ­¤å¤„ä¸åšè¿‡å¤šè¯´æ˜
        â”‚   â”œâ”€â”€ [  20]  _layers
        â”‚   â”‚   â””â”€â”€ [ 150]  sha256
        â”‚   â”‚       â”œâ”€â”€ [  18]  a24bb4013296f61e89ba57005a7b3e52274d8edd3ae2077d04395f806b63d83e
        â”‚   â”‚       â”‚   â””â”€â”€ [  71]  link
        â”‚   â”‚       â””â”€â”€ [  18]  df20fa9351a15782c64e6dddb2d4a6f50bf6d3688060a34c4014b0d9a752eb4c
        â”‚   â”‚           â””â”€â”€ [  71]  link
        â”‚   â”œâ”€â”€ [  35]  _manifests
        â”‚   â”‚   â”œâ”€â”€ [  20]  revisions
        â”‚   â”‚   â”‚   â””â”€â”€ [  78]  sha256
        â”‚   â”‚   â”‚       â””â”€â”€ [  18]  a15790640a6690aa1730c38cf0a440e2aa44aaca9b0e8931a9f2b0d7cc90fd65
        â”‚   â”‚   â”‚           â””â”€â”€ [  71]  link
        â”‚   â”‚   â””â”€â”€ [  18]  tags
        â”‚   â”‚       â””â”€â”€ [  34]  3.12
        â”‚   â”‚           â”œâ”€â”€ [  18]  current
        â”‚   â”‚           â”‚   â””â”€â”€ [  71]  link
        â”‚   â”‚           â””â”€â”€ [  20]  index
        â”‚   â”‚               â””â”€â”€ [  78]  sha256
        â”‚   â”‚                   â””â”€â”€ [  18]  a15790640a6690aa1730c38cf0a440e2aa44aaca9b0e8931a9f2b0d7cc90fd65
        â”‚   â”‚                       â””â”€â”€ [  71]  link
        â”‚   â””â”€â”€ [   6]  _uploads
        â””â”€â”€ [  55]  debian
            â”œâ”€â”€ [  20]  _layers
            â”‚   â””â”€â”€ [ 150]  sha256
            â”‚       â”œâ”€â”€ [  18]  bf59529304463f62efa7179fa1a32718a611528cc4ce9f30c0d1bbc6724ec3fb
            â”‚       â”‚   â””â”€â”€ [  71]  link  # æ‘˜è¦æŒ‡å‘ blobs ä¸­debian:buster-slim çš„ Data Layer 
            â”‚       â””â”€â”€ [  18]  c7346dd7f20ef06fd3c58446fab0c3edf22e78131d374775f5f947849537b773
            â”‚           â””â”€â”€ [  71]  link  # æ‘˜è¦æŒ‡å‘ blobs ä¸­debian:buster-slim çš„ Data Config
            â”œâ”€â”€ [  35]  _manifests
            â”‚   â”œâ”€â”€ [  20]  revisions
            â”‚   â”‚   â””â”€â”€ [  78]  sha256
            â”‚   â”‚       â””â”€â”€ [  18]  e0a33348ac8cace6b4294885e6e0bb57ecdfe4b6e415f1a7f4c5da5fe3116e02
            â”‚   â”‚           â””â”€â”€ [  71]  link # æ‘˜è¦æŒ‡å‘ blobs ä¸­ debian:buster-slim çš„ Data Manifest
            â”‚   â””â”€â”€ [  25]  tags
            â”‚       â””â”€â”€ [  34]  buster-slim # ä»¥ä¸‹æ‘˜è¦éƒ½æ˜¯æŒ‡å‘ blobs ä¸­ debian:buster-slim çš„ Data Manifest
            â”‚           â”œâ”€â”€ [  18]  current
            â”‚           â”‚   â””â”€â”€ [  71]  link
            â”‚           â””â”€â”€ [  20]  index
            â”‚               â””â”€â”€ [  78]  sha256
            â”‚                   â””â”€â”€ [  18]  e0a33348ac8cace6b4294885e6e0bb57ecdfe4b6e415f1a7f4c5da5fe3116e02
            â”‚                       â””â”€â”€ [  71]  link
            â””â”€â”€ [   6]  _uploads
48 directories, 16 files
```

ç„¶åæˆ‘ä»¬å†é‡‡ç”¨skopeoåˆ é™¤æˆ‘ä»¬ä¸Šä¼ åˆ°Registryä»“åº“ä¸­çš„é•œåƒï¼Œå†è¿›è¡Œç›®å½•çš„å¯¹æ¯”:

```
$skopeo delete docker://localhost/library/alpine:3.12 --debug

# åˆ—å‡ºå˜åŒ–çš„ç›®å½•ç»“æ„éƒ¨åˆ†
repositories
    â””â”€â”€ library
        â”œâ”€â”€ alpine
        â”‚   â”œâ”€â”€ _layers
        â”‚   â”‚   â””â”€â”€ sha256
        â”‚   â”‚       â”œâ”€â”€ a24bb4013296f61e89ba57005a7b3e52274d8edd3ae2077d04395f806b63d83e
        â”‚   â”‚       â”‚   â””â”€â”€ link
        â”‚   â”‚       â””â”€â”€ df20fa9351a15782c64e6dddb2d4a6f50bf6d3688060a34c4014b0d9a752eb4c
        â”‚   â”‚           â””â”€â”€ link
        â”‚   â”œâ”€â”€ _manifests
        â”‚   â”‚   â”œâ”€â”€ revisions
        â”‚   â”‚   â”‚   â””â”€â”€ sha256
        â”‚   â”‚   â”‚       â””â”€â”€ a15790640a6690aa1730c38cf0a440e2aa44aaca9b0e8931a9f2b0d7cc90fd65
        â”‚   â”‚   â””â”€â”€ tags  # tags ä¸‹é¢çš„ç›®å½•ä¸æ–‡ä»¶è¢«åˆ é™¤
        â”‚   â””â”€â”€ _uploads
```

**æ€»ç»“ä¸Šè¿°:**

-   1.ä¸Šè¿°å¯ä»¥çœ‹è§å½“`skopeo delete`åˆ é™¤ä¸€ä¸ªé•œåƒæ—¶ï¼Œåªæ˜¯å¯¹\_manifestsä¸‹çš„æ–‡ä»¶`revisions/sha256/a15790640a6690...ka9f2b0d7cc90fd65/link`ä¸`tagså³å…¶å­ç›®å½•æ–‡ä»¶`è¿›è¡Œåˆ é™¤;å®é™…ä¸Šä¸¤è€…åˆ é™¤çš„æ˜¯åŒä¸€ä¸ªå†…å®¹ï¼Œå³å¯¹è®°å½•äº†è¯¥é•œåƒ manifests æ–‡ä»¶ digestæ‘˜è¦ çš„ link æ–‡ä»¶ã€‚
    
-   2.è¿è¡Œåä»--debugå‚æ•°ä¸­å¾—åˆ°`DEBU[0000] DELETE https://localhost/v2/library/alpine/manifests/sha256:a15790640a6690aa1730c38cf0a440e2aa44aaca9b0e8931a9f2b0d7cc90fd65`å¯ä»¥å¾—å‡ºé€šè¿‡ registry API æ¥ DELETE ä¸€ä¸ªé•œåƒå®è´¨ä¸Šæ˜¯åˆ é™¤ repositories å…ƒæ•°æ®æ–‡ä»¶å¤¹ä¸‹çš„ tag åæ–‡ä»¶å¤¹å’Œè¯¥ tag çš„ revisions ä¸‹çš„ link æ–‡ä»¶ã€‚
    

```
# æˆ‘ä»¬ä¹Ÿå¯ä»¥é‡‡ç”¨Registry API è¿›è¡Œæ“ä½œè¾¾åˆ°åŒæ ·çš„æ•ˆç‡
æˆ‘ä»¬å®šä¹‰æ‘˜è¦å­—ç¬¦ä¸²åŒ¹é…ä»¥ä¸‹è¯­æ³•ï¼š
digest      := algorithm ":" hex
algorithm   := /[A-Fa-f0-9_+.-]+/
hex         := /[A-Fa-f0-9]+/
# digest = sha256:6c3c624b58dbbcd3c0dd82b4c53f04194d1247c6eebdaab7c610cf7d66709b3b

# (1) è·å–åˆ°é•œåƒ Docker-Content-Digest:
$curl -I -u 'weiyigeek:123456' -H 'Accept: application/vnd.docker.distribution.manifest.v2+json' -X GET https://localhost/v2/library/alpine/manifests/3.12
# HTTP/1.1 200 OK
# Content-Length: 528
# Content-Type: application/vnd.docker.distribution.manifest.v2+json
# Docker-Content-Digest: sha256:a15790640a6690aa1730c38cf0a440e2aa44aaca9b0e8931a9f2b0d7cc90fd65
# Docker-Distribution-Api-Version: registry/2.0
# Etag: "sha256:a15790640a6690aa1730c38cf0a440e2aa44aaca9b0e8931a9f2b0d7cc90fd65"
# X-Content-Type-Options: nosniff
# Date: Fri, 21 Aug 2020 02:30:06 GMT

# (2) åˆ é™¤registryä»“åº“ä¸­çš„æŒ‡å®šDocker-Content-Digestçš„é•œåƒtags ä¸ links æ–‡ä»¶
$curl -u 'weiyigeek:123456' -H 'Accept: application/vnd.docker.distribution.manifest.v2+json' -X DELETE https://localhost/v2/library/alpine/manifests/sha256:a15790640a6690aa1730c38cf0a440e2aa44aaca9b0e8931a9f2b0d7cc90fd65
```

å¯ä»¥çœ‹å‡ºåˆ é™¤ä»“åº“ä¸­çš„é•œåƒï¼Œåªæ˜¯æŠŠåœ¨registryä»“åº“ä¸­é•œåƒçš„tagså­ç›®å½•ä¸revisions/sha256/.../linkæ–‡ä»¶è¿›è¡Œåˆ é™¤ï¼Œè€Œblobsä¸­çš„é•œåƒ data ä¸ repositories ä¸­é•œåƒç›®å½•library/alpine/å¹¶æœªè¢«åˆ é™¤ï¼Œè¿™æ ·å¯¼è‡´çš„åæœæ˜¯registryä»“åº“çš„æœåŠ¡å™¨å°†ä¼šå ç”¨ä¸€éƒ¨åˆ†å­˜å‚¨èµ„æºå¯¼è‡´èµ„æºçš„æµªè´¹ï¼Œé‚£å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜å°±æ˜¯æˆ‘ä»¬ä¸‹é¢æåˆ°çš„`Registry GC`Â æœºåˆ¶;

æè¿°:å¯ä»¥é€šè¿‡registry APIæ“ä½œç®¡ç†é•œåƒæˆ–è€…è·å–é•œåƒmanifestç›¸å…³ä¿¡æ¯;  
å®˜æ–¹å‚è€ƒåœ°å€:Â https://docs.docker.com/registry/spec/api/

æè¿°:é€šè¿‡APIé‡åˆ°çš„é”™è¯¯ä»£ç å¦‚ä¸‹è¡¨æ‰€ç¤º:Â https://docs.docker.com/registry/spec/api/#errors-2

APIæ–¹æ³•å’ŒURIåˆ—è¡¨æ¶µç›–å¦‚ä¸‹è¡¨ï¼š

![](https://i0.hdslb.com/bfs/article/39bce9d1c56e392118497b0897773666181be768.png@942w_459h_progressive.webp)

-   (1) PULL é•œåƒ: é•œåƒç”±ä¸€ä¸ªjsonæ¸…å•å’Œå±‚å æ–‡ä»¶ç»„æˆï¼Œpullé•œåƒçš„è¿‡ç¨‹å°±æ˜¯æ£€ç´¢è¿™ä¸¤ä¸ªç»„ä»¶çš„è¿‡ç¨‹ã€‚
    

```
- ç¬¬ä¸€æ­¥å°±æ˜¯è·å–æ¸…å•ï¼Œæ¸…å•ç”±ä¸‹é¢å‡ ä¸ªå­—æ®µç»„æˆ:
registry:5000/v2/redis/manifests/latest(è·å–redis:latestæ¸…å•æ–‡ä»¶)
# å­—æ®µæè¿°
# nameé•œåƒåç§°
# tagé•œåƒå½“å‰ç‰ˆæœ¬çš„tag
# fsLayerså±‚æè¿°åˆ—è¡¨(åŒ…æ‹¬æ‘˜è¦)
# signatureä¸€ä¸ªJWSç­¾åï¼Œç”¨æ¥éªŒè¯æ¸…å•å†…å®¹

- ç¬¬äºŒæ­¥å½“è·å–æ¸…å•ä¹‹åï¼Œå®¢æˆ·ç«¯éœ€è¦éªŒè¯å‰é¢(signature)ï¼Œä»¥ç¡®ä¿åç§°å’ŒfsLayerså±‚æ˜¯æœ‰æ•ˆçš„ã€‚ç¡®è®¤åå®¢æˆ·ç«¯å¯ä»¥ä½¿ç”¨digestå»ä¸‹è½½å„ä¸ªfså±‚ã€‚åœ¨V2apiä¸­å±‚å­˜å‚¨åœ¨blobsä¸­å·²digestä½œä¸ºé”®å€¼.
1.é¦–å…ˆæ‹‰å–é•œåƒæ¸…å•(pulling an Image Manifest)
  $ HEAD /v2/<image/manifests/<reference>#æ£€æŸ¥é•œåƒæ¸…å•æ˜¯å¦å­˜åœ¨
  $ GET /v2/<image>/manifests/<reference>#æ‹‰å–é•œåƒæ¸…å•
  æç¤ºï¼šreferenceå¯æ˜¯æ˜¯tagæˆ–è€…æ˜¯digest  
2.å¼€å§‹æ‹‰å–æ¯ä¸ªå±‚(pulling a Layer)
  $ GET /v2/<image>/blobs/<digest>
  æç¤ºï¼šdigestæ˜¯é•œåƒæ¯ä¸ªfsLayerå±‚çš„å”¯ä¸€æ ‡è¯†ï¼Œå­˜åœ¨äºæ¸…å•çš„fsLayersé‡Œé¢ã€‚
```

-   (2) PUSH é•œåƒ: æ¨é€é•œåƒå’Œæ‹‰å–é•œåƒè¿‡ç¨‹ç›¸å,å…ˆæ¨å„ä¸ªå±‚åˆ°registryä»“åº“ï¼Œç„¶åä¸Šä¼ æ¸…å•.(Pushing a Layer(ä¸Šä¼ å±‚)åˆ†ä¸º2æ­¥)
    

```
# 2.1) ä½¿ç”¨postè¯·æ±‚åœ¨registryä»“åº“å¯åŠ¨ä¸Šä¼ æœåŠ¡,è¿”å›ä¸€ä¸ªurlè¿™ä¸ªurlç”¨æ¥ä¸Šä¼ æ•°æ®å’Œæ£€æŸ¥çŠ¶æ€ã€‚
# é¦–å…ˆExisting Layers(æ£€æŸ¥å±‚æ˜¯å¦å­˜åœ¨)ï¼Œè‹¥è¿”å›200 OK åˆ™è¡¨ç¤ºå­˜åœ¨ï¼Œä¸ç”¨ä¸Šä¼ 
$ HEAD /v2/image/blobs/<digest>

# å¼€å§‹ä¸Šä¼ æœåŠ¡(Starting An Upload)ï¼Œå¦‚æœpostè¯·æ±‚è¿”å›202 acceptedï¼Œä¸€ä¸ªurlä¼šåœ¨locationå­—æ®µè¿”å›.
$ POST /v2/image/blobs/uploads/
# 202 Accepted
# Location: /v2/\<image>/blobs/uploads/\<uuid>
# Range: bytes=0-<offset>
# Content-Length: 0
# Docker-Upload-UUID: <uuid> # å¯ä»¥ç”¨æ¥æŸ¥çœ‹ä¸Šä¼ çŠ¶æ€å’Œå®ç°æ–­ç‚¹ç»­ä¼ 

# 2.2) å¼€å§‹ä¸Šä¼ å±‚(Uploging the Layer)
> PUT /v2/<name>/blobs/uploads/<uuid>?digest=<digest> 
Content-Length: <size of layer>>
Content-Type: application/octet-stream

# ä¸Šä¼ è¿›åº¦(Upload Progress)
$ GET /v2/<image>/blobs/uploads/<uuid>
# 204 No Content
# Location: /v2/<name>/blobs/uploads/<uuid>
# Range: bytes=0-<offset>
# Docker-Upload-UUID: <uuid>

# é‡ç‚¹-æ•´å—ä¸Šä¼ (Monolithic Upload)
> PUT /v2/<name>/blobs/uploads/<uuid>?digest=<digest> 
> Content-Length: <size of layer>
> Content-Type: application/octet-stream

<Layer Binary Data>

# é‡ç‚¹-åˆ†å—ä¸Šä¼ (Chunked Upload)
> PATCH /v2/\<name>/blobs/uploads/\<uuid>
> Content-Length: \<size of chunk>
> Content-Range: \<start of range>-\<end of range>

> Content-Type: application/octet-stream

\<Layer Chunk Binary Data>

# å¦‚æœæœåŠ¡å™¨ä¸æ¥å—è¿™ä¸ªå—ï¼Œåˆ™è¿”å›:
#   416 Requested Range Not Satisfiable
#   Location: /v2/<name>/blobs/uploads/<uuid>
#   Range: 0-<last valid range>
#   Content-Length: 0
#   Docker-Upload-UUID: <uuid>
             
# æˆåŠŸåˆ™è¿”å›ï¼š
#   202 Accepted
#   Location: /v2/<name>/blobs/uploads/<uuid>
#   Range: bytes=0-<offset>
#   Content-Length: 0
#   Docker-Upload-UUID: <uuid>

# é‡ç‚¹-äº¤å‰ä¸Šä¼ (Cross Repository Blob Mount)å¯ä»¥æŠŠå®¢æˆ·ç«¯æœ‰è®¿é—®æƒé™çš„å·²æœ‰å­˜å‚¨åº“ä¸­çš„å±‚æŒ‚è½½åˆ°å½“å‰å­˜å‚¨åº“ä¸­
POST /v2/<name>/blobs/uploads/?mount=<digest>&from=<repository name>
Content-Length: 0
# æˆåŠŸè¿”å›ï¼š
#   201 Created
#   Location: /v2/<name>/blobs/<digest>
#   Content-Length: 0
#   Docker-Content-Digest: <digest>

# å¤±è´¥è¿”å›:
#   202 Accepted
#   Location: /v2/<name>/blobs/uploads/<uuid>
#   Range: bytes=0-<offset>
#   Content-Length: 0
#   Docker-Upload-UUID: <uuid>


# 3.3) ä¸Šä¼ å®Œæˆ(Completed Upload)ï¼Œä½†æ˜¯æ³¨æ„åˆ†å—ä¸Šä¼ åœ¨æœ€åä¸€å—ä¸Šä¼ å®Œæ¯•åï¼Œéœ€è¦æäº¤ä¸€ä¸ªä¸Šä¼ å®Œæˆçš„è¯·æ±‚
> PUT /v2/<name>/blob/uploads/<uuid>?digest=<digest>
> Content-Length: <size of chunk>
> Content-Range: <start of range>-<end of range>
> Content-Type: application/octet-stream   

<Last Layer Chunk Binary Data>

# æˆåŠŸè¿”å›ï¼š
# 201 Created
# Location: /v2/<name>/blobs/<digest>
# Content-Length: 0
# Docker-Content-Digest: <digest>
```

å®é™…ç¤ºä¾‹

Tips: åç»­ä¸å†åŠ `--cacert /opt/registry/certs/domain.crt`å‚æ•°ï¼Œé»˜è®¤å¤§å®¶éƒ½å·²ç»æŠŠè¯ä¹¦å¯¼å…¥å¸¦ç³»ç»Ÿæœ¬åœ°;

-   0.Registry V2åè®®åŠå…¶è®¤è¯è¯·æ±‚éªŒè¯
    

```
# Registry ä»“åº“åè®®
$curl -I -u 'weiyigeek:123456' -X GET https://localhost/v2/
HTTP/1.1 200 OK
# é‡‡ç”¨ä¸€ä¸ªRFC7235å…¼å®¹çš„æˆæƒå¤´è¿›è¡Œè®¤è¯
$curl -I -H 'Authorization: Basic d2VpeWlnZWVrOjEyMzQ1Ng==' -X GET https://localhost/v2/
HTTP/1.1 200 OK
```

-   1.æŸ¥çœ‹Registryä»“åº“ä¸­æœ‰é‚£äº›é•œåƒ(ä¸ç²¾ç¡®-å½“é€šè¿‡deleteåˆ é™¤é•œåƒæ—¶å€™æ­¤å¤„å¹¶æœªåˆ é™¤éœ€è¦æ‰‹åŠ¨åˆ°repositoriesæ–‡ä»¶å¤¹ä¸­åˆ é™¤)
    

```
# Registry ä»“åº“ä¸­æ‰€æœ‰é•œåƒ
curl --cacert /opt/registry/certs/domain.crt -u 'weiyigeek:123456' -X GET https://localhost/v2/_catalog
{"repositories":["library/alpine","library/debian"]}

# è¿”å›ä»“åº“ä¸­æŒ‡å®šæ¡ç›®çš„é•œåƒ(é€šè¿‡-v å‚æ•°å¯çœ‹å‡ºlastçš„ä¸åŒ)
curl --cacert /opt/registry/certs/domain.crt -u 'weiyigeek:123456' -X GET "https://localhost/v2/_catalog?n=1&last=a"
```

-   2.è·å–æŸä¸ªé•œåƒçš„æ ‡ç­¾åˆ—è¡¨ (æ³¨æ„åŠ æˆ–è€…æœªåŠ Projectçš„åŒºåˆ«)
    

```
curl -u 'weiyigeek:123456' -X GET https://localhost/v2/alpine/tags/list
# {"name":"alpine","tags":["latest"]}
curl -u 'weiyigeek:123456' -X GET https://localhost/v2/library/alpine/tags/list  # 'library/alpine'
# {"name":"library/alpine","tags":["3.12"]}
# åˆ—å‡ºé•œåƒéƒ¨åˆ†tags(Pagination)
curl -u 'weiyigeek:123456' -X GET https://localhost/v2/library/alpine/tags/list?n=<integer>
```

-   3.æ‹‰å–Registry ä»“åº“é•œåƒä¸­Manifests(æ¸…å•)æ–‡ä»¶
    

```
# åˆ¤æ–­æŒ‡å®šé•œåƒä¸tagsçš„Manifests(æ¸…å•)æ˜¯å¦å­˜åœ¨
curl -I -u 'weiyigeek:123456' -X HEAD https://localhost/v2/library/alpine/manifests/3.12
# HTTP/1.1 200 OK
# Content-Length: 2783
# Content-Type: application/vnd.docker.distribution.manifest.v1+prettyjws


# ä»“åº“ä¸­`Manifests`æ¸…å•
$ curl -u 'weiyigeek:123456' -X GET https://localhost/v2/library/alpine/manifests/3.12
# {
#    "schemaVersion": 1,
#    "name": "library/alpine",
#    "tag": "3.12",
#    "architecture": "amd64",
#    "fsLayers": [{
#          "blobSum": "sha256:a3ed95caeb02ffe68cdd9fd84406680ae93d633cb16422d00e8a7c22955b46d4"},{
#          "blobSum": "sha256:df20fa9351a15782c64e6dddb2d4a6f50bf6d3688060a34c4014b0d9a752eb4c"
#       }
#    ],
#    "history": [
#       {
#          "v1Compatibility": "{\"architecture\":\"amd64\",\"config\":{\"Hostname\":\"\",\"Domainname\":\"\",\"User\":\"\",\"AttachStdin\":false,\"AttachStdout\":false,\"AttachStderr\":false,\"Tty\":false,\"OpenStdin\":false,\"StdinOnce\":false,\"Env\":[\"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\"],\"Cmd\":[\"/bin/sh\"],\"ArgsEscaped\":true,\"Image\":\"sha256:64771e4514cb653a0fe68e1ceed5bd16640ebf3bd859dc3333efe87dc4709a5d\",\"Volumes\":null,\"WorkingDir\":\"\",\"Entrypoint\":null,\"OnBuild\":null,\"Labels\":null},\"container\":\"ce1874fa1fc1eb128516899352f185645f492c443b5a80d9a3fae8b09d1b6b16\",\"container_config\":{\"Hostname\":\"ce1874fa1fc1\",\"Domainname\":\"\",\"User\":\"\",\"AttachStdin\":false,\"AttachStdout\":false,\"AttachStderr\":false,\"Tty\":false,\"OpenStdin\":false,\"StdinOnce\":false,\"Env\":[\"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\"],\"Cmd\":[\"/bin/sh\",\"-c\",\"#(nop) \",\"CMD [\\\"/bin/sh\\\"]\"],\"ArgsEscaped\":true,\"Image\":\"sha256:64771e4514cb653a0fe68e1ceed5bd16640ebf3bd859dc3333efe87dc4709a5d\",\"Volumes\":null,\"WorkingDir\":\"\",\"Entrypoint\":null,\"OnBuild\":null,\"Labels\":{}},\"created\":\"2020-05-29T21:19:46.363518345Z\",\"docker_version\":\"18.09.7\",\"id\":\"4a28aef4f8a9e13b1df98eaf8e651db2857161cea27134dad697ad0c7a7de12d\",\"os\":\"linux\",\"parent\":\"a5213fa3ad8fa7a42f88213945845ef49dcf11328d51576b8f076142ce75bdf8\",\"throwaway\":true}"
#       },
#       {
#          "v1Compatibility": "{\"id\":\"a5213fa3ad8fa7a42f88213945845ef49dcf11328d51576b8f076142ce75bdf8\",\"created\":\"2020-05-29T21:19:46.192045972Z\",\"container_config\":{\"Cmd\":[\"/bin/sh -c #(nop) ADD file:c92c248239f8c7b9b3c067650954815f391b7bcb09023f984972c082ace2a8d0 in / \"]}}"
#       }
#    ],
#    "signatures": [
#       {
#          "header": {
#             "jwk": {
#                "crv": "P-256",
#                "kid": "P6TV:UOU3:V564:FNEL:DQG2:WQX5:6Z5P:NQF6:XZOR:JTMI:Q2QI:AQZ3",
#                "kty": "EC",
#                "x": "n70C5idlCOFB4ubdg5K6MCvRBIH6d5YzhTRumV1i6D8",
#                "y": "OmZn6AyifVg3kZ67ICPViHTHBXvMui8fPwqXzbTnWw0"
#             },
#             "alg": "ES256"
#          },
#          "signature": "S4Tvfqx0nA7hULgyKdKKdoYpgMsTqxlbQ6JDeQv1HXZie1zMCsafNZfLI59kivzHb7IV8hwEnvxehL0cKuoZ4w",
#          "protected": "eyJmb3JtYXRMZW5ndGgiOjIxMzYsImZvcm1hdFRhaWwiOiJDbjAiLCJ0aW1lIjoiMjAyMC0wOC0yMlQwNzoyNDozM1oifQ"
#       }
#    ]
# }
```

-   4.è·å–ä»“åº“é•œåƒçš„manifestså†…å®¹ (go-hello:scratch)
    

```
curl -v -u 'weiyigeek:123456' -H 'Accept: application/vnd.docker.distribution.manifest.v2+json' -X GET https://localhost/v2/go-hello/manifests/scratch 
# {
#    "schemaVersion": 2,
#    "mediaType": "application/vnd.docker.distribution.manifest.v2+json",
#    "config": {
#       "mediaType": "application/vnd.docker.container.image.v1+json",
#       "size": 1472,
#       "digest": "sha256:cb05b87d001253772ae9a212200de5eb8304ab9691c61589332a2f57e7059209"
#    },
#    "layers": [
#       {
#          "mediaType": "application/vnd.docker.image.rootfs.diff.tar.gzip",
#          "size": 1106793,
#          "digest": "sha256:5395625ce01dee311e2f7c879b0b148ac7525de7aad5080a518d7f7e5a99d368"
#       }
#    ]
# }
```

-   5.è·å–(é•œåƒ:ç‰ˆæœ¬)æ ‡è¯†çš„data manifestsçš„ digest
    

```
curl -I --cacert /opt/registry/certs/domain.crt -u 'weiyigeek:123456' -H 'Accept: application/vnd.docker.distribution.manifest.v2+json' -X GET https://localhost/v2/go-hello/manifests/scratch
# HTTP/1.1 200 OK
# Content-Length: 528
# Content-Type: application/vnd.docker.distribution.manifest.v2+json
# æ³¨æ„Docker-Content-Digestä¸­çš„å†…å®¹: åœ¨registry2.3æˆ–æ›´é«˜ç‰ˆæœ¬åˆ é™¤æ¸…å•æ—¶,å¿…é¡»åœ¨HEADæˆ–GETè·å–æ¸…å•ä»¥è·å–è¦åˆ é™¤çš„æ­£ç¡®digestæºå¸¦ä»¥ä¸‹å¤´;
# Docker-Content-Digest: sha256:8dabce532312b587329fe225ef501051c60f81ffdb2c801a5da6348b9cab132e
# Docker-Distribution-Api-Version: registry/2.0
# Etag: "sha256:8dabce532312b587329fe225ef501051c60f81ffdb2c801a5da6348b9cab132e"
# X-Content-Type-Options: nosniff
# Date: Fri, 21 Aug 2020 02:30:06 GMT

# ã€ç®€çº¦ç‰ˆæœ¬:ç›´æ¥æå–Docker-Content-Digestå¤´å†…å®¹ã€‘
curl -Is -u 'weiyigeek:123456' -H 'Accept: application/vnd.docker.distribution.manifest.v2+json' -X GET https://localhost/v2/library/alpine/manifests/3.12 | grep "Docker-Content-Digest:" | cut -f 2 -d " "
sha256:a15790640a6690aa1730c38cf0a440e2aa44aaca9b0e8931a9f2b0d7cc90fd65

# ã€å¦‚ä¸æŒ‡å®šAcceptåˆ™é»˜è®¤ä¸º application/vnd.docker.distribution.manifest.v1+prettyjws ã€‘
curl -I -u 'weiyigeek:123456' -X GET https://localhost/v2/library/alpine/manifests/3.12                                     HTTP/1.1 200 OK
# Content-Length: 2783
# Content-Type: application/vnd.docker.distribution.manifest.v1+prettyjws
# Docker-Content-Digest: sha256:cae82a43ba96214acd380f3d4ed043445f56f80f0fc99f3f927d5e6eaee40791
# Docker-Distribution-Api-Version: registry/2.0
# Etag: "sha256:cae82a43ba96214acd380f3d4ed043445f56f80f0fc99f3f927d5e6eaee40791"
# X-Content-Type-Options: nosniff
# Date: Sat, 22 Aug 2020 03:01:16 GMT
```

-   6.åˆ é™¤ä»“åº“ä¸­çš„é•œåƒå³åˆ é™¤(repositoriesä¸‹é¢çš„ \_manifests ä¸­çš„Tags ä¸ revisions ä¸‹çš„link)
    

```
# åŠ å…¥ -v å‚æ•° æŸ¥çœ‹è¯·æ±‚è¿”å›æµç¨‹  
$curl -v --cacert /opt/registry/certs/domain.crt -u 'weiyigeek:123456' -H 'Accept: application/vnd.docker.distribution.manifest.v2+json' -X DELETE https://localhost/v2/go-hello/manifests/sha256:8dabce532312b587329fe225ef501051c60f81ffdb2c801a5da6348b9cab132e
#  202 Accepted
#  Content-Length: None
# å¤±è´¥ è¿”å›404é”™è¯¯
```

æ³¨æ„ï¼šé»˜è®¤æƒ…å†µä¸‹ï¼Œregistryä¸å…è®¸åˆ é™¤é•œåƒæ“ä½œï¼Œéœ€è¦åœ¨å¯åŠ¨registryæ—¶æŒ‡å®šç¯å¢ƒå˜é‡`REGISTRY_STORAGE_DELETE_ENABLED=true`,æˆ–è€…ä¿®æ”¹å…¶é…ç½®æ–‡ä»¶å³å¯ã€‚referenceå¿…é¡»æ˜¯digest,å¦åˆ™åˆ é™¤å°†å¤±è´¥ã€‚åœ¨registry2.3æˆ–æ›´é«˜ç‰ˆæœ¬åˆ é™¤æ¸…å•æ—¶ï¼Œå¿…é¡»åœ¨HEADæˆ–GETè·å–æ¸…å•ä»¥è·å–è¦åˆ é™¤çš„æ­£ç¡®digestæºå¸¦ä»¥ä¸‹å¤´ï¼š  
Accept: application/vnd.docker.distribution.manifest.v2+json

-   7.æ‹‰å–é•œåƒï¼Œç”±äºå±‚è¢«å­˜å‚¨åœ¨æ³¨å†Œè¡¨ä¸­çš„blobsä¸­æ‰€ä»¥æ˜¯éœ€è¦é€šè¿‡ä¸€ä¸ªæ ‡å‡†çš„HTTPè¯·æ±‚æ¥è¿›è¡Œæ‹‰å–ä¸€ä¸ªå±‚çš„ä¿¡æ¯
    

```
# (1) å…ˆæŸ¥çœ‹é•œåƒ data ç›¸å…³çš„ Digest ç 
curl -s -u 'weiyigeek:123456' -H 'Accept: application/vnd.docker.distribution.manifest.v2+json' -X GET https://localhost/v2/library/alpine/manifests/3.12 | jq '"Data Config - " + .config.digest','"Data Layer - " + .layers[0].digest'
# "Data Config - sha256:a24bb4013296f61e89ba57005a7b3e52274d8edd3ae2077d04395f806b63d83e"
# "Data Layer - sha256:df20fa9351a15782c64e6dddb2d4a6f50bf6d3688060a34c4014b0d9a752eb4c"

# (2) è·å–æ‹‰å–é•œåƒçš„data config ä¸ data layer æ–‡ä»¶
curl -u 'weiyigeek:123456' -X GET https://localhost/v2/library/alpine/blobs/sha256:a24bb4013296f61e89ba57005a7b3e52274d8edd3ae2077d04395f806b63d83e | jq 

curl -u 'weiyigeek:123456' -X GET https://localhost/v2/library/alpine/blobs/sha256:df20fa9351a15782c64e6dddb2d4a6f50bf6d3688060a34c4014b0d9a752eb4c -o /tmp/alpine-3.12.tar.gz
[root@k8s tmp]$ ls -lh alpine-3.12.tar.gz
-rw-r--r--.  1 root root 2.7M 8æœˆ  22 16:27 alpine-3.12.tar.gz
[root@k8s tmp]$ tar -zxvf alpine-3.12.tar.gz  # å®é™…ä¸Šè¯¥å‹ç¼©æ–‡ä»¶ä¸­å­˜æ”¾çš„æ˜¯rootfsæ–‡ä»¶ç³»ç»Ÿ
# bin/
# bin/arch
# bin/ash
# bin/base64
# bin/bbconfig
```

-   8.é•œåƒé€šè¿‡Registry APIä¸Šä¼ åˆ°ä»“åº“ä¸­
    

```
# æ‰€æœ‰å±‚ä¸Šä¼ ä½¿ç”¨ä¸¤ä¸ªæ­¥éª¤æ¥ç®¡ç†ä¸Šä¼ è¿‡ç¨‹ã€‚
* ç¬¬ä¸€æ­¥å¼€å§‹åœ¨æ³¨å†Œè¡¨ä¸­çš„æœåŠ¡ä¸Šä¼ ï¼Œè¿”å›ä¸€ä¸ªURLæ¥è¿›è¡Œç¬¬äºŒæ­¥ã€‚
* ç¬¬äºŒæ­¥ä½¿ç”¨ä¸Šè½½URLä¼ é€’çš„å®é™…æ•°æ®ã€‚ä¸Šä¼ éƒ½å¼€å§‹è¿”å›ï¼Œå¯ç”¨äºå°†æ•°æ®æ¨å’Œæ£€æŸ¥ä¸Šä¼ çŠ¶æ€URLçš„POSTè¯·æ±‚ã€‚
# Locationå¤´å°†ç”¨äºæ¯ä¸ªè¯·æ±‚åè¿›è¡Œé€šä¿¡çš„ä¸Šè½½ä½ç½®ã€‚è™½ç„¶å®ƒä¸ä¼šåœ¨æœ¬æŠ€æœ¯è§„æ ¼æ”¹å˜ï¼Œå®¢æˆ·åº”ä½¿ç”¨APIè¿”å›çš„æœ€æ–°å€¼ã€‚

# (1) å¼€å§‹ä¸Šè½½ä¸€ä¸ªPOSTè¯·æ±‚ 
# POST /v2/<name>/blobs/uploads/

curl -I -u 'weiyigeek:123456' -X POST https://localhost/v2/test-images/blobs/uploads/
# å¦‚æœPOSTè¯·æ±‚æ˜¯æˆåŠŸçš„å®ƒå°†è¿”å› 202å“åº” å°†ä¸Locationå¤´ä¸Šä¼ çš„URLè¿”å›ï¼š
# HTTP/1.1 202 Accepted
# Content-Length: 0
# Docker-Distribution-Api-Version: registry/2.0
# Docker-Upload-Uuid: 9efa5ca7-d009-4532-88de-695c1f945e59  # å¿…é¡»é¢
# Location: https://localhost/v2/test-images/blobs/uploads/9efa5ca7-d009-4532-88de-695c1f945e59?_state=XqlcahxfSzts1a43SgEs_MQ9-GAczgadg-Ra3vayoh57Ik5hbWUiOiJ0ZXN0LWltYWdlcyIsIlVVSUQiOiI5ZWZhNWNhNy1kMDA5LTQ1MzItODhkZS02OTVjMWY5NDVlNTkiLCJPZmZzZXQiOjAsIlN0YXJ0ZWRBdCI6IjIwMjAtMDgtMjJUMDg6NDA6NDguMDkwNTk0NzQ4WiJ9  # æŒ‡å®šäº†ä½ç½®æ ‡å¤´
# Range: 0-0
# X-Content-Type-Options: nosniff
# Date: Sat, 22 Aug 2020 08:40:48 GMT


# (2) é€šè¿‡HEADè¯·æ±‚åˆ°BLOBå­˜å‚¨APIè¿›è¡Œæ£€æŸ¥é•œåƒç›¸å…³å±‚æ˜¯å¦å­˜åœ¨(å¯ç”¨è¿”å›200 OK)
# HEAD /v2/<name>/blobs/<digest>

curl -I -u 'weiyigeek:123456' -X HEAD https://localhost/v2/test-images/blobs/sha256:a14....jk5


# (3) ä¸Šä¼ è¿›åº¦æŸ¥çœ‹æ­¤æ—¶éœ€è¦ç¬¬ä¸€æ­¥ä¸­çš„Docker-Upload-Uuidä¹‹è¿›è¡Œè¯·æ±‚
# GET /v2/<name>/blobs/uploads/<uuid>
curl -I -u 'weiyigeek:123456' -X GET https://localhost/v2/test-images/blobs/uploads/9efa5ca7-d009-4532-88de-695c1f945e59


# (4) Monolithic Upload ç®€å•çš„å•å—ä¸Šä¼ ï¼Œå¹¶å¯ä»¥é€šè¿‡æƒ³é¿å…åˆ†å—çš„å¤æ‚æ€§çš„
# PUT /v2/<name>/blobs/uploads/<uuid>?digest=<digest>
# Content-Length: <size of layer>
# Content-Type: application/octet-stream

# <Layer Binary Data>


# (5) Chunked Upload è¿›è¡Œç»„å—çš„ä¸Šè½½ï¼Œè¯¥å®¢æˆ·æœºå¯ä»¥æŒ‡å®šä¸€ä¸ªèŒƒå›´æŠ¥å¤´å’Œä»…åŒ…æ‹¬å±‚æ–‡ä»¶çš„ä¸€éƒ¨åˆ†ï¼š
# PATCH /v2/<name>/blobs/uploads/<uuid>
# Content-Length: <size of chunk>
# Content-Range: <start of range>-<end of range>
# Content-Type: application/octet-stream

# <Layer Chunk Binary Data>

# (6) è·¨å­˜å‚¨åº“BlobæŒ‚è½½,å¯ä»¥ä»å®¢æˆ·æœºå…·æœ‰è¯»è®¿é—®æƒçš„å¦ä¸€ä¸ªå­˜å‚¨åº“æŒ‚è½½blobï¼Œä»è€Œä¸éœ€è¦å°†å·²çŸ¥çš„blobä¸Šä¼ åˆ°æ³¨å†Œä¸­å¿ƒ,è¦å‘å‡ºä¸€ä¸ªblobæŒ‚è½½è€Œä¸æ˜¯ä¸€ä¸ªupload, POSTè¯·æ±‚åº”è¯¥ä»¥ä»¥ä¸‹æ ¼å¼å‘å‡º(æˆåŠŸå°†è¿”å›202 Accepted):
POST /v2/<name>/blobs/uploads/?mount=<digest>&from=<repository name>
Content-Length: 0


# (7) Completed Upload å½“é•œåƒä¸Šä¼ å®Œæ¯•å¿…é¡»è¿›è¡Œä»¥ä¸‹è¯·æ±‚å¦åˆ™ä»“åº“ä¸è®¤ä¸ºé•œåƒä¸ªå±‚å…¨éƒ¨ä¸Šä¼ ï¼Œå½“æ¥æ”¶åˆ°æœ€åä¸€ä¸ªå—å’Œå±‚å·²è¢«éªŒè¯æ—¶å€™å°†è¿”å›201 Create å¹¶ä¸”è¿”å›è¯¥é•œåƒçš„Docker-Content-Digestå€¼;
# PUT /v2/<name>/blobs/uploads/<uuid>?digest=<digest>
# Content-Length: <size of chunk>
# Content-Range: <start of range>-<end of range>
# Content-Type: application/octet-stream

# <Last Layer Chunk Binary Data>


# (8) å–æ¶ˆä¸Šä¼ é•œåƒåˆ°ä»“åº“ï¼Œå¯é€šè¿‡å‘å‡ºDELETEè¯·æ±‚åˆ°registryä¹‹ä¸­;
# DELETE /v2/<name>/blobs/uploads/<uuid>


# (9) åˆ é™¤å±‚(Deleting a Layer)
# DELETE /v2/<image>/blobs/<digest>

# æˆåŠŸè¿”å›:
# 202 Accepted
# Content-Length: None


# (10) ä¸Šä¼ é•œåƒæ¸…å•(Pushing an Image Manifest),æˆ‘ä»¬ä¸Šä¼ å®Œé•œåƒå±‚ä¹‹åï¼Œå°±å¼€å§‹ä¸Šä¼ é•œåƒæ¸…å•
# PUT /v2/<name>/manifests/<reference>
# Content-Type: <manifest media type>
# {
# "name": <name>,
# "tag": <tag>,
# "fsLayers": [
#   {
#     "blobSum": <digest>
#   },
#   ...
# ]
# ],
# "history": <v1 images>,
# "signature": <JWS>,
# ...
# }

# å¦‚æœæ¸…å•ä¸­æœ‰å±‚("blobSum":<digest>)æ˜¯æœªçŸ¥çš„ï¼Œåˆ™è¿”å›
# {  "errors:" [{          "code": "BLOB_UNKNOWN",          "message": "blob unknown to registry",          "detail": {              "digest": <digest>
#         }
#     },
#     ...
#   ]
# }
# ```
```

åˆ é™¤é•œåƒManifestsä¸é•œåƒå±‚ä¿¡æ¯:

```
curl -Is -u 'weiyigeek:123456' -H 'Accept: application/vnd.docker.distribution.manifest.v2+json' -X GET https://localhost/v2/library/alpine/manifests/3.12 | grep "Docker-Content-Digest:" | cut -f 2 -d " "
sha256:a15790640a6690aa1730c38cf0a440e2aa44aaca9b0e8931a9f2b0d7cc90fd65

curl -s -u 'weiyigeek:123456' -H 'Accept: application/vnd.docker.distribution.manifest.v2+json' -X GET https://localhost/v2/library/alpine/manifests/3.12 | grep "digest"
"digest": "sha256:a24bb4013296f61e89ba57005a7b3e52274d8edd3ae2077d04395f806b63d83e"
"digest": "sha256:df20fa9351a15782c64e6dddb2d4a6f50bf6d3688060a34c4014b0d9a752eb4c"

# åˆ é™¤ é•œåƒ  _Manifests Tags
curl -v --cacert /opt/registry/certs/domain.crt -u 'weiyigeek:123456' -H 'Accept: application/vnd.docker.distribution.manifest.v2+json' -X DELETE https://localhost/v2/library/alpine/manifests/sha256:a15790640a6690aa1730c38cf0a440e2aa44aaca9b0e8931a9f2b0d7cc90fd65

# åˆ é™¤ é•œåƒ _Layer
curl -v -u 'weiyigeek:123456' -X DELETE https://localhost/v2/library/alpine/blobs/sha256:a24bb4013296f61e89ba57005a7b3e52274d8edd3ae2077d04395f806b63d83e

curl -v -u 'weiyigeek:123456' -X DELETE https://localhost/v2/library/alpine/blobs/sha256:df20fa9351a15782c64e6dddb2d4a6f50bf6d3688060a34c4014b0d9a752eb4c

curl -v -u 'weiyigeek:123456' -X DELETE "https://localhost/v2/library/alpine/blobs/sha256:a3ed95caeb02ffe68cdd9fd84406680ae93d633cb16422d00e8a7c22955b46d4"

curl -v -u 'weiyigeek:123456' -X DELETE https://localhost/v2/library/alpine/blobs/sha256:a15790640a6690aa1730c38cf0a440e2aa44aaca9b0e8931a9f2b0d7cc90fd65

# æ¸…ç©ºåæ•ˆæœ
repositories
    |
   library
    â”‚   â”œâ”€â”€ alpine
    â”‚   â”‚   â”œâ”€â”€ _layers
    â”‚   â”‚   â”‚   â””â”€â”€ sha256
    â”‚   â”‚   â”‚       â”œâ”€â”€ a24bb4013296f61e89ba57005a7b3e52274d8edd3ae2077d04395f806b63d83e
    â”‚   â”‚   â”‚       â”œâ”€â”€ a3ed95caeb02ffe68cdd9fd84406680ae93d633cb16422d00e8a7c22955b46d4
    â”‚   â”‚   â”‚       â””â”€â”€ df20fa9351a15782c64e6dddb2d4a6f50bf6d3688060a34c4014b0d9a752eb4c
    â”‚   â”‚   â”œâ”€â”€ _manifests
    â”‚   â”‚   â”‚   â”œâ”€â”€ revisions
    â”‚   â”‚   â”‚   â”‚   â””â”€â”€ sha256
    â”‚   â”‚   â”‚   â”‚       â””â”€â”€ a15790640a6690aa1730c38cf0a440e2aa44aaca9b0e8931a9f2b0d7cc90fd65
    â”‚   â”‚   â”‚   â””â”€â”€ tags
    â”‚   â”‚   â””â”€â”€ _uploads
```

ç®€å•ç²—æš´æ¸…ç©º Registry ä»“åº“ï¼š

```
$tree /var/lib/registry/docker/registry/v2/blobs/sha256/
/var/lib/registry/docker/registry/v2/blobs/sha256/
â”œâ”€â”€ 0e
â”œâ”€â”€ 32
â”œâ”€â”€ 3f
â”œâ”€â”€ 53
â”œâ”€â”€ 59
â”œâ”€â”€ 8d
â”œâ”€â”€ a1
â”œâ”€â”€ a2
â”œâ”€â”€ b7
â”œâ”€â”€ b9
â”œâ”€â”€ cb
â”œâ”€â”€ df
â””â”€â”€ e7
rm -rf /var/lib/registry/docker/registry/v2/blobs/sha256/*
rm -rf /var/lib/registry/docker/registry/v2/repositories/*
```

æè¿°:åœ¨ä¸Šä¸€ç« èŠ‚ä¸­æˆ‘ä»¬é˜è¿°äº†ä¸ºä»€ä¹ˆè¦å¼•å…¥Registry GCæœºåˆ¶ï¼Œå†è¯´å…¶ç›®çš„ç”¨å¤„å‰æˆ‘ä»¬å…ˆå¯¹å…¶è¿›è¡Œä¸€ä¸ªç®€å•çš„ä»‹ç»;

Q: ä»€ä¹ˆæ˜¯Registry GC ?

> ç­” :GCè‹±æ–‡å…¨ç§°`Garbage collection`å°±æ˜¯åƒåœ¾å›æ”¶çš„æ„æ€ï¼Œä» docker å®˜æ–¹æ–‡æ¡£å…³äºGCå·æ¥çš„ example æ¥è§£é‡Šä¸€ä¸‹å§ã€‚  
> å®˜ç½‘æ–‡æ¡£:https://docs.docker.com/registry/garbage-collection/

```
#å‡å¦‚é•œåƒ A å’Œé•œåƒ B å®ƒä»¬åˆ†åˆ«å¼•ç”¨äº†layer aï¼Œbå’Œ aï¼Œcã€‚
-  A  -
|     |
a  -  b  -  c 
|           |
----  B ----

# é€šè¿‡ registry API åˆ é™¤é•œåƒ B ä¹‹åï¼Œlayer c å¹¶æ²¡æœ‰åˆ æ‰ï¼Œåªæ˜¯åˆ æ‰äº†å¯¹å®ƒçš„å¼•ç”¨æ‰€ä»¥ c æ˜¯å¤šä½™çš„ï¼ˆå°±æ˜¯æˆ‘ä»¬ä¸Šè¯‰æåˆ°é‚£ç§æ¸…æƒ…å†µï¼‰ã€‚
-  A  -
|     |
a  -  b  -  c 

#æ­¤æ—¶é€šè¿‡GCæœºåˆ¶ä¹‹å Layer C è¢«åˆ é™¤æ‰äº†å³æ²¡æœ‰è¢«å¼•ç”¨çš„å±‚å°†è¢«å½»åº•åˆ é™¤;
-  A  -
|     |
a  -  b 
```

æ­¤å¤„å¯ä»¥å€Ÿé‰´registry GC çš„æºç æ–‡ä»¶ garbagecollect.go å¯ä»¥çœ‹åˆ° GC çš„ä¸»è¦åˆ†ä¸¤ä¸ªé˜¶æ®µ:

-   (1) marking é˜¶æ®µï¼šæ ¹æ®ä¸Šæ–‡æˆ‘ä»¬æåˆ°çš„ link æ–‡ä»¶ï¼Œé€šè¿‡æ‰«ææ‰€æœ‰é•œåƒ tags ç›®å½•ä¸‹çš„ link æ–‡ä»¶å°±å¯ä»¥å¾—åˆ°è¿™äº›é•œåƒçš„ manifestï¼Œåœ¨ manifest ä¸­ä¿å­˜åœ¨è¯¥é•œåƒæ‰€æœ‰çš„ layer å’Œ config æ–‡ä»¶çš„ digest å€¼ï¼ŒæŠŠè¿™äº›å€¼æ ‡è®°ä¸ºä¸èƒ½æ¸…é™¤ã€‚
    

```
markSet := make(map[digest.Digest]struct{})
manifestArr := make([]ManifestDel, 0)
err := repositoryEnumerator.Enumerate(ctx, func(repoName string) error {
emit(repoName)

var err error
named, err := reference.WithName(repoName)
if err != nil {
return fmt.Errorf("failed to parse repo name %s: %v", repoName, err)
}
repository, err := registry.Repository(ctx, named)
if err != nil {
return fmt.Errorf("failed to construct repository: %v", err)
}

manifestService, err := repository.Manifests(ctx)
if err != nil {
return fmt.Errorf("failed to construct manifest service: %v", err)
}

manifestEnumerator, ok := manifestService.(distribution.ManifestEnumerator)
if !ok {
return fmt.Errorf("unable to convert ManifestService into ManifestEnumerator")
}
```

-   (2) sweep é˜¶æ®µ:åˆ é™¤æ“ä½œå½“markingå®Œæˆä¹‹åæ²¡æœ‰æ ‡è®°blobs(layer å’Œ config)å°±ä¼šè¢«æ¸…ç†æ‰;
    

```
// sweep
vacuum := NewVacuum(ctx, storageDriver)
if !opts.DryRun {
for _, obj := range manifestArr {
err = vacuum.RemoveManifest(obj.Name, obj.Digest, obj.Tags)
if err != nil {
return fmt.Errorf("failed to delete manifest %s: %v", obj.Digest, err)
}
}
}
blobService := registry.Blobs()
deleteSet := make(map[digest.Digest]struct{})
err = blobService.Enumerate(ctx, func(dgst digest.Digest) error {
// check if digest is in markSet. If not, delete it!
if _, ok := markSet[dgst]; !ok {
deleteSet[dgst] = struct{}{}
}
return nil
})
```

![WeiyiGeek.marking and sweep](https://i0.hdslb.com/bfs/article/ae66874762b9c3ebf68acc583a016704306723ae.png@942w_486h_progressive.webp)

Q:é‚£ GC éƒ½å¹²äº†å•¥ï¼Ÿ

> ç­”: æˆ‘ä»¬å¯ä»¥åˆ©ç”¨registryå®¹å™¨ä¸­çš„`registry garbage-collect`å‘½ä»¤è¿›è¡ŒGCå›æ”¶æ“ä½œ;

```
$ docker exec -it registry sh -c "/bin/registry garbage-collect -m --delete-untagged=true /etc/docker/registry/config.yml"
/ # cat /etc/docker/registry/config.yml 
version: 0.1
log:
  fields:
    service: registry
storage:
  cache:
    blobdescriptor: inmemory
  filesystem:
    rootdirectory: /var/lib/registry  # å…³é”®ç‚¹
http:
  addr: :5000
  headers:
    X-Content-Type-Options: [nosniff]
health:
  storagedriver:
    enabled: true
    interval: 10s
    threshold: 3

# marking é˜¶æ®µ
library/alpine # Registryä¸­çš„é•œåƒæœªæ ‡è®°å°†ä¼šè¢«åˆ é™¤ 
library/debian 
library/debian: marking manifest sha256:e0a33348ac8cace6b4294885e6e0bb57ecdfe4b6e415f1a7f4c5da5fe3116e02
library/debian: marking blob sha256:c7346dd7f20ef06fd3c58446fab0c3edf22e78131d374775f5f947849537b773
library/debian: marking blob sha256:bf59529304463f62efa7179fa1a32718a611528cc4ce9f30c0d1bbc6724ec3fb

# sweep é˜¶æ®µ
3 blobs marked, 3 blobs and 0 manifests eligible for deletion
blob eligible for deletion: sha256:a15790640a6690aa1730c38cf0a440e2aa44aaca9b0e8931a9f2b0d7cc90fd65
INFO[0000] Deleting blob: /docker/registry/v2/blobs/sha256/a1/a15790640a6690aa1730c38cf0a440e2aa44aaca9b0e8931a9f2b0d7cc90fd65  go.version=go1.11.2 instance.id=fe470a94-4f51-4764-93e5-0f1d5d6172bf service=registry
blob eligible for deletion: sha256:a24bb4013296f61e89ba57005a7b3e52274d8edd3ae2077d04395f806b63d83e
INFO[0000] Deleting blob: /docker/registry/v2/blobs/sha256/a2/a24bb4013296f61e89ba57005a7b3e52274d8edd3ae2077d04395f806b63d83e  go.version=go1.11.2 instance.id=fe470a94-4f51-4764-93e5-0f1d5d6172bf service=registry
blob eligible for deletion: sha256:df20fa9351a15782c64e6dddb2d4a6f50bf6d3688060a34c4014b0d9a752eb4c
INFO[0000] Deleting blob: /docker/registry/v2/blobs/sha256/df/df20fa9351a15782c64e6dddb2d4a6f50bf6d3688060a34c4014b0d9a752eb4c  go.version=go1.11.2 instance.id=fe470a94-4f51-4764-93e5-0f1d5d6172bf service=registry
```

æ­¤æ—¶ç»è¿‡GCä¹‹åçš„Registry å­˜å‚¨ç›®å½•é•¿ä»€ä¹ˆæ ·å­?

```
$ tree /var/lib/registry/docker/registry/v2
/var/lib/registry/docker/registry/v2
â”œâ”€â”€ blobs
â”‚   â””â”€â”€ sha256
â”‚       â”œâ”€â”€ a1
â”‚       â”œâ”€â”€ a2
â”‚       â”œâ”€â”€ bf
â”‚       â”‚   â””â”€â”€ bf59529304463f62efa7179fa1a32718a611528cc4ce9f30c0d1bbc6724ec3fb
â”‚       â”‚       â””â”€â”€ data
â”‚       â”œâ”€â”€ c7
â”‚       â”‚   â””â”€â”€ c7346dd7f20ef06fd3c58446fab0c3edf22e78131d374775f5f947849537b773
â”‚       â”‚       â””â”€â”€ data
â”‚       â”œâ”€â”€ df
â”‚       â””â”€â”€ e0
â”‚           â””â”€â”€ e0a33348ac8cace6b4294885e6e0bb57ecdfe4b6e415f1a7f4c5da5fe3116e02
â”‚               â””â”€â”€ data
â””â”€â”€ repositories
    â””â”€â”€ library
        â”œâ”€â”€ alpine  # å¯ä»¥çœ‹è§é•œåƒåç§°å¹¶æœªåˆ é™¤
        â”‚   â”œâ”€â”€ _layers
        â”‚   â”‚   â””â”€â”€ sha256
        â”‚   â”‚       â”œâ”€â”€ a24bb4013296f61e89ba57005a7b3e52274d8edd3ae2077d04395f806b63d83e
        â”‚   â”‚       â”‚   â””â”€â”€ link
        â”‚   â”‚       â””â”€â”€ df20fa9351a15782c64e6dddb2d4a6f50bf6d3688060a34c4014b0d9a752eb4c
        â”‚   â”‚           â””â”€â”€ link
        â”‚   â”œâ”€â”€ _manifests
        â”‚   â”‚   â”œâ”€â”€ revisions
        â”‚   â”‚   â”‚   â””â”€â”€ sha256
        â”‚   â”‚   â”‚       â””â”€â”€ a15790640a6690aa1730c38cf0a440e2aa44aaca9b0e8931a9f2b0d7cc90fd65
        â”‚   â”‚   â””â”€â”€ tags
        â”‚   â””â”€â”€ _uploads
        â””â”€â”€ debian
            â”œâ”€â”€ _layers
            â”‚   â””â”€â”€ sha256
            â”‚       â”œâ”€â”€ bf59529304463f62efa7179fa1a32718a611528cc4ce9f30c0d1bbc6724ec3fb
            â”‚       â”‚   â””â”€â”€ link
            â”‚       â””â”€â”€ c7346dd7f20ef06fd3c58446fab0c3edf22e78131d374775f5f947849537b773
            â”‚           â””â”€â”€ link
            â”œâ”€â”€ _manifests
            â”‚   â”œâ”€â”€ revisions
            â”‚   â”‚   â””â”€â”€ sha256
            â”‚   â”‚       â””â”€â”€ e0a33348ac8cace6b4294885e6e0bb57ecdfe4b6e415f1a7f4c5da5fe3116e02
            â”‚   â”‚           â””â”€â”€ link
            â”‚   â””â”€â”€ tags
            â”‚       â””â”€â”€ buster-slim
            â”‚           â”œâ”€â”€ current
            â”‚           â”‚   â””â”€â”€ link
            â”‚           â””â”€â”€ index
            â”‚               â””â”€â”€ sha256
            â”‚                   â””â”€â”€ e0a33348ac8cace6b4294885e6e0bb57ecdfe4b6e415f1a7f4c5da5fe3116e02
            â”‚                       â””â”€â”€ link
            â””â”€â”€ _uploads
40 directories, 10 files
```

ç¤ºä¾‹1:æŸ¥çœ‹Dockerå®˜æ–¹é•œåƒä»“åº“ä¸­é•œåƒçš„æ‰€æœ‰æ ‡ç­¾

-   æ–¹å¼1:
    

```
#!/bin/sh
# set -xe 
# å…¶å®å®ç°æ–¹æ³•å°±æ˜¯é€šè¿‡é•œåƒä»“åº“çš„ restful APIï¼Œæ¥æŸ¥è¯¢ï¼Œç„¶åæŠŠè¿”å›çš„ json ç»“æœç®€å•å¤„ç†ä¸€ä¸‹ï¼Œç„¶åæ‰“å°å‡ºæ¥ã€‚
image_name=$1
repo_url=https://registry.hub.docker.com/v1/repositories
curl -s ${repo_url}/${image_name}/tags | jq | grep name | awk '{print $2}' | sed -e 's/"//g'
```

-   æ–¹å¼2:ä¸€æ¡å‘½ä»¤æå®š
    

```
skopeo inspect docker://docker.io/alpine | jq ".RepoTags"
```

ç¤ºä¾‹2.registryä¿¡æ¯æŸ¥çœ‹è„šæœ¬ä¸RegistryGCå›æ”¶è„šæœ¬

```
#!/bin/bash
# Description:æŸ¥çœ‹Registryä»“åº“ä¸­çš„é•œåƒä¿¡æ¯å¹¶ä»ä»“åº“ä¸­åˆ é™¤æŒ‡å®šé•œåƒï¼Œç„¶åè¿›è¡Œåƒåœ¾å›æ”¶
# Author:WeiyiGeek
# createTime:2020å¹´8æœˆ23æ—¥ 16:55:57
set -x

# [+ Defined]
PARM=$1
IMAGE_NAME=${2}
ACTION=${PARM:="NONE"}

REGISTRY_URL="https://localhost/v2"
REGISTRY_NAME="registry"
REGISTRY_HOME="/var/lib/registry/docker/registry/v2"
MANIFESTS_DIGEST=""
AUTH="Authorization: Basic d2VpeWlnZWVrOjEyMzQ1Ng=="

function Usage(){
  echo -e "\e[32mUsage: $0 {view} \e[0m"
  echo -e "\e[32m       $0 {tags} <image-name> \e[0m"
  echo -e "\e[32m       $0 {gc} <registry-container-name|container-id> \e[0m"
  echo -e "\e[32m       $0 {delete} <image-name> <reference> \e[0m"
  echo -e "\e[32m #æŸ¥çœ‹ä»“åº“ä¸­çš„é•œåƒä¿¡æ¯å¹¶ä»ä»“åº“ä¸­åˆ é™¤æŒ‡å®šé•œåƒï¼Œç„¶åè¿›è¡Œåƒåœ¾å›æ”¶ \e[0m"

  exit;
}

# [+ æ˜¾ç¤ºä»“åº“ä¸­çš„é•œåƒ]
function ViewRegistry(){
  curl -s -H "${AUTH}" "${REGISTRY_URL}/_catalog" | jq ".repositories"
}

# [+ æ˜¾ç¤ºä»“åº“ä¸­é•œåƒæ ‡è®°]
function ViewTags(){
  local FLAG=0
  local IMAGE_NAME=$1
  curl -s -H "${AUTH}" "${REGISTRY_URL}/_catalog" | jq ".repositories" > registry.repo
  sed -i "s#\[##g;s#]##g;s# ##g;s#\"##g;s#,##g;/^\s*$/d" registry.repo
  
  for i in $(cat registry.repo)
  do
    if [[ "$i" == "${IMAGE_NAME}" ]];then
      FLAG=1
      break
    fi
  done

  if [[ $FLAG -eq 1 ]];then
    curl -s -H "${AUTH}" "${REGISTRY_URL}/${IMAGE_NAME}/tags/list" | jq ".tags"
  else
    echo -e "\e[31m[ERROR]: Registry ä¸å­˜åœ¨ ${IMAGE_NAME} è¯¥é•œåƒ\e[0m"
    exit
  fi
}

# [+ ä»“åº“åºŸå¼ƒé•œåƒå›æ”¶] 
function GcRegistry(){
  docker exec -it $1 sh -c "/bin/registry garbage-collect -m --delete-untagged=true /etc/docker/registry/config.yml"
  if [[ $? -ne 0 ]];then
    echo -e "\e[31m[ERROR]:GC Failed! \e[0m"
    exit
  fi

  # åˆ é™¤ blobs/sha256ä¸­çš„ç©ºç›®å½•
  for i in $(find ${REGISTRY_HOME}/blobs/sha256/ | grep -v "data");do 
    if [[ $(ls -A $i|wc -c) -eq 0 ]];then 
      echo -e "[info]delete empty directory : ${i}"
      rm -rf ${i}
    fi
  done

  echo -e "[+ Registry restart ....]"
  docker restart $1
}


# [+ åˆ é™¤ä»“åº“ä¸­çš„é•œåƒ]
function Del() {
  local IMAGE_NAME=$1
  local TAGS=$2

  if [[ "$TAGS" != "" ]];then
    # éªŒè¯åˆ é™¤çš„é•œåƒæ˜¯å¦å­˜åœ¨
    curl -s -H "${AUTH}" -H 'Accept: application/vnd.docker.distribution.manifest.v2+json' "${REGISTRY_URL}/${IMAGE_NAME}/manifests/${TAGS}" > images.mainfests
    
    err_flag=$(grep -c '"errors"' images.mainfests)
    if [[ $err_flag -ne 0 ]];then
      echo -e "\e[31m[ERROR]:$(cat images.mainfests) \e[0m"
      exit
    fi

    # è·å–è¦åˆ é™¤é•œåƒçš„digestæ‘˜è¦
    MANIFESTS_DIGEST=$(curl -s -H "${AUTH}" -H 'Accept: application/vnd.docker.distribution.manifest.v2+json' "${REGISTRY_URL}/${IMAGE_NAME}/manifests/${TAGS}" | grep "Docker-Content-Digest:" | cut -f 2 -d " ")

    grep "digest" images.mainfests | sed 's# ##g;s#"##g;s#digest:##g' > images.digest
    echo ${MANIFESTS_DIGEST} >> images.digest

    # åˆ é™¤ é•œåƒ _Manifestsç›®å½•ä¸­çš„Tagsç›¸å…³ç›®å½•
    curl -v -H "${AUTH}" -H 'Accept: application/vnd.docker.distribution.manifest.v2+json' -X DELETE "${REGISTRY_URL}/${IMAGE_NAME}/manifests/${MANIFESTS_DIGEST}"
    
    # åˆ é™¤ é•œåƒ _Layer ç›®å½•ä¸‹çš„link
    for digest in $(cat images.digest);do
      curl -v -H "${AUTH}" -X DELETE "${REGISTRY_URL}/${IMAGE_NAME}/blobs/${digest}"
    done
  fi

  # GC å›æ”¶(æ³¨æ„å‚æ•°ä¸ºå®¹å™¨é•œåƒåç§°)
  GcRegistry ${REGISTRY_NAME}

  # åˆ¤æ–­ é•œåƒ æ˜¯å¦å­˜åœ¨å…¶å®ƒ tags ä¸å­˜åœ¨æ—¶å€™ç›´æ¥åˆ é™¤å…¶ç›®å½•
  $flag_tags=$(curl -s -H "${AUTH}" "${REGISTRY_URL}/${IMAGE_NAME}/tags/list" | jq ".tags") 
  if [[ -z $flag_tags ]];then
    rm -rf "${REGISTRY_HOME}/repositories/${IMAGE_NAME}"
  fi
  # åˆ é™¤ _layers ç›®å½•ä¸‹çš„digestæ–‡ä»¶ç©ºçš„ç›®å½•
  for i in $(find ${REGISTRY_HOME}/repositories/${IMAGE_NAME}/_layers/sha256/ | grep -v "link");do 
      if [[ $(ls -A $i|wc -c) -eq 0 ]];then 
        echo -e "[info]delete empty directory : ${i}"
        rm -rf ${i}
      fi
  done

  # åˆ é™¤ manifests ç›®å½•ä¸‹çš„digestæ–‡ä»¶ç©ºçš„ç›®å½•
  for i in $(find ${REGISTRY_HOME}/repositories/${IMAGE_NAME}/_manifests/revisions/sha256/ | grep -v "link");do 
      if [[ $(ls -A $i|wc -c) -eq 0 ]];then 
        echo -e "[info]delete empty directory : ${i}"
        rm -rf ${i}
      fi
  done
}


# [Main]
if [[ "$ACTION" = "NONE" ]];then
  Usage
elif [[ "$ACTION" = "view" ]];then
  ViewRegistry
elif  [[ "$ACTION" = "tags" ]];then
  ViewTags $2
elif  [[ "$ACTION" = "delete" ]];then
  Del $2 $3
elif  [[ "$ACTION" = "gc" ]];then
  GcRegistry $2
else
  Usage
fi

EOF
```

**ç« èŠ‚æ€»ç»“:**

-   (1) åœ¨GCä¹‹åregistryå­˜å‚¨ç›®å½•æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒåŸæœ¬blobsç›®å½•ä¸‹æœ‰6ä¸ªdataæ–‡ä»¶ç°åœ¨å·²ç»å˜æˆ3ä¸ªï¼Œè€Œalpine:3.12é•œåƒç›¸å…³çš„`Layerã€Configã€Manifest`æ–‡ä»¶å·²ç»è¢«GCæ¸…ç†æ‰äº†; ä½†æ˜¯åœ¨ repositories ç›®å½•ä¸‹ï¼Œè¯¥é•œåƒçš„ \_layers ä¸‹çš„ link æ–‡ä»¶ä¾æ—§å­˜åœ¨ğŸ¤”ã€‚
    
-   (2) æ€»ç»“ä»¥ä¸Šï¼Œç”¨ä¸‹é¢è¿™ä¸‰å¼ å›¾ç‰‡å°±èƒ½ç›´è§‚åœ°ç†è§£è¿™äº›è¿‡ç¨‹å•¦
    

-   2.1 delete é•œåƒä¹‹å‰çš„ registry å­˜å‚¨ç›®å½•ç»“æ„  
    

![WeiyiGeek.1](https://i0.hdslb.com/bfs/article/cb8da1fdb4418cc8fbccbae2bb3591491e9b9ee0.png@942w_563h_progressive.webp)

-   2.2 delete é•œåƒä¹‹åçš„ registry å­˜å‚¨ç›®å½•ç»“æ„  
    

![WeiyiGeek.2](https://i0.hdslb.com/bfs/article/acdd7f9e1697017820291a324de8cbd799c8a2a6.png@942w_569h_progressive.webp)

-   2.3 GC ä¹‹åçš„ registry å­˜å‚¨ç›®å½•ç»“æ„  
    

![WeiyiGeek.](https://i0.hdslb.com/bfs/article/15bdf5bc820a8e296cebf68057487e3ae3f066d5.png@942w_569h_progressive.webp)

-   (3) GC ä¹‹åä¸€å®šè¦é‡å¯ï¼Œå› ä¸º registry å®¹å™¨ç¼“å­˜äº†é•œåƒ layer çš„ä¿¡æ¯å½“åˆ é™¤æ‰ä¸€ä¸ªé•œåƒ A åè¾¹ GC æ‰è¯¥é•œåƒçš„ layer ä¹‹åï¼Œå¦‚æœä¸é‡å¯ registry å®¹å™¨ï¼Œ`å½“é‡æ–° PUSH é•œåƒ A çš„æ—¶å€™å°±ä¼šæç¤ºé•œåƒ layer å·²ç»å­˜åœ¨ï¼Œä¸ä¼šé‡æ–°ä¸Šä¼  layer ä½†å®é™…ä¸Šå·²ç»è¢« GC æ‰äº†ï¼Œæœ€ç»ˆä¼šå¯¼è‡´é•œåƒ A ä¸å®Œæ•´æ— æ³• pull åˆ°è¯¥é•œåƒ`ã€‚
    
-   (4) GC ä¸æ˜¯äº‹åŠ¡æ€§æ“ä½œï¼Œæ‰€ä»¥åœ¨è¿›è¡Œ GC çš„æ—¶å€™æœ€å¥½æš‚åœ PUSH é•œåƒï¼Œä»¥å…æŠŠæ­£åœ¨ä¸Šä¼ çš„é•œåƒ layer ç»™ GC æ‰ã€‚
    

```
# é…ç½®ç‰ˆæœ¬
version: 0.1
# æ—¥å¿—é…ç½®æ—¥å¿—ç³»ç»Ÿçš„è¡Œä¸º
log:
  # è®¿é—®æ—¥å¿—ç³»ç»Ÿçš„ACCESSLOGé…ç½®è¡Œä¸º
  accesslog:
    disabled: true 
  # æ—¥å¿—è¾“å‡ºçš„æ ¼å¼é»˜è®¤info.Permitted values are error, warn, info, debug
  level: debug 
  # æ—¥å¿—è¾“å‡ºçš„æ ¼å¼é»˜è®¤ text , json, and logstash
  formatter: text
  # å­—æ®µåç§°çš„åœ°å›¾
  fields:
    service: registry
    environment: staging
  # é…ç½®æ—¥å¿—è®°å½•æŒ‚é’©çš„è¡Œä¸º
  hooks:
    - type: mail
      disabled: true
      levels:
        - panic
      options:
        smtp:
          addr: mail.example.com:25
          username: mailuser
          password: password
          insecure: true
        from: sender@example.com
        to:
          - errors@example.com
# æ—¥å¿—ç­‰çº§(error, warn, info, debug):deprecated: use "log"
loglevel: debug
# å­˜å‚¨åç«¯é…ç½®å¿…é¡»
storage:
  # ä½¿ç”¨æœ¬åœ°ç£ç›˜å­˜å‚¨æ³¨å†Œè¡¨æ–‡ä»¶
  filesystem:
    rootdirectory: /var/lib/registry
    maxthreads: 100
  azure:
    accountname: accountname
    accountkey: base64encodedaccountkey
    container: containername
  # Google Cloud Storage
  gcs:
    bucket: bucketname
    keyfile: /path/to/keyfile
    credentials:
      type: service_account
      project_id: project_id_string
      private_key_id: private_key_id_string
      private_key: private_key_string
      client_email: client@example.com
      client_id: client_id_string
      auth_uri: http://example.com/auth_uri
      token_uri: http://example.com/token_uri
      auth_provider_x509_cert_url: http://example.com/provider_cert_url
      client_x509_cert_url: http://example.com/client_cert_url
    rootdirectory: /gcs/object/name/prefix
    chunksize: 5242880
  # Amazon Simple Storage Service (S3)
  s3:
    accesskey: awsaccesskey
    secretkey: awssecretkey
    region: us-west-1
    regionendpoint: http://myobjects.local
    bucket: bucketname
    encrypt: true
    keyid: mykeyid
    secure: true
    v4auth: true
    chunksize: 5242880
    multipartcopychunksize: 33554432
    multipartcopymaxconcurrency: 100
    multipartcopythresholdsize: 33554432
    rootdirectory: /s3/object/name/prefix
  # Openstack Swift object storage. 
  swift:
    username: username
    password: password
    authurl: https://storage.myprovider.com/auth/v1.0 or https://storage.myprovider.com/v2.0 or https://storage.myprovider.com/v3/auth
    tenant: tenantname
    tenantid: tenantid
    domain: domain name for Openstack Identity v3 API
    domainid: domain id for Openstack Identity v3 API
    insecureskipverify: true
    region: fr
    container: containername
    rootdirectory: /swift/object/name/prefix
  # Aliyun OSS for object storage
  oss:
    accesskeyid: accesskeyid
    accesskeysecret: accesskeysecret
    region: OSS region name
    endpoint: optional endpoints
    internal: optional internal endpoint
    bucket: OSS bucket
    encrypt: optional data encryption setting
    secure: optional ssl setting
    chunksize: optional size valye
    rootdirectory: optional root directory
  inmemory:  # This driver takes no parameters
  # ä½¿ç”¨deleteç»“æ„å…è®¸é€šè¿‡æ‘˜è¦åˆ é™¤æ˜ åƒblobå’Œæ¸…å•
  delete:
    enabled: false
  redirect:
    disable: false
  # ä½¿ç”¨é«˜é€Ÿç¼“å­˜ç»“æ„ï¼Œä»¥ä¾¿èƒ½å¤Ÿåœ¨å­˜å‚¨åç«¯è®¿é—®çš„æ•°æ®ç¼“å­˜ã€‚ç›®å‰å”¯ä¸€å¯ç”¨çš„é«˜é€Ÿç¼“å­˜æä¾›å¯¹å±‚çš„å…ƒæ•°æ®ï¼Œå®ƒä½¿ç”¨blobdescriptorå­—æ®µå¦‚æœé…ç½®çš„å¿«é€Ÿè®¿é—®ã€‚
  cache:
    # å¦‚æœè®¾ç½®ä¸ºRedisçš„ï¼Œä¸€ä¸ªRedisçš„ç¼“å­˜æ± å…ƒæ•°æ®å±‚ã€‚å¦‚æœè®¾ç½®ä¸ºinmemoryï¼Œä¸€ä¸ªinmemoryåœ°å›¾ç¼“å­˜å±‚çš„å…ƒæ•°æ®ã€‚
    blobdescriptor: redis
  # ç»´æŠ¤ç»´ä¿®
  maintenance:
    # ä¸Šä¼ æ¸…é™¤
    uploadpurging:
      enabled: true
      age: 168h
      interval: 24h
      dryrun: false
      # å¦‚æœåœ¨ç»´æŠ¤åªè¯»éƒ¨åˆ†ï¼Œä½¿è®¾ç½®ä¸ºtrueï¼Œå®¢æˆ·ç«¯å°†ä¸ä¼šè¢«å…è®¸å†™å…¥æ³¨å†Œè¡¨ã€‚
    readonly:
      enabled: false
# è®¤è¯ç›¸å…³(åªèƒ½é…ç½®ä¸€ä¸ªèº«ä»½éªŒè¯æä¾›è€…ã€‚)
auth:
  silly:
    # ä½¿ç”¨èŒƒå›´
    realm: silly-realm
    service: silly-service
  # ä»¤ç‰Œçš„è®¤è¯æ‚¨å¯ä»¥ä»registryä¸­åˆ†ç¦»è®¤è¯ç³»ç»Ÿ
  token:
    autoredirect: true
    realm: token-realm
    service: token-service
    issuer: registry-token-issuer
    rootcertbundle: /root/certs/bundle
  # æ”¯æŒhtpasswdçš„è®¤è¯å…è®¸æ‚¨ä½¿ç”¨çš„æ˜¯Apacheçš„htpasswdæ–‡ä»¶æ¥é…ç½®åŸºæœ¬èº«ä»½éªŒè¯
  htpasswd:
    realm: basic-realm
    # å”¯ä¸€æ”¯æŒçš„å¯†ç æ ¼å¼æ˜¯bcryptã€‚
    path: /path/to/htpasswd
  
middleware:
  registry:
    - name: ARegistryMiddleware
      options:
        foo: bar
  repository:
    - name: ARepositoryMiddleware
      options:
        foo: bar
  storage:
    - name: cloudfront
      options:
        baseurl: https://my.cloudfronted.domain.com/
        privatekey: /path/to/pem
        keypairid: cloudfrontkeypairid
        duration: 3000s
        ipfilteredby: awsregion
        awsregion: us-east-1, use-east-2
        updatefrenquency: 12h
        iprangesurl: https://ip-ranges.amazonaws.com/ip-ranges.json
  storage:
    - name: redirect
      options:
        baseurl: https://example.com/
# æŠ¥è¡¨
reporting:
  bugsnag:
    apikey: bugsnagapikey
    releasestage: bugsnagreleasestage
    endpoint: bugsnagendpoint
  newrelic:
    licensekey: newreliclicensekey
    name: newrelicname
    verbose: true
# HTTPæœåŠ¡å™¨ä¸»æœºä¸Šçš„æ³¨å†Œè¡¨ä¸­çš„é…ç½®
http:
  addr: localhost:5000
  prefix: /my/nested/registry/
  host: https://myregistryaddress.org:5000
  secret: asecretforlocaldevelopment
  relativeurls: false
  draintimeout: 60s
  tls:
    certificate: /path/to/x509/public
    key: /path/to/x509/private
    clientcas:
      - /path/to/ca.pem
      - /path/to/another/ca.pem
    letsencrypt:
      cachefile: /path/to/cache-file
      email: emailused@letsencrypt.com
      hosts: [myregistryaddress.org]
  debug:
    addr: localhost:5001
    # ç›‘æ§
    prometheus:
      enabled: true
      path: /metrics
  # å®ƒæ¥æŒ‡å®šæŠ¥å¤´çš„HTTPæœåŠ¡å™¨åº”è¯¥åœ¨å“åº”ï¼›
  headers:
    X-Content-Type-Options: [nosniff]
  http2:
    disabled: false
# é€šçŸ¥å…¬å‘Š
notifications:
  events:
    includereferences: true
  # å¯ä»¥æ¥å—çš„äº‹ä»¶é€šçŸ¥çš„æ¸…å•
  endpoints:
    - name: alistener
      disabled: false
      url: https://my.listener.com/event
      headers: <http.Header>
      timeout: 1s
      threshold: 10
      backoff: 1s
      ignoredmediatypes:
        - application/octet-stream
      ignore:
        mediatypes:
           - application/octet-stream
        actions:
           - pull
# redis ç›¸å…³é…ç½®
redis:
  addr: localhost:6379
  password: asecret
  db: 0
  dialtimeout: 10ms
  readtimeout: 10ms
  writetimeout: 10ms
  pool:
    maxidle: 16
    maxactive: 64
    idletimeout: 300s
# å¥åº·æ£€æŸ¥
health:
  storagedriver:
    enabled: true
    interval: 10s
    threshold: 3
  # æ–‡ä»¶ç»“æ„åŒ…æ‹¬è¦å®šæœŸæ£€æŸ¥çš„è·¯å¾„çš„åˆ—è¡¨ä¸ºä¸€ä¸ªæ–‡ä»¶çš„\å­˜åœ¨ã€‚å¦‚æœæ–‡ä»¶å­˜åœ¨äºæŒ‡å®šçš„è·¯å¾„ï¼Œå¥åº·æ£€æŸ¥å°†å¤±è´¥ã€‚æ‚¨å¯ä»¥ä½¿ç”¨è¿™ä¸€æœºåˆ¶é€šè¿‡åˆ›å»ºä¸€ä¸ªæ–‡ä»¶ï¼Œä½¿æ³¨å†Œè¡¨è¿›è¡Œæ—‹è½¬ã€‚
  file:
    - file: /path/to/checked/file
      interval: 10s
  http:
    - uri: http://server.to.check/must/return/200
      headers:
        Authorization: [Basic QWxhZGRpbjpvcGVuIHNlc2FtZQ==]
      statuscode: 200
      timeout: 3s
      interval: 10s
      threshold: 3
  tcp:
    - addr: redis-server.domain.com:6379
      timeout: 3s
      interval: 10s
      threshold: 3

proxy:
  remoteurl: https://registry-1.docker.io
  username: [username]
  password: [password]

compatibility:
  schema1:
    signingkeyfile: /etc/registry/key.json
    enabled: true
    
# éªŒè¯
validation:
  manifests:
    urls:
      allow:
        - ^https?://([^/]+\.)*example\.com/
      deny:
        - ^https?://www\.example\.com/
```

è‡³æ­¤æœ¬èŠ‚å®Œæ¯•ï¼Œæ•¬è¯·æœŸå¾…ä¸‹ä¸€å°èŠ‚å†…å®¹ã€‚

Dockerå®¹å™¨æŠ€æœ¯å…¥é—¨å®è·µç³»åˆ—å†å²å·²å‘å¸ƒæ–‡ç« ï¼ˆç‚¹å‡»å³å¯è¿›å…¥ï¼‰ï¼š

[1.æˆ‘åœ¨Bç«™å­¦äº‘åŸç”Ÿä¹‹Dockerå®¹å™¨æŠ€æœ¯åŸºç¡€çŸ¥è¯†ä»‹ç»](https://www.bilibili.com/read/cv15180540)

[2.æˆ‘åœ¨Bç«™å­¦äº‘åŸç”Ÿä¹‹Dockerå®¹å™¨ç¯å¢ƒå®‰è£…å®è·µ](https://www.bilibili.com/read/cv15181036)

[3.æˆ‘åœ¨Bç«™å­¦äº‘åŸç”Ÿä¹‹Dockerå®¹å™¨ä¸‰å¤§æ ¸å¿ƒæ¦‚å¿µä»‹ç»](https://www.bilibili.com/read/cv15181760)

[4.æˆ‘åœ¨Bç«™å­¦äº‘åŸç”Ÿä¹‹Dockerå®¹å™¨æ•°æ®æŒä¹…åŒ–ä»‹ç»ä¸å®è·µ](https://www.bilibili.com/read/cv15182308)

[5.æˆ‘åœ¨Bç«™å­¦äº‘åŸç”Ÿä¹‹Dockerå®¹å™¨ç½‘ç»œä»‹ç»ä¸å®è·µ](https://www.bilibili.com/read/cv15185166)

[6.æˆ‘åœ¨Bç«™å­¦äº‘åŸç”Ÿä¹‹Dockerå®¹å™¨Registryç§æœ‰é•œåƒä»“åº“æ­å»ºå®è·µ](https://www.bilibili.com/read/cv15219863)

[7.æˆ‘åœ¨Bç«™å­¦äº‘åŸç”Ÿä¹‹Dockerå®¹å™¨Dockerfileé•œåƒæ„å»ºæµ…æä¸å®è·µ](https://www.bilibili.com/read/cv15220707)

[8.æˆ‘åœ¨Bç«™å­¦äº‘åŸç”Ÿä¹‹Dockerå®¹å™¨é•œåƒæ„å»ºæœ€ä½³å®è·µæµ…æ](https://www.bilibili.com/read/cv15220861)

[9.æˆ‘åœ¨Bç«™å­¦äº‘åŸç”Ÿä¹‹Dockerå®¹å™¨ä¼˜åŒ–é•œåƒä½“ç§¯ç¼©å°æŠ€å·§å®è·µ](https://www.bilibili.com/read/cv15226873)

[10.æˆ‘åœ¨Bç«™å­¦äº‘åŸç”Ÿä¹‹Dockerå®¹å™¨æŠ€æœ¯è¿›é˜¶çŸ¥è¯†ä»‹ç»](https://www.bilibili.com/read/cv15227279)

[11.æˆ‘åœ¨Bç«™å­¦äº‘åŸç”Ÿä¹‹Dockerå®¹å™¨ç¼–æ’å·¥å…·docker-composeå®‰è£…ä½¿ç”¨å®è·µ](https://www.bilibili.com/read/cv15227639)

[12.æˆ‘åœ¨Bç«™å­¦äº‘åŸç”Ÿä¹‹Dockerå®¹å™¨åº•å±‚åŸç†æµ…æ](https://www.bilibili.com/read/cv15228563)

[13.æˆ‘åœ¨Bç«™å­¦äº‘åŸç”Ÿä¹‹Dockerå®¹å™¨é•œåƒæ„å»ºå­˜å‚¨åŸç†æµ…æä¸å®è·µ](https://www.bilibili.com/read/cv15229214)

![](https://i0.hdslb.com/bfs/article/4adb9255ada5b97061e610b682b8636764fe50ed.png@progressive.webp)

> æ¬¢è¿å„ä½å¿—åŒé“åˆçš„æœ‹å‹ä¸€èµ·å­¦ä¹ äº¤æµï¼Œå¦‚æ–‡ç« æœ‰è¯¯è¯·åœ¨ä¸‹æ–¹ç•™ä¸‹æ‚¨å®è´µçš„ç»éªŒçŸ¥è¯†ï¼Œä¸ªäººé‚®ç®±åœ°å€ã€master#weiyigeek.topã€‘æˆ–è€…Â ä¸ªäººå…¬ä¼—å·ã€WeiyiGeekã€‘è”ç³»æˆ‘ã€‚

![](https://i0.hdslb.com/bfs/article/02db465212d3c374a43c60fa2625cc1caeaab796.png@progressive.webp)

æ›´å¤šæ–‡ç« æ¥æºäºã€WeiyiGeek Blog - ä¸ºäº†èƒ½åˆ°è¿œæ–¹ï¼Œè„šä¸‹çš„æ¯ä¸€æ­¥éƒ½ä¸èƒ½å°‘ã€‘ ä¸ªäººåšå®¢ã€‚

åšå®¢åœ°å€: https://weiyigeek.topÂ 

![](https://i0.hdslb.com/bfs/article/9a9cef9d789c08c7d7cb209475b46586777c9d26.png@942w_579h_progressive.webp)

ä¸“æ ä¹¦å†™ä¸æ˜“ï¼Œå¦‚æœæ‚¨è§‰å¾—è¿™ä¸ªä¸“æ è¿˜ä¸é”™çš„ï¼Œè¯·ç»™è¿™ç¯‡ä¸“æ ã€ç‚¹ä¸ªèµã€æŠ•ä¸ªå¸ã€æ”¶ä¸ªè—ã€å…³ä¸ªæ³¨ï¼Œè½¬ä¸ªå‘ã€‘ï¼Œè¿™å°†å¯¹æˆ‘çš„è‚¯å®šï¼Œè°¢è°¢ï¼ã€‚

-   echoÂ Â "ã€ç‚¹ä¸ªèµã€‘ï¼ŒåŠ¨åŠ¨ä½ é‚£ç²—å£®çš„æ‹‡æŒ‡æˆ–è€…èŠŠèŠŠç‰æ‰‹ï¼Œäº²ï¼"
    
-   printf("%s",Â "ã€æŠ•ä¸ªå¸ã€‘ï¼Œä¸‡æ°´åƒå±±æ€»æ˜¯æƒ…ï¼ŒæŠ•ä¸ªç¡¬å¸è¡Œä¸è¡Œï¼Œäº²ï¼")
    
-   fmt.Printf("ã€æ”¶ä¸ªè—ã€‘ï¼Œé˜…åå³ç„šä¸åƒç°ï¼Œäº²ï¼")Â Â 
    
-   System.out.println("ã€å…³ä¸ªæ³¨ã€‘ï¼Œåç»­æµè§ˆæŸ¥çœ‹ä¸è¿·è·¯å“Ÿï¼Œäº²ï¼")
    
-   console.info("ã€è½¬ä¸ªå‘ã€‘ï¼Œè®©æ›´å¤šçš„å¿—åŒé“åˆçš„æœ‹å‹ä¸€èµ·å­¦ä¹ äº¤æµï¼Œäº²ï¼")