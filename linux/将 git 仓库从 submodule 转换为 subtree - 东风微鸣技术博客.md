## 三个脚本[](https://ewhisper.cn/posts/58551/#%E4%B8%89%E4%B8%AA%E8%84%9A%E6%9C%AC)

### Alexander Mikhailian[](https://ewhisper.cn/posts/58551/#Alexander-Mikhailian)

<table><tbody><tr><td><pre><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br></pre></td><td><pre><code>cat .gitmodules |<span>while</span> <span>read</span> i<br><span>do</span><br>  <span>if</span> [[<span>$i</span> == \[submodule*]]; <span>then</span><br>    mpath=$(<span>echo</span> <span>$i</span> | cut -d\" -f2)<br>    <span>read</span> i; <span>read</span> i;<br>    murl=$(<span>echo</span> <span>$i</span>|cut -d\  -f3)<br>    mcommit=`<span>eval</span> <span>"git submodule status <span>${mpath}</span> |cut -d\  -f2"</span>`<br>    mname=$(basename <span>$mpath</span>)<br>    <span>echo</span> -e <span>"<span>$name</span>\t<span>$mpath</span>\t<span>$murl</span>\t<span>$mcommit</span>"</span><br>    git submodule deinit <span>$mpath</span><br>    git rm -r --cached <span>$mpath</span><br>    rm -rf <span>$mpath</span><br>    git remote add <span>$mname</span> <span>$murl</span><br>    git fetch <span>$mname</span><br>    git branch _<span>$mname</span> <span>$mcommit</span><br>    git read-tree --prefix=<span>$mpath</span>/ -u _<span>$mname</span><br><span>fi</span><br><span>done</span><br>git rm .gitmodules<br></code><p><i></i>BASH</p></pre></td></tr></tbody></table>

> 🐾**Warning**:
> 
> 下文的两个脚本, 写死了 branch 是 master, 如果主分支不是 master, 需要做相应修改.

### Nikita240 - Stack Overflow[](https://ewhisper.cn/posts/58551/#Nikita240-Stack-Overflow)

> 📚️**Reference**:  
> 我对它进行了修改和改进。现在，新的 subtree 将指向与旧 submodule 相同的提交。以前，脚本只是从目标存储库下载最新的提交，这可能会导致兼容性问题。

<table><tbody><tr><td><pre><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br><span>33</span><br><span>34</span><br><span>35</span><br><span>36</span><br><span>37</span><br><span>38</span><br><span>39</span><br><span>40</span><br><span>41</span><br><span>42</span><br><span>43</span><br><span>44</span><br><span>45</span><br><span>46</span><br><span>47</span><br><span>48</span><br><span>49</span><br><span>50</span><br><span>51</span><br></pre></td><td><pre><code><span>#!/bin/bash -x</span><br><span># This script will convert all your git submodules into git subtrees.</span><br><span># This script ensures that your new subtrees point to the same commits as the</span><br><span># old submodules did, unlike most other scripts that do this.</span><br><span># THIS SCRIPT MUST BE PLACED OUTSIDE OF YOUR REPOSITORY!!!!!!!!!!</span><br><span># Otherwise, the script will interfere with the git commits.</span><br><span># Save the script in your home directory as `~/subtrees.sh`</span><br><span># `cd` into your repository</span><br><span># Run `~/subtrees.sh`</span><br><span># Enjoy!</span><p><span># extract the list of submodules from .gitmodule</span><br>cat .gitmodules |<span>while</span> <span>read</span> i<br><span>do</span><br><span>if</span> [[<span>$i</span> == \[submodule*]]; <span>then</span><br>    <span>echo</span> converting <span>$i</span><br>    <span>read</span> i<br>    <span># extract the module's prefix</span><br>    mpath=$(<span>echo</span> <span>$i</span> | grep -E <span>"(\S+)$"</span> -o)<br>    <span>echo</span> path: <span>$mpath</span><br>    <span>read</span> i<br>    <span># extract the url of the submodule</span><br>    murl=$(<span>echo</span> <span>$i</span>|cut -d\= -f2|xargs)<br>    <span>echo</span> url: <span>$murl</span><br>    <span># extract the module name</span><br>    mname=$(basename <span>$mpath</span>)<br>    <span>echo</span> name: <span>$mname</span><br>    <span># extract the referenced commit</span><br>    mcommit=$(git submodule status <span>$mpath</span> | grep -E <span>"\S+"</span> -o | head -1)<br>    <span>echo</span> commit: <span>$mcommit</span><br>    <span># deinit the module</span><br>    git submodule deinit <span>$mpath</span><br>    <span># remove the module from git</span><br>    git rm -r --cached <span>$mpath</span><br>    <span># remove the module from the filesystem</span><br>    rm -rf <span>$mpath</span><br>    <span># commit the change</span><br>    git commit -m <span>"Removed <span>$mpath</span> submodule at commit <span>$mcommit</span>"</span><br>    <span># add the remote</span><br>    git remote add -f <span>$mname</span> <span>$murl</span><br>    <span># add the subtree</span><br>    git subtree add --prefix <span>$mpath</span> <span>$mcommit</span> --squash<br>    <span># commit any left over uncommited changes</span><br>    git commit -a -m <span>"<span>$mname</span> cleaned up"</span><br>    <span># fetch the files</span><br>    git fetch <span>$murl</span> master<br>    <span>echo</span><br><span>fi</span><br><span>done</span><br>git rm .gitmodules<br>git commit -a -m <span>"Removed .gitmodules"</span></p></code><p><i></i>BASH</p></pre></td></tr></tbody></table>

### GaspardP - Stack Overflow[](https://ewhisper.cn/posts/58551/#GaspardP-Stack-Overflow)

> 📚️**Reference**:
> 
> 我稍微修改了一下，调用 `subtree add` 而不是 `read-tree`。它将从`.gitmodule` 中获取 submodule 的列表，并提取模块的前缀、名称和网址。然后它删除每个 submodule，并在同一位置添加它们作为 subtree。它还将每个 submodule 的 remote 添加为 remote，这样你就可以通过提供它的名字而不是它的网址来更新 subtree 了（即 `git subtree pull -P Foo Foo master --squash` 而不是`git subtree pull -P Foo https://example.com/foo.git master --squash`）。
> 
> 如果你想把 subtree 的全部历史导入你的版本库，你可以去掉 `--squash` 参数。使用 `--squash`，将只导入 subtree 的 HEAD 到你的版本库。这可能是大多数人想要的。

<table><tbody><tr><td><pre><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br><span>33</span><br><span>34</span><br><span>35</span><br><span>36</span><br><span>37</span><br><span>38</span><br><span>39</span><br><span>40</span><br><span>41</span><br><span>42</span><br></pre></td><td><pre><code><span>#!/bin/bash -x</span><br><span># extract the list of submodules from .gitmodule</span><br>cat .gitmodules |<span>while</span> <span>read</span> i<br><span>do</span><br><span>if</span> [[<span>$i</span> == \[submodule*]]; <span>then</span><br>    <span>echo</span> converting <span>$i</span><p>    <span># extract the module's prefix</span><br>    mpath=$(<span>echo</span> <span>$i</span> | cut -d\" -f2)</p><p>    <span># skip two lines</span><br>    <span>read</span> i; <span>read</span> i;</p><p>    <span># extract the url of the submodule</span><br>    murl=$(<span>echo</span> <span>$i</span>|cut -d\= -f2|xargs)</p><p>    <span># extract the module name</span><br>    mname=$(basename <span>$mpath</span>)</p><p>    <span># deinit the module</span><br>    git submodule deinit <span>$mpath</span></p><p>    <span># remove the module from git</span><br>    git rm -r --cached <span>$mpath</span></p><p>    <span># remove the module from the filesystem</span><br>    rm -rf <span>$mpath</span></p><p>    <span># commit the change</span><br>    git commit -m <span>"Removed <span>$mpath</span> submodule"</span></p><p>    <span># add the remote</span><br>    git remote add -f <span>$mname</span> <span>$murl</span></p><p>    <span># add the subtree</span><br>    git subtree add --prefix <span>$mpath</span> <span>$mname</span> master --squash</p><p>    <span># fetch the files</span><br>    git fetch <span>$murl</span> master<br><span>fi</span><br><span>done</span><br>git rm .gitmodules</p></code><p><i></i>BASH</p></pre></td></tr></tbody></table>

## 📚️参考文档[](https://ewhisper.cn/posts/58551/#%F0%9F%93%9A%EF%B8%8F%E5%8F%82%E8%80%83%E6%96%87%E6%A1%A3%20-15)

-   [Convert a git repository from submodules to subtrees | Alexander Mikhailian (mova.org)](http://mikhailian.mova.org/node/233)
-   [Convert Git submodule to subtree - Stack Overflow](https://stackoverflow.com/questions/28215244/convert-git-submodule-to-subtree)