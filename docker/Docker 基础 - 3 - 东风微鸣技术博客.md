## Web 服务器与应用[](https://ewhisper.cn/posts/37110/#Web-%20%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8E%E5%BA%94%E7%94%A8)

### Nginx[](https://ewhisper.cn/posts/37110/#Nginx)

> [我的 Nginx Docker 镜像](https://hub.docker.com/r/caseycui/nginx/)

<table><tbody><tr><td><pre><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br><span>33</span><br><span>34</span><br><span>35</span><br><span>36</span><br></pre></td><td><pre><code><span>## 设置继承自己创建的 sshd 镜像</span><br><span>FROM</span> caseycui/ubuntu-sshd<p><span>## 维护者</span><br><span>LABEL</span><span> maintainer=<span>"CaseyCui cuikaidong@foxmail.com"</span></span></p><p><span>## 安装 nginx</span><br><span>RUN</span><span> apt-get update \</span><br><span>    &amp;&amp; DEBIAN_FRONTEND=noninteractive apt-get install -yq --no-install-recommends \</span><br><span>        nginx \</span><br><span>        geoip-bin \</span><br><span>        fcgiwrap \</span><br><span>        ssl-cert \</span><br><span>    &amp;&amp; rm -rf /var/lib/apt/lists/* \</span><br><span>    &amp;&amp; chown -R www-data:www-data /var/lib/nginx</span></p><p><span>## 添加脚本，并设置权限</span><br><span>COPY</span><span> run-nginx.sh /run-nginx.sh</span><br><span>##RUN chmod 755 /run-nginx.sh</span></p><p><span>## 定义工作目录</span><br><span>WORKDIR</span><span> /etc/nginx</span></p><p><span>## 添加挂载点 /var/www</span><br><span>VOLUME</span><span> /var/www</span></p><p><span>## forward request and error logs to docker log collector</span><br><span>RUN</span><span> ln -sf /dev/stdout /var/<span>log</span>/nginx/access.log \</span><br><span>        &amp;&amp; ln -sf /dev/stderr /var/<span>log</span>/nginx/error.log</span></p><p><span>## 定义输出端口</span><br><span>EXPOSE</span> <span>80</span><br><span>EXPOSE</span> <span>443</span></p><p><span>## 定义输出命令</span><br><span>CMD</span><span> [<span>"/run-nginx.sh"</span>]</span></p></code><p><i></i>DOCKERFILE</p></pre></td></tr></tbody></table>

_[run-nginx.sh](http://run-nginx.sh/)_ 脚本:

<table><tbody><tr><td><pre><span>1</span><br><span>2</span><br></pre></td><td><pre><code><span>## nginx 以 daemon off 形式启动</span><br>/usr/sbin/nginx -g <span>"daemon off;"</span><br></code><p><i></i>BASH</p></pre></td></tr></tbody></table>

> **为什么需要 `daemon off;` ?**
> 
> 想象这样的场景:
> 
> 如果没有 daemon off, nginx 后台运行, 这时 nginx 并不是 pid 为 1 的程序, 而是执行的其他(如 bash), 这个 bash 执行了 nginx 指令后就结束了, 容器也会随之退出.
> 
> **或直接修改 /etc/nginx/nginx.conf 文件**:
> 
> `echo -e "\ndaemon off;" >> /etc/nginx/nginx.conf`

### Tomcat[](https://ewhisper.cn/posts/37110/#Tomcat)

Tomcat 最初是由 Sun 的软件架构师詹姆斯. 邓肯. 戴维森 开发的, 后来在他的帮助下称为开源项目, 并由 Sun 贡献给 Apache 软件基金会.

Tomcat 主要功能: 运行 JSP 页面和 Servlet.

#### JAVA[](https://ewhisper.cn/posts/37110/#JAVA)

企业通常使用 Sun JDK 6 或 Oracle JDK 7+. Dockerfile 如下:

<table><tbody><tr><td><pre><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br><span>33</span><br><span>34</span><br><span>35</span><br><span>36</span><br></pre></td><td><pre><code><span>FROM</span> caseycui/ubuntu-sshd<p><span>LABEL</span><span> maintainer=<span>"CaseyCui cuikaidong@foxmail.com"</span></span></p><p><span>## 创建 /java 目录</span><br><span>RUN</span><span> mkdir /java</span></p><p><span>## 解压 jdk 压缩包到 /java 目录</span><br><span>ADD</span><span> jdk-7u80-linux-x64.tar.gz /java</span></p><p><span>## 1. 删除 src.zip，减少镜像 size</span><br><span>## ~~2. 配置 JAVA 环境变量~~</span><br><span>## ~~3. 使生效~~</span><br><span>## 下面为几种不同的 echo 写法（配置 ENV 则不需要手动在 /etc/profile 里添加）</span><br><span>## =======================================================</span><br><span>## echo -e "\nexport JAVA_HOME=/java/jdk1.7.0_80\nexport PATH=/java/jdk1.7.0_80/bin:$PATH\nexport CLASSPATH=.:/java/jdk1.7.0_80/lib/dt.jar:/java/jdk1.7.0_80/lib/tools.jar" &gt;&gt; /etc/profile</span><br><span>## =======================================================</span><br><span>## RUN { \</span><br><span>##                 echo; \</span><br><span>##                 echo 'export JAVA_HOME=/java/jdk1.7.0_80'; \</span><br><span>##                 echo 'export PATH=$JAVA_HOME/bin:$PATH'; \            </span><br><span>##                 echo 'export CLASSPATH=.:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar'; \</span><br><span>##         } &gt;&gt; /etc/profile \</span><br><span>##     &amp;&amp; source /etc/profile \</span><br><span>##     &amp;&amp; rm -f /java/jdk1.7.0_80/src.zip</span><br><span>## =======================================================</span></p><p><span>RUN</span><span> rm -f /java/jdk1.7.0_80/src.zip</span></p><p><span>## 配置 ENV</span><br><span>## &gt; The environment variables set using `ENV` will persist when a container is run from the resulting image.</span></p><p><span>ENV</span> JAVA_HOME /java/jdk1.<span>7.0</span>_80<br><span>ENV</span> JAVA_VERSION <span>7</span>u80<br><span>ENV</span> PATH $JAVA_HOME/bin:$PATH<br><span>ENV</span> CLASSPATH .:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar</p></code><p><i></i>DOCKERFILE</p></pre></td></tr></tbody></table>

> ❗[](https://github.githubassets.com/images/icons/emoji/unicode/2757.png?v8) 备注:
> 
> -   JDK 的压缩包来自 Oracle Support 网站.
>     
> -   JAVA 环境变量直接在 `ENV` 里配置即可, 无需手动写入 /etc/profile 中
>     
> -   **如何把多行, 且含有多种特殊字符的字符串写入文件?** - 用大括号
>     

#### Tomcat 8[](https://ewhisper.cn/posts/37110/#Tomcat-8)

基于 Oracle JDK 7 的 Tomcat 8.0.X 的 Dockerfile 如下:

<table><tbody><tr><td><pre><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br><span>33</span><br><span>34</span><br><span>35</span><br><span>36</span><br><span>37</span><br><span>38</span><br><span>39</span><br><span>40</span><br><span>41</span><br><span>42</span><br><span>43</span><br><span>44</span><br><span>45</span><br><span>46</span><br><span>47</span><br><span>48</span><br><span>49</span><br><span>50</span><br><span>51</span><br><span>52</span><br><span>53</span><br><span>54</span><br><span>55</span><br><span>56</span><br><span>57</span><br><span>58</span><br><span>59</span><br><span>60</span><br><span>61</span><br><span>62</span><br><span>63</span><br><span>64</span><br><span>65</span><br><span>66</span><br><span>67</span><br><span>68</span><br><span>69</span><br><span>70</span><br><span>71</span><br><span>72</span><br><span>73</span><br><span>74</span><br><span>75</span><br><span>76</span><br><span>77</span><br><span>78</span><br><span>79</span><br><span>80</span><br><span>81</span><br><span>82</span><br><span>83</span><br><span>84</span><br><span>85</span><br><span>86</span><br><span>87</span><br><span>88</span><br><span>89</span><br><span>90</span><br><span>91</span><br><span>92</span><br><span>93</span><br><span>94</span><br><span>95</span><br><span>96</span><br><span>97</span><br><span>98</span><br><span>99</span><br><span>100</span><br><span>101</span><br><span>102</span><br><span>103</span><br><span>104</span><br><span>105</span><br><span>106</span><br><span>107</span><br><span>108</span><br><span>109</span><br><span>110</span><br><span>111</span><br><span>112</span><br><span>113</span><br><span>114</span><br><span>115</span><br><span>116</span><br><span>117</span><br><span>118</span><br><span>119</span><br><span>120</span><br><span>121</span><br><span>122</span><br><span>123</span><br><span>124</span><br><span>125</span><br><span>126</span><br><span>127</span><br><span>128</span><br><span>129</span><br><span>130</span><br><span>131</span><br><span>132</span><br><span>133</span><br><span>134</span><br><span>135</span><br><span>136</span><br><span>137</span><br><span>138</span><br><span>139</span><br><span>140</span><br><span>141</span><br><span>142</span><br><span>143</span><br></pre></td><td><pre><code><span>FROM</span> caseycui/jdk7:<span>7</span>u80<p> <span>LABEL</span><span> maintainer=<span>'CaseyCui cuikaidong@foxmail.com'</span></span></p><p> <span>ENV</span> CATALINA_HOME /tomcat<br><span>ENV</span> PATH $CATALINA_HOME/bin:$PATH</p><p><span>RUN</span><span> mkdir -p <span>"<span>$CATALINA_HOME</span>"</span></span></p><p><span>WORKDIR</span><span> <span>$CATALINA_HOME</span></span></p><p><span>## let "Tomcat Native" live somewhere isolated </span><br><span>ENV</span> TOMCAT_NATIVE_LIBDIR $CATALINA_HOME/native-jni-lib<br><span>ENV</span> LD_LIBRARY_PATH ${LD_LIBRARY_PATH:+$LD_LIBRARY_PATH:}$TOMCAT_NATIVE_LIBDIR</p><p><span>## runtime dependencies for Tomcat Native Libraries</span><br><span>## Tomcat Native 1.2+ requires a newer version of OpenSSL than debian:jessie has available</span><br><span>## &gt; checking OpenSSL library version &gt;= 1.0.2...</span><br><span>## &gt; configure: error: Your version of OpenSSL is not compatible with this version of tcnative</span><br><span>## see http://tomcat.10.x6.nabble.com/VOTE-Release-Apache-Tomcat-8-0-32-tp5046007p5046024.html (and following discussion)</span><br><span>## and https://github.com/docker-library/tomcat/pull/31</span></p><p><span>ENV</span> OPENSSL_VERSION <span>1.0</span>.<span>2</span>g-<span>1</span>ubuntu4.<span>8</span></p><p><span>## RUN set -ex; \</span><br><span>##         if ! grep -q stretch /etc/apt/sources.list; then \</span><br><span>## # only add stretch if we're not already building from within stretch</span><br><span>##                 { \</span><br><span>##                         echo 'deb http://deb.debian.org/debian stretch main'; \</span><br><span>##                 } &gt; /etc/apt/sources.list.d/stretch.list; \</span><br><span>##                 { \</span><br><span>## # add a negative "Pin-Priority" so that we never ever get packages from stretch unless we explicitly request them</span><br><span>##                         echo 'Package: *'; \</span><br><span>##                         echo 'Pin: release n=stretch'; \</span><br><span>##                         echo 'Pin-Priority: -10'; \</span><br><span>##                         echo; \</span><br><span>## # ... except OpenSSL, which is the reason we're here</span><br><span>##                         echo 'Package: openssl libssl*'; \</span><br><span>##                         echo "Pin: version $OPENSSL_VERSION"; \</span><br><span>##                         echo 'Pin-Priority: 990'; \</span><br><span>##                 } &gt; /etc/apt/preferences.d/stretch-openssl; \</span><br><span>##         fi</span></p><p><span>RUN</span><span> apt-get update &amp;&amp; apt-get install -y --no-install-recommends \</span><br><span>                libapr1 \</span><br><span>                openssl=<span>"<span>$OPENSSL_VERSION</span>"</span> \</span><br><span>        &amp;&amp; rm -rf /var/lib/apt/lists/*</span></p><p><span>## 安装跟 tomcat 用户认证相关的软件</span><br><span>RUN</span><span> apt-get update &amp;&amp; \</span><br><span>    DIBIAN_FRONTEND=noninteractive \</span><br><span>    apt-get install -yq --no-install-recommends \</span><br><span>        wget \</span><br><span>        pwgen \</span><br><span>        ca-certificates &amp;&amp; \</span><br><span>    apt-get clean &amp;&amp; \</span><br><span>    rm -rf /var/lib/apt/lists/*</span></p><p><span>## see https://www.apache.org/dist/tomcat/tomcat-$TOMCAT_MAJOR/KEYS</span><br><span>## see also "update.sh" (https://github.com/docker-library/tomcat/blob/master/update.sh)</span></p><p><span>ENV</span> GPG_KEYS <span>05</span>AB33110949707C93A279E3D3EFE6B686867BA6 <span>07</span>E48665A34DCAFAE522E5E6266191C37C037D42 <span>47309207</span>D818FFD8DCD3F83F1931D684307A10A5 <span>541</span>FBE7D8F78B25E055DDEE13C370389288584E7 <span>61</span>B832AC2F1C5A90F0F9B00A1C506407564C17A3 <span>713</span>DA88BE50911535FE716F5208B0AB1D63011C7 <span>79</span>F7026C690BAA50B92CD8B66A3AD3F4F22C4FED <span>9</span>BA44C2621385CB966EBA586F72C284D731FABEE A27677289986DB50844682F8ACB77FC2E86E29AC A9C5DF4D22E99998D9875A5110C01C5A2F6059E7 DCFD35E0BF8CA7344752DE8B6FB21E8933C60243 F3A04C595DB5B6A5F1ECA43E3B7BBB100D811BBE F7DA48BB64BCB84ECBA7EE6935CD23C10D498E23</p><p><span>RUN</span><span> <span>set</span> -ex; \</span><br><span>        <span>for</span> key <span>in</span> <span>$GPG_KEYS</span>; <span>do</span> \</span><br><span>                gpg --keyserver ha.pool.sks-keyservers.net --recv-keys <span>"<span>$key</span>"</span>; \</span><br><span>        <span>done</span></span></p><p><span>## 设置 tomcat 的环境变量</span></p><p> <span>ENV</span> TOMCAT_MAJOR <span>8</span><br><span>ENV</span> TOMCAT_VERSION <span>8.0</span>.<span>46</span><br><span>ENV</span> TOMCAT_TGZ_URL http://mirrors.tuna.tsinghua.edu.cn/apache/tomcat/tomcat-$TOMCAT_MAJOR/v$TOMCAT_VERSION/bin/apache-tomcat-$TOMCAT_VERSION.tar.gz<br><span>ENV</span> TOMCAT_ASC_URL https://www.apache.org/dist/tomcat/tomcat-$TOMCAT_MAJOR/v$TOMCAT_VERSION/bin/apache-tomcat-$TOMCAT_VERSION.tar.gz.asc</p><p><span>## 复制 tomcat 到镜像中</span></p><p><span>RUN</span><span> <span>set</span> -x \</span><br><span>        \</span><br><span>        &amp;&amp; wget -O tomcat.tar.gz <span>"<span>$TOMCAT_TGZ_URL</span>"</span> \</span><br><span>        &amp;&amp; wget -O tomcat.tar.gz.asc <span>"<span>$TOMCAT_ASC_URL</span>"</span> \</span><br><span>        &amp;&amp; gpg --batch --verify tomcat.tar.gz.asc tomcat.tar.gz \</span><br><span>        &amp;&amp; tar -xvf tomcat.tar.gz --strip-components=1  \</span><br><span>        &amp;&amp; rm bin/*.bat \</span><br><span>        &amp;&amp; rm tomcat.tar.gz* \</span><br><span>        \</span><br><span>        &amp;&amp; nativeBuildDir=<span>"<span>$(mktemp -d)</span>"</span> \</span><br><span>        &amp;&amp; tar -xvf bin/tomcat-native.tar.gz -C <span>"<span>$nativeBuildDir</span>"</span> --strip-components=1 \</span><br><span>        &amp;&amp; nativeBuildDeps=<span>" \</span></span><br><span><span>                dpkg-dev \</span></span><br><span><span>                gcc \</span></span><br><span><span>                libapr1-dev \</span></span><br><span><span>                libssl-dev \</span></span><br><span><span>                make \</span></span><br><span><span>        "</span> \</span><br><span>        &amp;&amp; apt-get update &amp;&amp; apt-get install -y --no-install-recommends <span>$nativeBuildDeps</span> &amp;&amp; rm -rf /var/lib/apt/lists/* \</span><br><span>        &amp;&amp; (\</span><br><span>                <span>export</span> CATALINA_HOME=<span>"<span>$PWD</span>"</span> \</span><br><span>                &amp;&amp; <span>cd</span> <span>"<span>$nativeBuildDir</span>/native"</span> \</span><br><span>                &amp;&amp; gnuArch=<span>"<span>$(dpkg-architecture --query DEB_BUILD_GNU_TYPE)</span>"</span> \</span><br><span>                &amp;&amp; ./configure \</span><br><span>                        --build=<span>"<span>$gnuArch</span>"</span> \</span><br><span>                        --libdir=<span>"<span>$TOMCAT_NATIVE_LIBDIR</span>"</span> \</span><br><span>                        --prefix=<span>"<span>$CATALINA_HOME</span>"</span> \</span><br><span>                        --with-apr=<span>"<span>$(which apr-1-config)</span>"</span> \ </span><br>                        --with-java-home=<span>"/java/jdk1.7.0_80"</span> \<br>                        --with-ssl=yes \<br>                &amp;&amp; make -j <span>"$(nproc)"</span> \<br>                &amp;&amp; make install \<br>        ) \<br>        &amp;&amp; apt-get purge -y --auto-remove $nativeBuildDeps \<br>        &amp;&amp; rm -rf <span>"$nativeBuildDir"</span> \<br>        &amp;&amp; rm bin/tomcat-native.tar.gz</p><p><span>## verify Tomcat Native is working properly</span><br><span>RUN</span><span> <span>set</span> -e \</span><br><span>        &amp;&amp; nativeLines=<span>"<span>$(catalina.sh configtest 2&gt;&amp;1)</span>"</span> \</span><br><span>        &amp;&amp; nativeLines=<span>"<span>$(echo <span>"<span>$nativeLines</span>"</span> | grep 'Apache Tomcat Native')</span>"</span> \</span><br><span>        &amp;&amp; nativeLines=<span>"<span>$(echo <span>"<span>$nativeLines</span>"</span> | sort -u)</span>"</span> \</span><br><span>        &amp;&amp; <span>if</span> ! <span>echo</span> <span>"<span>$nativeLines</span>"</span> | grep <span>'INFO: Loaded APR based Apache Tomcat Native library'</span> &gt;&amp;2; <span>then</span> \</span><br><span>                <span>echo</span> &gt;&amp;2 <span>"<span>$nativeLines</span>"</span>; \</span><br><span>                <span>exit</span> 1; \</span><br><span>        <span>fi</span></span></p><p><span>## 创建 tomcat 用户脚本</span><br><span>COPY</span><span> create_tomcat_admin_user.sh /create_tomcat_admin_user.sh</span></p><p> <span>## 创建 tomcat 运行脚本</span><br><span>COPY</span><span> run-tomcat.sh /run-tomcat.sh</span></p><p><span>RUN</span><span> chmod +x /*.sh &amp;&amp; \</span><br><span>    chmod +x /tomcat/bin/*.sh</span></p><p> <span>## 挂载点</span><br><span>## 日志文件</span><br><span>VOLUME</span><span> <span>$CATALINA_HOME</span>/logs</span></p><p><span>## 程序文件 </span><br><span>VOLUME</span><span> <span>$CATALINA_HOME</span>/webapps</span></p><p><span>EXPOSE</span> <span>8080</span></p><p><span>CMD</span><span> [<span>"/run-tomcat.sh"</span>]</span></p></code><p><i></i>DOCKERFILE</p></pre></td></tr></tbody></table>

创建 Tomcat 用户和密码脚本文件 `create_tomcat_admin_user.sh`, 内容如下:

<table><tbody><tr><td><pre><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br><span>33</span><br><span>34</span><br></pre></td><td><pre><code><span>##!/bin/bash</span><p> <span>if</span> [-f /.tomcat_admin_created]; <span>then</span><br>    <span>echo</span> <span>"Tomcat 'admin' user already created"</span><br>    <span>exit</span> 0 <br><span>fi</span></p><p><span>## generate password</span><br>PASS=<span>${TOMCAT_PASS:-$(pwgen -s 12 1)}</span><br>_word=$([ <span>${TOMCAT_PASS}</span> ] &amp;&amp; <span>echo</span> <span>"preset"</span> || <span>echo</span> <span>"random"</span>)<br><span>echo</span> <span>"=&gt; Creating and admin user with a <span>${_word}</span> password in Tomcat"</span></p><p><span>##sed -i -r 's/&lt;\/tomcat-user&gt;//' ${CATALINA_HOME}/conf/tomcat-users.xml</span><br><span>## 这句的主要用法就是原本的 `tomcat-users.xml` 里存在一个空的 `&lt;tomcat-users&gt;` 到 `&lt;/tomcat-users&gt;` 的字段，直接用 sed 删除最后一行，即 `&lt;/tomcat-users&gt;`</span><br><span>## 然后补上我们生成的密码的相关内容，最后再加上 `&lt;/tomcat-users&gt;`</span></p><p>  sed -i <span>'$d'</span> <span>${CATALINA_HOME}</span>/conf/tomcat-users.xml<br><span>echo</span> <span>'&lt;role rolename="manager-gui"/&gt;'</span> &gt;&gt; <span>${CATALINA_HOME}</span>/conf/tomcat-users.xml<br><span>echo</span> <span>'&lt;role rolename="manager-script"/&gt;'</span> &gt;&gt; <span>${CATALINA_HOME}</span>/conf/tomcat-users.xml<br><span>echo</span> <span>'&lt;role rolename="manager-jmx"/&gt;'</span> &gt;&gt; <span>${CATALINA_HOME}</span>/conf/tomcat-users.xml<br><span>echo</span> <span>'&lt;role rolename="admin-gui"/&gt;'</span> &gt;&gt; <span>${CATALINA_HOME}</span>/conf/tomcat-users.xml<br><span>echo</span> <span>'&lt;role rolename="admin-script"/&gt;'</span> &gt;&gt; <span>${CATALINA_HOME}</span>/conf/tomcat-users.xml<br><span>echo</span> <span>"&lt;user username=\"admin\" password=\"<span>${PASS}</span>\" roles=\"manager-gui, manager-script, manager-jmx, admin-gui, admin-script\"/&gt;"</span> &gt;&gt; <span>${CATALINA_HOME}</span>/conf/tomcat-users.xml<br><span>echo</span> <span>'&lt;/tomcat-users&gt;'</span> &gt;&gt; <span>${CATALINA_HOME}</span>/conf/tomcat-users.xml<br><span>echo</span> <span>"=&gt; Done!"</span><br>touch /.tomcat_admin_created<br><span>echo</span> <span>"======================================================"</span><br><span>echo</span> <span>"You can now configure to this Tomcat server using:"</span><br><span>echo</span> <span>""</span><br><span>echo</span> <span>"      admin:<span>${PASS}</span>"</span><br><span>echo</span> <span>""</span><br><span>echo</span> <span>"======================================================"</span></p></code><p><i></i>SH</p></pre></td></tr></tbody></table>

Tomcat 启动脚本 `run-tomcat.sh`:

<table><tbody><tr><td><pre><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br></pre></td><td><pre><code><span>##!/bin/bash</span><p> <span>if</span> [! -f /.tomcat_admin_created]; <span>then</span><br>    /create_tomcat_admin_user.sh<br><span>fi</span></p><p><span>exec</span> <span>${CATALINA_HOME}</span>/bin/catalina.sh run </p></code><p><i></i>BASH</p></pre></td></tr></tbody></table>

tomcat 密码脚本最后生成的 `tomcat-users.xml` 文件:

<table><tbody><tr><td><pre><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br><span>33</span><br><span>34</span><br><span>35</span><br><span>36</span><br><span>37</span><br><span>38</span><br><span>39</span><br><span>40</span><br><span>41</span><br><span>42</span><br><span>43</span><br><span>44</span><br><span>45</span><br><span>46</span><br><span>47</span><br><span>48</span><br><span>49</span><br><span>50</span><br><span>51</span><br><span>52</span><br><span>53</span><br></pre></td><td><pre><code><span>&lt;?xml version='1.0' encoding='utf-8'?&gt;</span><br><span>&lt;!--</span><br><span>  Licensed to the Apache Software Foundation (ASF) under one or more</span><br><span>  contributor license agreements.  See the NOTICE file distributed with</span><br><span>  this work for additional information regarding copyright ownership.</span><br><span>  The ASF licenses this file to You under the Apache License, Version 2.0</span><br><span>  (the "License"); you may not use this file except in compliance with</span><br><span>  the License.  You may obtain a copy of the License at</span><br><span>      http://www.apache.org/licenses/LICENSE-2.0</span><br><span>  Unless required by applicable law or agreed to in writing, software</span><br><span>  distributed under the License is distributed on an "AS IS" BASIS,</span><br><span>  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span><br><span>  See the License for the specific language governing permissions and</span><br><span>  limitations under the License.</span><br><span>--&gt;</span><p><span>&lt;<span>tomcat-users</span> <span>xmlns</span>=<span>"http://tomcat.apache.org/xml"</span></span><br><span>              <span>xmlns:xsi</span>=<span>"http://www.w3.org/2001/XMLSchema-instance"</span></span><br><span>              <span>xsi:schemaLocation</span>=<span>"http://tomcat.apache.org/xml tomcat-users.xsd"</span></span><br><span>              <span>version</span>=<span>"1.0"</span>&gt;</span></p><p><span>&lt;!--</span><br><span>  <span>NOTE:</span>  By default, no user is included in the "manager-gui" role required</span><br><span>  to operate the "/manager/html" web application.  If you wish to use this app,</span><br><span>  you must define such a user - the username and password are arbitrary. It is</span><br><span>  strongly recommended that you do NOT use one of the users in the commented out</span><br><span>  section below since they are intended for use with the examples web</span><br><span>  application.</span><br><span>--&gt;</span></p><p><span>&lt;!--</span><br><span>  <span>NOTE:</span>  The sample user and role entries below are intended for use with the</span><br><span>  examples web application. They are wrapped in a comment and thus are ignored</span><br><span>  when reading this file. If you wish to configure these users for use with the</span><br><span>  examples web application, do not forget to remove the &lt;!.. ..&gt; that surrounds</span><br><span>  them. You will also need to set the passwords to something appropriate.</span><br><span>--&gt;</span></p><p><span>&lt;!--</span><br><span>  &lt;role rolename="tomcat"/&gt;</span><br><span>  &lt;role rolename="role1"/&gt;</span><br><span>  &lt;user username="tomcat" password="&lt;must-be-changed&gt;" roles="tomcat"/&gt;</span><br><span>  &lt;user username="both" password="&lt;must-be-changed&gt;" roles="tomcat,role1"/&gt;</span><br><span>  &lt;user username="role1" password="&lt;must-be-changed&gt;" roles="role1"/&gt;</span><br><span>--&gt;</span></p><p><span>&lt;<span>role</span> <span>rolename</span>=<span>"manager-gui"</span>/&gt;</span><br><span>&lt;<span>role</span> <span>rolename</span>=<span>"manager-script"</span>/&gt;</span><br><span>&lt;<span>role</span> <span>rolename</span>=<span>"manager-jmx"</span>/&gt;</span><br><span>&lt;<span>role</span> <span>rolename</span>=<span>"admin-gui"</span>/&gt;</span><br><span>&lt;<span>role</span> <span>rolename</span>=<span>"admin-script"</span>/&gt;</span><br><span>&lt;<span>user</span> <span>username</span>=<span>"admin"</span> <span>password</span>=<span>"vNc8guWjdrBP"</span> <span>roles</span>=<span>"manager-gui, manager-script, manager-jmx, admin-gui, admin-script"</span>/&gt;</span><br><span>&lt;/<span>tomcat-users</span>&gt;</span></p></code><p><i></i>XML</p></pre></td></tr></tbody></table>

### 本章小结[](https://ewhisper.cn/posts/37110/#%E6%9C%AC%E7%AB%A0%E5%B0%8F%E7%BB%93)

**中间件服务器** 是 Docker 容器应用的最佳实践, 理由如下:

-   中间件服务器是除数据库服务器外的主要计算节点, 很容易成为性能瓶颈, 所以通常需要大批量部署, 而 Docker 对于批量部署有着许多的先天优势
-   中间件服务器结构清晰, 在剥离了 **配置文件** **日志** **代码目录** 之后, 容器几乎可以处于零增长状态, 这使得容器的迁移和批量部署更加方便.
-   中间件服务器很容易实现集群, 在使用硬件的 F5, 软件的 Nginx 等负载均衡后, 中间件服务器集群变得非常容易

在使用中间件容器的时候, **需要事先规划好容器的用途和可能开放的网络端口等资源**.

❗[](https://github.githubassets.com/images/icons/emoji/unicode/2757.png?v8) 对于 **程序代码** **程序的资源目录** **日志** **数据库文件** 等需要实时更新的数据一定要通过 `-v` 参数映射到宿主主机的目录中来, 使用 Docker 的 AUFS 文件格式, 会产生较大的性能问题.

> [IBM 研究院关于 Docker 各项性能的测试报告](http://domino.research.ibm.com/library/cyberdig.nsf/papers/0929052195DD819C85257D2300681E7B/$File/rc25482.pdf)