   

[![](https://p26-passport.byteacctimg.com/img/user-avatar/4aa21e6a60bff0744a9092ece15b9376~300x300.image)](https://juejin.cn/user/3312183941279335)

2022å¹´08æœˆ25æ—¥ 18:20 Â·Â Â é˜…è¯» 2506

![åŠ 3è¡Œä»£ç å‡å°‘80%æ„å»ºæ—¶é—´](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/80af61d450cd415ca2b24bf4fab84b2c~tplv-k3u1fbpfcp-zoom-crop-mark:3024:3024:3024:1702.awebp?)  

## èƒŒæ™¯

æœ€è¿‘æ¥æ‰‹çš„`BI`é¡¹ç›®åœ¨`Jenkins`çš„æ„å»ºæœºä¸Šæ„å»ºè€—æ—¶æ¯”è¾ƒä¹…ï¼Œæ—¥å¸¸æ„å»ºè€—æ—¶éƒ½åœ¨ 20min ä»¥ä¸Šï¼Œå³ä½¿æ”¹åŠ¨ä¸€è¡Œä»£ç ä¹Ÿè¦æ„å»ºè¿™ä¹ˆä¹…ã€‚æ„å»ºè€—æ—¶æˆªå›¾å¦‚ä¸‹ï¼š

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/204e2de4bea9452fbaccd2840576791c~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp)

æ„å»ºè€—æ—¶è¾ƒé•¿å¯¼è‡´æ—¥å¸¸æµ‹è¯•å’Œæ­£å¼å‘ç‰ˆéƒ½ä¼šæµªè´¹å¾ˆå¤šæ—¶é—´ç­‰å¾…ï¼Œå¯¹ç ”å‘æµç¨‹å½±å“è¾ƒå¤§ï¼ˆä¸»è¦æ˜¯æˆ‘å¿ä¸äº†ï¼‰ã€‚å› æ­¤éœ€è¦å¯¹æ„å»ºé€Ÿåº¦è¿›è¡Œä¼˜åŒ–ã€‚

## ä¼˜åŒ–æ€è·¯åˆ†æ

è¦ä¼˜åŒ–é¡¹ç›®çš„æ„å»ºé€Ÿåº¦ï¼Œå¾—å…ˆäº†è§£æ„å»ºæµç¨‹ï¼š

-   å¼€å‘äººå‘˜æ¨é€ä»£ç åˆ° `Gitlab`ï¼Œè§¦å‘ `Gitlab` æœåŠ¡å™¨çš„ `Push Events`
-   `Push Events`è¢«è§¦å‘åï¼Œä¼šè°ƒç”¨æå‰é…ç½®å¥½çš„ `Jenkins webhooks`
-   `Jenkins webhooks`è¢«è°ƒç”¨åï¼Œä¼šæ‰§è¡Œå¯¹åº”é¡¹ç›®çš„æ„å»ºä»»åŠ¡
-   æ„å»ºä»»åŠ¡å¼€å§‹åå…ˆæ‹‰å–é¡¹ç›®æºç åˆ°æ„å»ºæœºï¼Œå†ä½¿ç”¨`docker build`æ„å»ºé•œåƒ
-   `docker` æ„å»ºé•œåƒåˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼Œå…ˆä½¿ç”¨`npm scripts`æ„å»ºå‰ç«¯é¡¹ç›®ï¼Œç„¶åæŠŠæ„å»ºäº§ç‰©æ‹·è´åˆ°`nginx`åŸºç¡€é•œåƒ

åœ¨è¿™ä¸ªæµç¨‹ä¸­ï¼Œå¯ä»¥ä¼˜åŒ–çš„ç¯èŠ‚åªæœ‰æ„å»º`docker`é•œåƒè¿™ä¸€æ­¥ï¼Œå…¶ä»–ç¯èŠ‚çš„è€—æ—¶åŸºæœ¬å¯ä»¥å¿½ç•¥ä¸è®¡ã€‚è€Œåœ¨ä¸å¤§æ”¹é¡¹ç›®çš„æƒ…å†µä¸‹èƒ½èµ·åˆ°æ˜æ˜¾æé€Ÿæ•ˆæœçš„æ–¹æ¡ˆæ˜¯ï¼šç¼“å­˜ç­–ç•¥ã€‚æ„å»º`docker`é•œåƒæ—¶å¯ä»¥ç”¨åˆ°çš„ç¼“å­˜åŒ…æ‹¬ä¸¤ç±»ï¼š`dockerå±‚ç¼“å­˜`å’Œ`åº”ç”¨å±‚ç¼“å­˜`ã€‚

`dockerå±‚ç¼“å­˜`æ˜¯æŒ‡`docker build`æ‰€äº§ç”Ÿçš„å¯é‡ç”¨é•œåƒå±‚ï¼Œåªè¦`Dockerfile`ä¸­çš„å‘½ä»¤åŠç›¸å…³çš„æºæ–‡ä»¶æœªæ”¹å˜ï¼Œå°±èƒ½ç›´æ¥ä½¿ç”¨è¿™äº›é•œåƒç¼“å­˜ã€‚è¿™ç§ç¼“å­˜ç­–ç•¥åœ¨ä»£ç ä¸æ”¹å˜çš„æƒ…å†µä¸‹æ•ˆæœå¾ˆå¥½ï¼Œæ„å»ºè€—æ—¶ç”šè‡³å¯ä»¥æ§åˆ¶åœ¨ 10 ç§’å†…ã€‚è€Œå¯¹äºæ—¥å¸¸å¼€å‘æƒ…å†µä¸‹ï¼Œä»£ç é¢‘ç¹å˜åŒ–ï¼Œå¦‚æœåº”ç”¨æœ¬èº«æ„å»ºæ—¶é—´åˆå¾ˆé•¿ï¼Œåˆ™éœ€è¦ä½¿ç”¨`åº”ç”¨å±‚ç¼“å­˜`ã€‚ï¼ˆä¸Šä¸€ç¯‡æ–‡ç« ã€Šdocker build ç¼“å­˜å¤±æ•ˆåˆ†æã€‹ä¸­æœ‰ docker å±‚ç¼“å­˜ç›¸å…³ä»‹ç»ï¼Œä¹Ÿå¯ä»¥çœ‹çœ‹[å®˜æ–¹æ–‡æ¡£](https://link.juejin.cn/?target=https%3A%2F%2Fdocs.docker.com%2Fdevelop%2Fdevelop-images%2Fdockerfile_best-practices%2F%23leverage-build-cache "https://docs.docker.com/develop/develop-images/dockerfile_best-practices/#leverage-build-cache")ã€[ä¸­æ–‡æ–‡æ¡£](https://link.juejin.cn/?target=https%3A%2F%2Fvuepress.mirror.docker-practice.com%2Fappendix%2Fbest_practices%2F%23%25E6%259E%2584%25E5%25BB%25BA%25E7%25BC%2593%25E5%25AD%2598 "https://vuepress.mirror.docker-practice.com/appendix/best_practices/#%E6%9E%84%E5%BB%BA%E7%BC%93%E5%AD%98")ï¼Œæœ¬æ–‡ä¸å†èµ˜è¿°ï¼‰

`åº”ç”¨å±‚ç¼“å­˜`æ˜¯æŒ‡åº”ç”¨æ„å»ºæ‰€äº§ç”Ÿçš„ä¸­é—´äº§ç‰©ï¼Œè¿™äº›ä¸­é—´äº§ç‰©ä¸»è¦æ˜¯`node_modules`ç›®å½•ä¸­çš„ç‰©ç†æ–‡ä»¶ï¼Œå…¶ä¸­åŒ…æ‹¬`npm install`ä¸‹è½½çš„ä¾èµ–åŒ…å’Œ`npm run build`äº§ç”Ÿçš„`.cache`ç›®å½•æ–‡ä»¶ã€‚è€Œ`docker build`æ¯æ¬¡éƒ½ä¼šåˆå§‹åŒ–å…¨æ–°çš„ç¯å¢ƒç”¨äºæ„å»ºï¼Œæ–°ç¯å¢ƒä¸­ä¸å­˜åœ¨`node_modules`ç›®å½•ï¼Œå› æ­¤æ¯æ¬¡éƒ½æ˜¯é‡æ–°å†™å…¥è€Œæ— æ³•å¤ç”¨ï¼Œå¾—æƒ³åŠæ³•å¤ç”¨è¯¥ç›®å½•ä¸‹çš„æ–‡ä»¶ï¼›å¦å¤–`npm run build`éœ€è¦å¼€å¯ç¼“å­˜åŠŸèƒ½ï¼Œæ‰ä¼šè¾“å‡ºç¼“å­˜æ–‡ä»¶åˆ°`node_modules/.cache`ç›®å½•ã€‚

ç»¼ä¸Šï¼Œä¼˜åŒ–æ€è·¯ä¸»è¦æ˜¯ä¸¤ç‚¹ï¼š1ã€å¼€å¯åº”ç”¨å±‚æ„å»ºç¼“å­˜ï¼ˆå¦‚`webpack cache`ï¼‰ï¼›2ã€æŒä¹…åŒ–`node_modules`ç›®å½•ï¼Œç¡®ä¿æ¯æ¬¡`npm install`å’Œ`npm run build`éƒ½èƒ½å¤ç”¨è¯¥ç›®å½•ä¸‹çš„æ–‡ä»¶ã€‚

## å¼€å¯åº”ç”¨å±‚æ„å»ºç¼“å­˜

é¡¹ç›®ä½¿ç”¨çš„æŠ€æœ¯æ˜¯`React`ï¼Œæ„å»ºä¸»è¦ä¾é `react-scripts@4.0.3`ï¼Œåº•å±‚å®é™…è°ƒç”¨çš„æ˜¯`webpack@4.44.2`ï¼Œåº”ç”¨æ„å»ºç¼“å­˜ä¸»è¦æ¥è‡ª`webpack`ã€‚`webpack`éœ€è¦æ‰‹å·¥å¼€å¯ç¼“å­˜åŠŸèƒ½ï¼ˆå®˜æ–¹æ–‡æ¡£[ä¼ é€é—¨](https://link.juejin.cn/?target=https%3A%2F%2Fv4.webpack.js.org%2Fconfiguration%2Fother-options%2F%23cache "https://v4.webpack.js.org/configuration/other-options/#cache")ï¼‰ï¼Œé…ç½®`cache`å±æ€§ä¸º`true`å³å¯ã€‚

**å®é™…æ“ä½œåªæœ‰ 1 æ­¥ï¼Œ** æ‰¾åˆ°`webpack.config.js`è®¾ç½®`cache:true`ï¼Œä»£ç å¦‚ä¸‹ï¼š

```
module.exports = {
  //...
  cache: true
};
å¤åˆ¶ä»£ç 
```

**æœ¬åœ°é¦–æ¬¡`npm run build`æ„å»ºï¼Œæ— ç¼“å­˜çš„æƒ…å†µä¸‹ï¼Œè€—æ—¶ 13min å·¦å³ã€‚**  
![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b66ea98b9dbf48a8809edfe0be17d058~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp)

**å¯ç”¨ç¼“å­˜ååœ¨æœ¬åœ°è¿›è¡ŒäºŒæ¬¡æ„å»ºï¼Œæœ‰ç¼“å­˜çš„æƒ…å†µä¸‹ï¼Œæ— è®ºæ˜¯å¦ä¿®æ”¹æºç æ„å»ºè€—æ—¶å‡ä¸º 4min å·¦å³ï¼Œæ¯”ä¼˜åŒ–å‰çš„ 13min æœ‰æ˜æ˜¾æå‡ã€‚** æ„å»ºè€—æ—¶æˆªå›¾å¦‚ä¸‹ï¼š  
![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ebf961d0fafb4b0b89bd848bbf718d1d~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp)

**å®é™…ä¸Šï¼Œ`webpack@4`çš„ç¼“å­˜åªåœ¨`watch`å’Œ`development`æ¨¡å¼ä¸‹ç”Ÿæ•ˆï¼Œåœ¨ä¸Šè¿°æ„å»ºæµ‹è¯•ä¸­å…¶å®ä¸èµ·ä½œç”¨ã€‚** å®æµ‹åˆ é™¤`wepack`ä¸­çš„`cache:true`é…ç½®ï¼Œæˆ–è€…é…ç½®ä¸º`cache:false`ï¼ŒäºŒæ¬¡æ„å»ºæ—¶é—´ä¹Ÿæ˜¯ 4min å·¦å³ã€‚

ä¹‹æ‰€ä»¥æ„å»ºé€Ÿåº¦æå‡äº†é‚£ä¹ˆå¤šï¼Œæ˜¯å› ä¸º`react-scripts`çš„`webpack`[é…ç½®](https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Ffacebook%2Fcreate-react-app%2Fblob%2Fv4.0.3%2Fpackages%2Freact-scripts%2Fconfig%2Fwebpack.config.js%23L459 "https://github.com/facebook/create-react-app/blob/v4.0.3/packages/react-scripts/config/webpack.config.js#L459")ä¸­å¼€å¯äº†`babel-loader`å’Œ`eslint-webpack-plugin`çš„ç¼“å­˜åŠŸèƒ½ï¼Œå¦å¤–`terser-webpack-plugin`[é…ç½®](https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fwebpack-contrib%2Fterser-webpack-plugin%2Ftree%2Fv4.2.3%23cache "https://github.com/webpack-contrib/terser-webpack-plugin/tree/v4.2.3#cache")ä¹Ÿé»˜è®¤å¼€å¯äº†ç¼“å­˜åŠŸèƒ½ã€‚ä»ç¼“å­˜ç›®å½•`node_modules/.cache`ä¸­ä¹Ÿèƒ½çœ‹åˆ°å®ƒä»¬çš„ç¼“å­˜æ–‡ä»¶ã€‚  
![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2075a1572a9b4c9d85a63be9e38ca275~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp)

**æ‰€ä»¥ï¼Œè¿™ä¸€æ­¥å…¶å®å•¥ä¹Ÿä¸ç”¨åšï¼Œå¦‚æœæƒ³è¿›ä¸€æ­¥æé€Ÿå¯ä»¥å‡çº§åˆ°`webpack@5`ã€‚**

## æŒä¹…åŒ–`node_modules`ç›®å½•

æƒ³åœ¨`docker build`ç¯å¢ƒä¸­æŒä¹…åŒ–`node_modules`éœ€è¦ä½¿ç”¨åˆ°`BuildKit`çš„`mount`åŠŸèƒ½ï¼Œè¯¥åŠŸèƒ½æœ‰å‡ ä¸ªå‰ç½®æ¡ä»¶ï¼š

-   `docker` ç‰ˆæœ¬å¿…é¡»é«˜äº 18.09
-   `BuildKit`éœ€è¦[æ‰‹å·¥å¯ç”¨](https://link.juejin.cn/?target=https%3A%2F%2Fdocs.docker.com%2Fdevelop%2Fdevelop-images%2Fbuild_enhancements%2F%23to-enable-buildkit-builds "https://docs.docker.com/develop/develop-images/build_enhancements/#to-enable-buildkit-builds")ï¼Œå¯åœ¨`docker build`å‘½ä»¤å‰æ·»åŠ ç¯å¢ƒå˜é‡`DOCKER_BUILDKIT=1`å¯ç”¨
-   å¦‚æœå‰ä¸¤ä¸ªæ¡ä»¶ä¸æ»¡è¶³ï¼Œåˆ™éœ€è¦å…·å¤‡`Jenkins`å’Œæ„å»ºæœºçš„è¯»å†™æƒé™ï¼Œä»¥è°ƒæ•´æ„å»ºç¯å¢ƒå‚æ•°
-   ä¿®æ”¹`Dockerfile`ï¼Œä½¿ç”¨`RUN --mount=type=cache`è¿è¡Œ`npm install`å’Œ`npm run build`æŒ‡ä»¤ï¼ˆ`--mount=type=cache`è¯´æ˜æ–‡æ¡£[ä¼ é€é—¨](https://link.juejin.cn/?target=https%3A%2F%2Fvuepress.mirror.docker-practice.com%2Fbuildx%2Fbuildkit%2F%23run-mount-type-cache "https://vuepress.mirror.docker-practice.com/buildx/buildkit/#run-mount-type-cache")ï¼‰

> å¼€å¯`BuildKit`è¿˜æœ‰[å…¶ä»–ç‰¹æ€§](https://link.juejin.cn/?target=https%3A%2F%2Fdocs.docker.com%2Fdevelop%2Fdevelop-images%2Fbuild_enhancements%2F%23new-docker-build-command-line-build-output "https://docs.docker.com/develop/develop-images/build_enhancements/#new-docker-build-command-line-build-output")ï¼Œæ¯”å¦‚è¾“å‡ºæ—¥å¿—æ›´å‹å¥½ï¼ŒåŸºæœ¬æ¯ä¸€æ­¥éƒ½ä¼šè¾“å‡ºè€—æ—¶ï¼Œå°±è¿™ä¸€æ¡ï¼Œå€¼äº†ï¼

**å®é™…æ“ä½œåˆ†ä¸º 2 æ­¥ï¼š**  
1ã€ä¿®æ”¹`Jenkins`é…ç½®ï¼Œåœ¨`docker build`å‘½ä»¤å‰åŠ ä¸Šç¯å¢ƒå˜é‡ã€‚ä¿®æ”¹åé•œåƒæ„å»ºå‘½ä»¤é•¿è¿™æ ·ï¼š

```
 DOCKER_BUILDKIT=1 docker build .
å¤åˆ¶ä»£ç 
```

2ã€ä¿®æ”¹`Dockerfile`ï¼Œå°†`RUN npm install`å’Œ`RUN npm run build`æŒ‡ä»¤æ”¹ä¸º`RUN --mount=type=cache npm xxx`ã€‚ä¿®æ”¹å`Dockerfile`é•¿è¿™æ ·ï¼š

```
FROM node:alpine as builder

WORKDIR /app

COPY package.json /app/

RUN --mount=type=cache,target=/app/node_modules,id=my_app_npm_module,sharing=locked \
    --mount=type=cache,target=/root/.npm,id=npm_cache \
    npm i --registry=https://registry.npm.taobao.org

COPY src /app/src

RUN --mount=type=cache,target=/app/node_modules,id=my_app_npm_module,sharing=locked \
    npm run build
å¤åˆ¶ä»£ç 
```

> æ–‡æ¡£è¯´ç”±äº `BuildKit` ä¸ºå®éªŒç‰¹æ€§ï¼Œéœ€è¦åœ¨ `Dockerfile` æ–‡ä»¶å¼€å¤´åŠ ä¸Šå¦‚ä¸‹ä»£ç ï¼š`# syntax = docker/dockerfile:experimental`ã€‚ åœ¨`Docker 20.10`ç¯å¢ƒä¸‹ï¼ŒåŠ äº†ä¸Šè¿°ä»£ç åè€Œæ„å»ºæŠ¥é”™ï¼ŒåŸå› æ˜¯åŠ è½½å¤–ç½‘èµ„æºå¤±è´¥ï¼Œåˆ é™¤åæ„å»ºæˆåŠŸã€‚è¿™ä¸å°±æ˜¯ç„å­¦å—ï¼ŸğŸ¤¡

## ä¼˜åŒ–ç»“æœ

åœ¨é…ç½®å¥½ç¼“å­˜ç­–ç•¥åï¼Œæ¨¡æ‹Ÿæ—¥å¸¸å¼€å‘ä¿®æ”¹é¡¹ç›®ä»£ç è§¦å‘è‡ªåŠ¨æ„å»ºæµç¨‹ï¼Œæ„å»ºè€—æ—¶ä» 20min+ä¸‹é™åˆ° 4min+ï¼Œæ€»ä½“è€—æ—¶å‡å°‘ 80%ã€‚æ•´ä¸ªä¼˜åŒ–è¿‡ç¨‹ä¿®æ”¹äº†`Jenkins`çš„ä¸€è¡Œé…ç½®ï¼Œå¦å¤–åœ¨`Dockerfile`ä¸­æ·»åŠ äº†3è¡Œä»£ç ï¼Œæ”¹åŠ¨å¾ˆå°‘ä½†æ•ˆæœå¾ˆä¸é”™ã€‚

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3646773723e94dca8025e0c8134b6bfd~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp)

![](https://lf3-cdn-tos.bytescm.com/obj/static/xitu_juejin_web/00ba359ecd0075e59ffbc3d810af551d.svg) 25

![](https://lf3-cdn-tos.bytescm.com/obj/static/xitu_juejin_web/3d482c7a948bac826e155953b2a28a9e.svg) æ”¶è—