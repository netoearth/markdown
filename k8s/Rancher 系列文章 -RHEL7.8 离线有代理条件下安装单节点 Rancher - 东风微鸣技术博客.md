ℹ️ **信息：**

Docker 版本为：1.13，安装后带了 3 个和 docker 有关的 service：

<table><tbody><tr><td><pre><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br></pre></td><td><pre><code><span># systemctl list-unit-files|grep docker</span><br>docker-cleanup.service                        disabled<br>docker-storage-setup.service                  disabled<br>docker.service                                disabled<br>docker-cleanup.timer                          disabled<br></code><p><i></i>BASH</p></pre></td></tr></tbody></table>

`docker.service` 目录是：`/usr/lib/systemd/system/docker.service`

docker-compose version 1.18.0, build 8dd22a9

<table><tbody><tr><td><pre><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br><span>33</span><br><span>34</span><br><span>35</span><br><span>36</span><br><span>37</span><br><span>38</span><br><span>39</span><br><span>40</span><br><span>41</span><br><span>42</span><br><span>43</span><br><span>44</span><br><span>45</span><br><span>46</span><br><span>47</span><br><span>48</span><br><span>49</span><br><span>50</span><br><span>51</span><br><span>52</span><br><span>53</span><br><span>54</span><br><span>55</span><br><span>56</span><br><span>57</span><br><span>58</span><br><span>59</span><br><span>60</span><br><span>61</span><br><span>62</span><br><span>63</span><br><span>64</span><br><span>65</span><br><span>66</span><br><span>67</span><br><span>68</span><br><span>69</span><br><span>70</span><br><span>71</span><br><span>72</span><br><span>73</span><br><span>74</span><br><span>75</span><br><span>76</span><br><span>77</span><br><span>78</span><br><span>79</span><br><span>80</span><br><span>81</span><br><span>82</span><br><span>83</span><br><span>84</span><br><span>85</span><br><span>86</span><br><span>87</span><br><span>88</span><br><span>89</span><br><span>90</span><br><span>91</span><br><span>92</span><br><span>93</span><br><span>94</span><br><span>95</span><br><span>96</span><br><span>97</span><br><span>98</span><br><span>99</span><br><span>100</span><br><span>101</span><br><span>102</span><br><span>103</span><br><span>104</span><br><span>105</span><br><span>106</span><br><span>107</span><br><span>108</span><br><span>109</span><br><span>110</span><br><span>111</span><br><span>112</span><br><span>113</span><br><span>114</span><br><span>115</span><br><span>116</span><br><span>117</span><br><span>118</span><br><span>119</span><br><span>120</span><br><span>121</span><br><span>122</span><br><span>123</span><br><span>124</span><br><span>125</span><br><span>126</span><br><span>127</span><br><span>128</span><br><span>129</span><br><span>130</span><br><span>131</span><br><span>132</span><br><span>133</span><br><span>134</span><br><span>135</span><br><span>136</span><br><span>137</span><br><span>138</span><br><span>139</span><br><span>140</span><br><span>141</span><br><span>142</span><br><span>143</span><br><span>144</span><br><span>145</span><br><span>146</span><br><span>147</span><br><span>148</span><br><span>149</span><br><span>150</span><br><span>151</span><br><span>152</span><br><span>153</span><br><span>154</span><br><span>155</span><br><span>156</span><br><span>157</span><br></pre></td><td><pre><code><span>#!/bin/bash -e</span><p><span><span>help</span></span> ()<br>{<br>    <span>echo</span>  <span>' ================================================================ '</span><br>    <span>echo</span>  <span>' --ssl-domain: 生成 ssl 证书需要的主域名，如不指定则默认为 www.rancher.local，如果是 ip 访问服务，则可忽略；'</span><br>    <span>echo</span>  <span>' --ssl-trusted-ip: 一般 ssl 证书只信任域名的访问请求，有时候需要使用 ip 去访问 server，那么需要给 ssl 证书添加扩展 IP，多个 IP 用逗号隔开；'</span><br>    <span>echo</span>  <span>' --ssl-trusted-domain: 如果想多个域名访问，则添加扩展域名（SSL_TRUSTED_DOMAIN）, 多个扩展域名用逗号隔开；'</span><br>    <span>echo</span>  <span>' --ssl-size: ssl 加密位数，默认 2048；'</span><br>    <span>echo</span>  <span>' --ssl-cn: 国家代码 (2 个字母的代号）, 默认 CN;'</span><br>    <span>echo</span>  <span>' 使用示例：'</span><br>    <span>echo</span>  <span>' ./create_self-signed-cert.sh --ssl-domain=www.test.com --ssl-trusted-domain=www.test2.com \ '</span><br>    <span>echo</span>  <span>' --ssl-trusted-ip=1.1.1.1,2.2.2.2,3.3.3.3 --ssl-size=2048 --ssl-date=3650'</span><br>    <span>echo</span>  <span>' ================================================================'</span><br>}</p><p><span>case</span> <span>"<span>$1</span>"</span> <span>in</span><br>    -h|--<span>help</span>) <span>help</span>; <span>exit</span>;;<br><span>esac</span></p><p><span>if</span> [[<span>$1</span> == <span>''</span> ]];<span>then</span><br>    <span>help</span>;<br>    <span>exit</span>;<br><span>fi</span></p><p>CMDOPTS=<span>"$*"</span><br><span>for</span> OPTS <span>in</span> <span>$CMDOPTS</span>;<br><span>do</span><br>    key=$(<span>echo</span> <span>${OPTS}</span> | awk -F<span>"="</span> <span>'{print $1}'</span> )<br>    value=$(<span>echo</span> <span>${OPTS}</span> | awk -F<span>"="</span> <span>'{print $2}'</span> )<br>    <span>case</span> <span>"<span>$key</span>"</span> <span>in</span><br>        --ssl-domain) SSL_DOMAIN=<span>$value</span> ;;<br>        --ssl-trusted-ip) SSL_TRUSTED_IP=<span>$value</span> ;;<br>        --ssl-trusted-domain) SSL_TRUSTED_DOMAIN=<span>$value</span> ;;<br>        --ssl-size) SSL_SIZE=<span>$value</span> ;;<br>        --ssl-date) SSL_DATE=<span>$value</span> ;;<br>        --ca-date) CA_DATE=<span>$value</span> ;;<br>        --ssl-cn) CN=<span>$value</span> ;;<br>    <span>esac</span><br><span>done</span></p><p><span># CA 相关配置</span><br>CA_DATE=<span>${CA_DATE:-3650}</span><br>CA_KEY=<span>${CA_KEY:-cakey.pem}</span><br>CA_CERT=<span>${CA_CERT:-cacerts.pem}</span><br>CA_DOMAIN=cattle-ca</p><p><span># ssl 相关配置</span><br>SSL_CONFIG=<span>${SSL_CONFIG:-<span>$PWD</span>/openssl.cnf}</span><br>SSL_DOMAIN=<span>${SSL_DOMAIN:-'www.rancher.local'}</span><br>SSL_DATE=<span>${SSL_DATE:-3650}</span><br>SSL_SIZE=<span>${SSL_SIZE:-2048}</span></p><p><span>## 国家代码 (2 个字母的代号）, 默认 CN;</span><br>CN=<span>${CN:-CN}</span></p><p>SSL_KEY=<span>$SSL_DOMAIN</span>.key<br>SSL_CSR=<span>$SSL_DOMAIN</span>.csr<br>SSL_CERT=<span>$SSL_DOMAIN</span>.crt</p><p><span>echo</span> -e <span>"\033[32m ---------------------------- \033[0m"</span><br><span>echo</span> -e <span>"\033[32m       | 生成 SSL Cert |       \033[0m"</span><br><span>echo</span> -e <span>"\033[32m ---------------------------- \033[0m"</span></p><p><span>if</span> [[-e ./<span>${CA_KEY}</span> ]]; <span>then</span><br>    <span>echo</span> -e <span>"\033[32m ====&gt; 1. 发现已存在 CA 私钥，备份 "</span><span>${CA_KEY}</span><span>" 为 "</span><span>${CA_KEY}</span><span>"-bak，然后重新创建 \033[0m"</span><br>    mv <span>${CA_KEY}</span> <span>"<span>${CA_KEY}</span>"</span>-bak<br>    openssl genrsa -out <span>${CA_KEY}</span> <span>${SSL_SIZE}</span><br><span>else</span><br>    <span>echo</span> -e <span>"\033[32m ====&gt; 1. 生成新的 CA 私钥 <span>${CA_KEY}</span> \033[0m"</span><br>    openssl genrsa -out <span>${CA_KEY}</span> <span>${SSL_SIZE}</span><br><span>fi</span></p><p><span>if</span> [[-e ./<span>${CA_CERT}</span> ]]; <span>then</span><br>    <span>echo</span> -e <span>"\033[32m ====&gt; 2. 发现已存在 CA 证书，先备份 "</span><span>${CA_CERT}</span><span>" 为 "</span><span>${CA_CERT}</span><span>"-bak，然后重新创建 \033[0m"</span><br>    mv <span>${CA_CERT}</span> <span>"<span>${CA_CERT}</span>"</span>-bak<br>    openssl req -x509 -sha256 -new -nodes -key <span>${CA_KEY}</span> -days <span>${CA_DATE}</span> -out <span>${CA_CERT}</span> -subj <span>"/C=<span>${CN}</span>/CN=<span>${CA_DOMAIN}</span>"</span><br><span>else</span><br>    <span>echo</span> -e <span>"\033[32m ====&gt; 2. 生成新的 CA 证书 <span>${CA_CERT}</span> \033[0m"</span><br>    openssl req -x509 -sha256 -new -nodes -key <span>${CA_KEY}</span> -days <span>${CA_DATE}</span> -out <span>${CA_CERT}</span> -subj <span>"/C=<span>${CN}</span>/CN=<span>${CA_DOMAIN}</span>"</span><br><span>fi</span></p><p><span>echo</span> -e <span>"\033[32m ====&gt; 3. 生成 Openssl 配置文件 <span>${SSL_CONFIG}</span> \033[0m"</span><br>cat &gt; <span>${SSL_CONFIG}</span> &lt;&lt;<span>EOM</span><br><span>[req]</span><br><span>req_extensions = v3_req</span><br><span>distinguished_name = req_distinguished_name</span><br><span>[req_distinguished_name]</span><br><span>[v3_req]</span><br><span>basicConstraints = CA:FALSE</span><br><span>keyUsage = nonRepudiation, digitalSignature, keyEncipherment</span><br><span>extendedKeyUsage = clientAuth, serverAuth</span><br><span>EOM</span></p><p><span>if</span> [[-n <span>${SSL_TRUSTED_IP}</span> || -n <span>${SSL_TRUSTED_DOMAIN}</span> || -n <span>${SSL_DOMAIN}</span> ]]; <span>then</span><br>    cat &gt;&gt; <span>${SSL_CONFIG}</span> &lt;&lt;<span>EOM</span><br><span>subjectAltName = @alt_names</span><br><span>[alt_names]</span><br><span>EOM</span><br>    IFS=<span>","</span><br>    dns=(<span>${SSL_TRUSTED_DOMAIN}</span>)<br>    dns+=(<span>${SSL_DOMAIN}</span>)<br>    <span>for</span> i <span>in</span> <span>"<span>${!dns[@]}</span>"</span>; <span>do</span><br>      <span>echo</span> DNS.$((i+<span>1</span>)) = <span>${dns[$i]}</span> &gt;&gt; <span>${SSL_CONFIG}</span><br>    <span>done</span></p><p>    <span>if</span> [[-n <span>${SSL_TRUSTED_IP}</span> ]]; <span>then</span><br>        ip=(<span>${SSL_TRUSTED_IP}</span>)<br>        <span>for</span> i <span>in</span> <span>"<span>${!ip[@]}</span>"</span>; <span>do</span><br>          <span>echo</span> IP.$((i+<span>1</span>)) = <span>${ip[$i]}</span> &gt;&gt; <span>${SSL_CONFIG}</span><br>        <span>done</span><br>    <span>fi</span><br><span>fi</span></p><p><span>echo</span> -e <span>"\033[32m ====&gt; 4. 生成服务 SSL KEY <span>${SSL_KEY}</span> \033[0m"</span><br>openssl genrsa -out <span>${SSL_KEY}</span> <span>${SSL_SIZE}</span></p><p><span>echo</span> -e <span>"\033[32m ====&gt; 5. 生成服务 SSL CSR <span>${SSL_CSR}</span> \033[0m"</span><br>openssl req -sha256 -new -key <span>${SSL_KEY}</span> -out <span>${SSL_CSR}</span> -subj <span>"/C=<span>${CN}</span>/CN=<span>${SSL_DOMAIN}</span>"</span> -config <span>${SSL_CONFIG}</span></p><p><span>echo</span> -e <span>"\033[32m ====&gt; 6. 生成服务 SSL CERT <span>${SSL_CERT}</span> \033[0m"</span><br>openssl x509 -sha256 -req -<span>in</span> <span>${SSL_CSR}</span> -CA <span>${CA_CERT}</span> \<br>    -CAkey <span>${CA_KEY}</span> -CAcreateserial -out <span>${SSL_CERT}</span> \<br>    -days <span>${SSL_DATE}</span> -extensions v3_req \<br>    -extfile <span>${SSL_CONFIG}</span></p><p><span>echo</span> -e <span>"\033[32m ====&gt; 7. 证书制作完成 \033[0m"</span><br><span>echo</span><br><span>echo</span> -e <span>"\033[32m ====&gt; 8. 以 YAML 格式输出结果 \033[0m"</span><br><span>echo</span> <span>"----------------------------------------------------------"</span><br><span>echo</span> <span>"ca_key: |"</span><br>cat <span>$CA_KEY</span> | sed <span>'s/^/  /'</span><br><span>echo</span><br><span>echo</span> <span>"ca_cert: |"</span><br>cat <span>$CA_CERT</span> | sed <span>'s/^/  /'</span><br><span>echo</span><br><span>echo</span> <span>"ssl_key: |"</span><br>cat <span>$SSL_KEY</span> | sed <span>'s/^/  /'</span><br><span>echo</span><br><span>echo</span> <span>"ssl_csr: |"</span><br>cat <span>$SSL_CSR</span> | sed <span>'s/^/  /'</span><br><span>echo</span><br><span>echo</span> <span>"ssl_cert: |"</span><br>cat <span>$SSL_CERT</span> | sed <span>'s/^/  /'</span><br><span>echo</span></p><p><span>echo</span> -e <span>"\033[32m ====&gt; 9. 附加 CA 证书到 Cert 文件 \033[0m"</span><br>cat <span>${CA_CERT}</span> &gt;&gt; <span>${SSL_CERT}</span><br><span>echo</span> <span>"ssl_cert: |"</span><br>cat <span>$SSL_CERT</span> | sed <span>'s/^/  /'</span><br><span>echo</span></p><p><span>echo</span> -e <span>"\033[32m ====&gt; 10. 重命名服务证书 \033[0m"</span><br><span>echo</span> <span>"cp <span>${SSL_DOMAIN}</span>.key tls.key"</span><br>cp <span>${SSL_DOMAIN}</span>.key tls.key<br><span>echo</span> <span>"cp <span>${SSL_DOMAIN}</span>.crt tls.crt"</span><br>cp <span>${SSL_DOMAIN}</span>.crt tls.crt</p></code><p><i></i>BASH</p></pre></td></tr></tbody></table>

Rancher 默认使用 Github 上的 repo 作为 Chart 仓库的 URL，如果出现 timeout 情况，可以将 Chart 仓库 URL 替换成码云的地址。