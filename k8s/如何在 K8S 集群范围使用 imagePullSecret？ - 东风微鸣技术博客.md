åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å°†å‘ä½ å±•ç¤ºå¦‚ä½•åœ¨ Kubernetes ä¸­ä½¿ç”¨ imagePullSecretsã€‚

## imagePullSecrets ç®€ä»‹[](https://ewhisper.cn/posts/39547/#imagePullSecrets-%20%E7%AE%80%E4%BB%8B)

Kubernetes åœ¨æ¯ä¸ª Pod æˆ–æ¯ä¸ª Namespace çš„åŸºç¡€ä¸Šä½¿ç”¨ imagePullSecrets å¯¹ç§æœ‰å®¹å™¨æ³¨å†Œè¡¨è¿›è¡Œèº«ä»½éªŒè¯ã€‚è¦åšåˆ°è¿™ä¸€ç‚¹ï¼Œä½ éœ€è¦åˆ›å»ºä¸€ä¸ªç§˜å¯†ä¸å‡­æ®ï¼š

> âš ï¸ **è­¦å‘Š**ï¼š
> 
> ç°åœ¨éšç€å…¬å…±é•œåƒä»“åº“ï¼ˆå¦‚ï¼š[docker.io](http://docker.io/) ç­‰ï¼‰å¼€å§‹å¯¹åŒ¿åç”¨æˆ·è¿›è¡Œé™æµï¼Œé…ç½®å…¬å…±ä»“åº“çš„èº«ä»½è®¤è¯ä¹Ÿå˜å¾—æœ‰å¿…è¦ã€‚

<table><tbody><tr><td><pre><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br></pre></td><td><pre><code>kubectl create secret docker-registry image-pull-secret \<br>  -n &lt;your-namespace&gt; \<br>  --docker-server=&lt;your-registry-server&gt; \<br>  --docker-username=&lt;your-name&gt; \<br>  --docker-password=&lt;your-password&gt; \<br>  --docker-email=&lt;your-email&gt;<br>```  <p>ä¾‹å¦‚é…ç½® docker.io çš„ pull secretï¼š</p><p>```bash<br>kubectl create secret docker-registry image-pull-secret-src \<br>        -n imagepullsecret-patcher \<br>        --docker-server=docker.io \<br>        --docker-username=caseycui \<br>        --docker-password=c874d654-xxxx-40c6-xxxx-xxxxxxxx89c2 \<br>        --docker-email=cuikaidong@foxmail.com</p></code><p><i></i>BASH</p></pre></td></tr></tbody></table>

> â„¹ï¸ **ä¿¡æ¯**ï¼š
> 
> å¦‚æœ [docker.io](http://docker.io/) å¯ç”¨äº†ã€Œ2 é˜¶æ®µè®¤è¯ã€ï¼Œå¯èƒ½éœ€è¦åˆ›å»º Access Tokenï¼ˆå¯¹åº”ä¸Šé¢çš„ `docker-password`ï¼Œåˆ›å»ºé“¾æ¥åœ¨è¿™é‡Œï¼š[è´¦å· -> å®‰å…¨](https://hub.docker.com/settings/security)

ç°åœ¨æˆ‘ä»¬å¯ä»¥åœ¨ä¸€ä¸ª pod ä¸­ä½¿ç”¨è¿™ä¸ª secret æ¥ä¸‹è½½ docker é•œåƒï¼š

<table><tbody><tr><td><pre><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br></pre></td><td><pre><code><span>apiVersion:</span> <span>v1</span><br><span>kind:</span> <span>Pod</span><br><span>metadata:</span><br>  <span>name:</span> <span>busybox</span><br>  <span>namespace:</span> <span>private-registry-test</span><br><span>spec:</span><br>  <span>containers:</span><br>    <span>-</span> <span>name:</span> <span>my-app</span><br>      <span>image:</span> <span>my-private-registry.infra/busybox:v1</span><br>  <span>imagePullSecrets:</span><br>    <span>-</span> <span>name:</span> <span>image-pull-secret</span><br></code><p><i></i>YAML</p></pre></td></tr></tbody></table>

å¦ä¸€ç§æ–¹æ³•æ˜¯å°†å®ƒæ·»åŠ åˆ°å‘½åç©ºé—´çš„é»˜è®¤ ServiceAccount ä¸­ï¼š

<table><tbody><tr><td><pre><span>1</span><br><span>2</span><br><span>3</span><br></pre></td><td><pre><code>kubectl patch serviceaccount default \<br>  -p <span>"{\"imagePullSecrets\": [{\"name\": \"image-pull-secret\"}]}"</span> \<br>  -n &lt;your-namespace&gt;<br></code><p><i></i>BASH</p></pre></td></tr></tbody></table>

## åœ¨ K8S é›†ç¾¤èŒƒå›´ä½¿ç”¨ imagePullSecrets[](https://ewhisper.cn/posts/39547/#%E5%9C%A8%20-K8S-%20%E9%9B%86%E7%BE%A4%E8%8C%83%E5%9B%B4%E4%BD%BF%E7%94%A8%20-imagePullSecrets)

æˆ‘æ‰¾åˆ°äº†ä¸€ä¸ªå«åš [`imagepullsecret-patch`](https://github.com/titansoft-pte-ltd/imagepullsecret-patcher) çš„å·¥å…·ï¼Œå®ƒå¯ä»¥åœ¨ä½ æ‰€æœ‰çš„å‘½åç©ºé—´ä¸Šåšè¿™ä¸ªï¼š

<table><tbody><tr><td><pre><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br></pre></td><td><pre><code>wget https://raw.githubusercontent.com/titansoft-pte-ltd/imagepullsecret-patcher/185aec934bd01fa9b6ade2c44624e5f2023e2784/deploy-example/kubernetes-manifest/1_rbac.yaml<br>wget https://raw.githubusercontent.com/titansoft-pte-ltd/imagepullsecret-patcher/master/deploy-example/kubernetes-manifest/2_deployment.yaml<p>kubectl create ns imagepullsecret-patcher</p></code><p><i></i>BASH</p></pre></td></tr></tbody></table>

ç¼–è¾‘ä¸‹è½½çš„æ–‡ä»¶ï¼Œä¸€èˆ¬éœ€è¦ä¿®æ”¹ `image-pull-secret-src` çš„å†…å®¹ï¼Œè¿™ä¸ª pull secret å°±ä¼šåº”ç”¨åˆ° K8S é›†ç¾¤èŒƒå›´ã€‚

<table><tbody><tr><td><pre><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br></pre></td><td><pre><code>nano 1_rbac.yaml<br>nano 2_deployment.yaml<br>kubectl apply -f 1_rbac.yaml<br>kubectl apply -f 2_deployment.yaml<br></code><p><i></i>BASH</p></pre></td></tr></tbody></table>

è¿™é‡ŒèƒŒååˆ›å»ºçš„èµ„æºæœ‰ï¼š

1.  NameSpace
2.  RBAC æƒé™ç›¸å…³ï¼š
    1.  `imagepullsecret-patcher` ServiceAccount
    2.  `imagepullsecret-patcher` ClusterRoleï¼Œå…·æœ‰å¯¹ service account å’Œ secret çš„æ‰€æœ‰æƒé™
    3.  `imagepullsecret-patcher` ClusterRoleBindingï¼Œä¸º `imagepullsecret-patcher` ServiceAccount èµ‹äºˆ `imagepullsecret-patcher` ClusterRole çš„æƒé™ã€‚
3.  å…¨å±€ pull secret `image-pull-secret-src`ï¼Œé‡Œé¢æ˜¯ä½ çš„ K8S å…¨å±€åŒ…å«çš„æ‰€æœ‰çš„é•œåƒåº“åœ°å€å’Œè®¤è¯ä¿¡æ¯ã€‚
4.  Deployment `imagepullsecret-patcher`ï¼ŒæŒ‡å®š ServiceAccount æ˜¯ `imagepullsecret-patcher` å°±æœ‰äº†æ“ä½œ service account å’Œ secret çš„æ‰€æœ‰æƒé™ï¼Œå¹¶å°†ä¸Šé¢çš„ secret æŒ‚è½½åˆ° Deployment pod å†…ã€‚

å¯ä»¥åŒ…å«å¤šä¸ªé•œåƒåº“åœ°å€å’Œè®¤è¯ä¿¡æ¯ï¼Œå¦‚ï¼š

<table><tbody><tr><td><pre><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br></pre></td><td><pre><code><span>{</span><br>    <span>"auths"</span><span>:</span> <span>{</span><br>        <span>"docker.io"</span><span>:</span> <span>{</span><br>            <span>"username"</span><span>:</span> <span>"caseycui"</span><span>,</span><br>            <span>"password"</span><span>:</span> <span>"c874xxxxxxxxxxxxxxxx1f89c2"</span><span>,</span><br>            <span>"email"</span><span>:</span> <span>"cuikaidong@foxmail.com"</span><span>,</span><br>            <span>"auth"</span><span>:</span> <span>"Y2FzxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxWMy"</span><br>        <span>}</span><span>,</span><br>        <span>"quay.io"</span><span>:</span> <span>{</span><br>            <span>"auth"</span><span>:</span> <span>"ZWFzdxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxlXWmpNPQ=="</span><span>,</span><br>            <span>"email"</span><span>:</span> <span>""</span><br>        <span>}</span><br>    <span>}</span><br><span>}</span><br></code><p><i></i>JSON</p></pre></td></tr></tbody></table>

base64 ç¼–ç åå†™åˆ° secret çš„ `.dockerconfigjson` å­—æ®µå³å¯ï¼š

<table><tbody><tr><td><pre><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br></pre></td><td><pre><code><span>apiVersion:</span> <span>v1</span><br><span>kind:</span> <span>Secret</span><br><span>metadata:</span><br>  <span>name:</span> <span>image-pull-secret-src</span><br>  <span>namespace:</span> <span>imagepullsecret-patcher</span><br><span>data:</span><br>  <span>.dockerconfigjson:</span> <span>&gt;-</span><br><span>    eyJhdXRocyI6eyJkb2NrZXIuaW8iOnsidXNlcm5hbWUiOiJjYXNleWN1aSIsInB.............................................IiwiZW1haWwiOiIifX19</span><br><span></span><span>type:</span> <span>kubernetes.io/dockerconfigjson</span><br></code><p><i></i>YAML</p></pre></td></tr></tbody></table>

å¯åŠ¨åçš„ pod ä¼šåœ¨æ‰€æœ‰ NameSpace ä¸‹åˆ›å»º `image-pull-secret` secretï¼ˆå†…å®¹æ¥è‡ªäº`image-pull-secret-src`) å¹¶æŠŠå®ƒ patch åˆ° `default` service account åŠè¯¥ K8S é›†ç¾¤çš„æ‰€æœ‰ ServiceAccount é‡Œï¼Œæ—¥å¿—å¦‚ä¸‹ï¼š

<table><tbody><tr><td><pre><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br></pre></td><td><pre><code>time="2022-01-12T16:07:30Z" level=info msg="Application started"<br>time="2022-01-12T16:07:30Z" level=info msg="[default] Created secret"<br>time="2022-01-12T16:07:30Z" level=info msg="[default] Patched imagePullSecrets to service account [default]"<br>time="2022-01-12T16:07:30Z" level=info msg="[kube-system] Created secret"<br>time="2022-01-12T16:07:31Z" level=info msg="[kube-system] Patched imagePullSecrets to service account [node-controller]"<br>...<br>time="2022-01-12T16:07:37Z" level=info msg="[kube-public] Created secret"<br>time="2022-01-12T16:07:37Z" level=info msg="[kube-public] Patched imagePullSecrets to service account [default]"<br>time="2022-01-12T16:07:38Z" level=info msg="[kube-node-lease] Created secret"<br>time="2022-01-12T16:07:38Z" level=info msg="[kube-node-lease] Patched imagePullSecrets to service account [default]"<br>time="2022-01-12T16:07:38Z" level=info msg="[prometheus] Created secret"<br>time="2022-01-12T16:07:39Z" level=info msg="[prometheus] Patched imagePullSecrets to service account [default]"<br>...<br>time="2022-01-12T16:07:41Z" level=info msg="[imagepullsecret-patcher] Created secret"<br>time="2022-01-12T16:07:41Z" level=info msg="[imagepullsecret-patcher] Patched imagePullSecrets to service account [default]"<br>time="2022-01-12T16:07:41Z" level=info msg="[imagepullsecret-patcher] Patched imagePullSecrets to service account [imagepullsecret-patcher]"<br></code><p><i></i>LOG</p></pre></td></tr></tbody></table>

ä»Šåæˆ‘ä»¬åªéœ€è¦æ›´æ–° `image-pull-secret-src` è¿™ä¸€ä¸ªå³å¯äº†ã€‚ğŸ‘ï¸ğŸ‘ï¸ğŸ‘ï¸

## Kyverno policy[](https://ewhisper.cn/posts/39547/#Kyverno-policy)

[Kyverno](https://kyverno.io/) policy å¯ä»¥å®ç°åŒæ ·çš„æ•ˆæœ:

<table><tbody><tr><td><pre><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br><span>33</span><br><span>34</span><br><span>35</span><br><span>36</span><br><span>37</span><br><span>38</span><br><span>39</span><br></pre></td><td><pre><code><span>apiVersion:</span> <span>kyverno.io/v1</span><br><span>kind:</span> <span>ClusterPolicy</span><br><span>metadata:</span><br>  <span>name:</span> <span>sync-secret</span><br><span>spec:</span><br>  <span>background:</span> <span>false</span><br>  <span>rules:</span><br>  <span>-</span> <span>name:</span> <span>sync-image-pull-secret</span><br>    <span>match:</span><br>      <span>resources:</span><br>        <span>kinds:</span><br>        <span>-</span> <span>Namespace</span><br>    <span>generate:</span><br>      <span>kind:</span> <span>Secret</span><br>      <span>name:</span> <span>image-pull-secret</span><br>      <span>namespace:</span> <span>"<span>{{request.object.metadata.name}}</span>"</span><br>      <span>synchronize:</span> <span>true</span><br>      <span>clone:</span><br>        <span>namespace:</span> <span>default</span><br>        <span>name:</span> <span>image-pull-secret</span><br><span>---</span><br><span>apiVersion:</span> <span>kyverno.io/v1</span><br><span>kind:</span> <span>ClusterPolicy</span><br><span>metadata:</span><br>  <span>name:</span> <span>mutate-imagepullsecret</span><br><span>spec:</span><br>  <span>rules:</span><br>    <span>-</span> <span>name:</span> <span>mutate-imagepullsecret</span><br>      <span>match:</span><br>        <span>resources:</span><br>          <span>kinds:</span><br>          <span>-</span> <span>Pod</span><br>      <span>mutate:</span><br>        <span>patchStrategicMerge:</span><br>          <span>spec:</span><br>            <span>imagePullSecrets:</span><br>            <span>-</span> <span>name:</span> <span>image-pull-secret</span>  <span>## imagePullSecret that you created with docker hub pro account</span><br>            <span>(containers):</span><br>            <span>-</span> <span>(image):</span> <span>"*"</span> <span>## match all container images</span><br></code><p><i></i>YAML</p></pre></td></tr></tbody></table>